<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Midweek Golf Swindle Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        :root {
            /* Main background colors */
            --color-bg-primary: #0f172a;
            --color-bg-secondary: #1e293b;
            --color-bg-container: #334155;
            --color-bg-app: var(--color-bg-primary);
            --color-bg-sidebar: var(--color-bg-secondary);
            --color-bg-input: var(--color-bg-secondary);
            
            /* Text colors */
            --color-text-primary: #f1f5f9;
            --color-text-secondary: #cbd5e1;
            --color-text-muted: #94a3b8;
            
            /* Accent colors */
            --color-accent-primary: #0ea5e9;
            --color-accent-secondary: #0284c7;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-error: #ef4444;
            
            /* Button colors */
            --color-btn-primary: var(--color-accent-primary);
            --color-btn-primary-hover: var(--color-accent-secondary);
            --color-btn-success: var(--color-success);
            --color-btn-warning: var(--color-warning);
            --color-btn-danger: var(--color-error);
            --color-btn-purple: #8b5cf6;
            --color-btn-purple-hover: #7c3aed;
            --color-btn-orange: #f97316;
            
            /* Border and divider colors */
            --color-border: #475569;
            --color-border-light: #64748b;
            --color-divider: var(--color-border);
            
            /* Table colors */
            --color-table-header: var(--color-bg-container);
            --color-table-row-odd: var(--color-bg-container);
            --color-table-row-even: var(--color-bg-secondary);
            --color-table-hover: #3f4e63;
            --color-fixed-column-bg: var(--color-bg-container);
            
            /* Modal and overlay colors */
            --color-modal-backdrop: rgba(0, 0, 0, 0.8);
            --color-modal-bg: var(--color-bg-container);
            --color-shadow: rgba(0, 0, 0, 0.3);
            --color-shadow-heavy: rgba(0, 0, 0, 0.5);
            
            /* Header gradient colors */
            --color-header-start: var(--color-bg-secondary);
            --color-header-end: var(--color-bg-primary);
            
            /* Legacy compatibility (will be replaced gradually) */
            --color-accent-success: var(--color-success);
            --color-accent-danger: var(--color-error);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        }
        
        body {
            background-color: var(--color-bg-app);
            color: var(--color-text-primary);
            line-height: 1.4;
            padding: 0; 
            min-height: 100vh;
            font-size: 14px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: var(--color-bg-container);
            border-radius: 0; 
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        header {
            background: linear-gradient(135deg, var(--color-header-start), var(--color-header-end));
            color: var(--color-text-primary);
            padding: 15px 20px;
            text-align: center;
            flex-shrink: 0;
            position: relative;
            cursor: pointer;
            border-bottom: 2px solid var(--color-accent-primary);
        }
        
        h1 {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 2px;
        }
        
        .subtitle {
            font-size: 13px;
            opacity: 0.9;
        }
        
        .header-edit-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
            font-weight: 600;
        }
        
        .header-edit-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        /* --- CONTROLS BAR (Top) --- */
        .controls {
            display: flex;
            justify-content: space-between;
            padding: 6px 10px; 
            background: var(--color-bg-app);
            border-bottom: 1px solid var(--color-border);
            flex-wrap: wrap;
            gap: 6px; 
            flex-shrink: 0;
        }
        
        .player-controls, .week-controls, .data-controls {
            display: flex;
            gap: 2px; 
            align-items: center;
            flex-wrap: wrap; 
        }
        
        input, select, button {
            padding: 5px 8px; 
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-size: 12px;
            background-color: var(--color-bg-container);
            color: var(--color-text-primary);
            flex-shrink: 0;
        }
        
        input {
            width: 120px; 
            background-color: var(--color-bg-input);
        }

        select {
             width: 110px;
        }
        
        button {
            background: var(--color-btn-primary);
            color: var(--color-text-primary);
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            box-shadow: 0 1px 3px var(--color-shadow);
        }
        
        button:hover {
            background: var(--color-btn-primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 2px 5px var(--color-shadow);
        }
        
        .add-week-btn {
            background: var(--color-btn-success);
        }
        
        .backup-btn {
            background: var(--color-btn-purple);
        }
        
        .backup-btn:hover {
            background: var(--color-btn-purple-hover);
        }
        
        .import-btn {
            background: var(--color-btn-orange);
        }
        
        .capture-btn {
            background: var(--color-btn-success);
        }
        
        .theme-btn {
            background: var(--color-btn-purple);
        }
        
        .theme-btn:hover {
            background: var(--color-btn-purple-hover);
        }
        
        .btn {
            background: var(--color-btn-primary);
            color: var(--color-text-primary);
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
            box-shadow: 0 1px 3px var(--color-shadow);
            padding: 5px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .btn:hover {
            background: var(--color-btn-primary-hover);
            transform: translateY(-1px);
            box-shadow: 0 2px 5px var(--color-shadow);
        }

        .clear-btn, .delete-btn, .week-delete-btn {
            background: var(--color-accent-danger);
        }

        /* HIDES THE NATIVE FILE INPUT (THE WHITE THUMB) */
        #fileInput {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }
        
        /* Capture Modal Styles */
        .capture-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .capture-content {
            background: var(--color-bg-container);
            border-radius: 12px;
            padding: 20px;
            max-width: 600px;
            width: 100%;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            /* Remove max-height and overflow for full capture */
        }
        
        /* Compact layout for capture */
        .capture-modal.capturing .capture-content {
            max-width: 500px;
            padding: 15px;
            border-radius: 8px;
        }
        
        .capture-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: var(--color-text-secondary);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .capture-close:hover {
            color: var(--color-text-primary);
        }
        
        .capture-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--color-accent-primary);
        }
        
        .capture-title {
            font-size: 28px;
            color: var(--color-accent-primary);
            margin-bottom: 5px;
        }
        
        .capture-subtitle {
            font-size: 16px;
            color: var(--color-text-secondary);
        }
        
        .capture-week-info {
            background: var(--color-bg-app);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .capture-results-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 15px;
            font-size: 11px;
        }
        
        /* Compact table for capturing */
        .capture-modal.capturing .capture-results-table {
            font-size: 10px;
            margin-bottom: 10px;
        }
        
        .capture-modal.capturing .capture-results-table th,
        .capture-modal.capturing .capture-results-table td {
            padding: 6px 4px;
        }
        
        .capture-results-table th {
            background: var(--color-table-header);
            color: var(--color-text-primary);
            padding: 12px;
            text-align: left;
            font-weight: bold;
            border-bottom: 2px solid var(--color-border);
        }
        
        .capture-results-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--color-border);
            color: var(--color-text-primary);
        }
        
        .capture-results-table tr:nth-child(even) {
            background: var(--color-table-row-even);
        }
        
        .capture-results-table tr:nth-child(odd) {
            background: var(--color-table-row-odd);
        }
        
        .capture-position {
            font-weight: bold;
            color: var(--color-accent-primary);
            text-align: center;
        }
        
        .capture-prize {
            font-weight: bold;
            color: var(--color-accent-success);
            text-align: right;
        }
        
        .capture-score {
            text-align: center;
            font-weight: bold;
        }
        
        .capture-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 20px;
        }
        
        .capture-download-btn {
            background: var(--color-accent-primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.2s;
        }
        
        .capture-download-btn:hover {
            background: #3182ce;
        }

        /* --- TWO-COLUMN WRAPPER --- */
        .content-wrapper {
            display: flex;
            flex-grow: 1; 
            overflow: hidden; 
            border-top: 1px solid var(--color-border);
        }

        .main-table-area {
            flex-grow: 1; 
            min-width: 70%; 
            overflow-x: auto;
            display: flex;
            flex-direction: column;
            background-color: var(--color-bg-container);
        }

        .sidebar-area {
            width: 300px; 
            flex-shrink: 0;
            background: var(--color-bg-sidebar); 
            border-left: 2px solid var(--color-accent-primary);
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        /* --- SIDEBAR SECTIONS --- */
        .rules-section, .results-section {
            background: var(--color-bg-container); 
            border: 1px solid var(--color-border);
            border-radius: 6px;
            padding: 15px;
            color: var(--color-text-secondary);
            line-height: 1.5;
            flex-shrink: 0;
        }

        .rules-section {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .rules-section h2, .results-section h2 {
            font-size: 16px;
            font-weight: 700;
            color: var(--color-accent-primary);
            margin-bottom: 8px;
            border-bottom: 1px solid var(--color-border);
            padding-bottom: 4px;
        }

        /* Styles for Editable Rules Textarea */
        #rulesTextArea {
            flex-grow: 1; 
            width: 100%;
            height: auto; /* Allow growth */
            min-height: 200px; /* Minimum height */
            padding: 10px;
            border: 1px solid var(--color-border);
            border-radius: 4px;
            font-size: 12px;
            background-color: var(--color-bg-input); 
            color: var(--color-text-primary);
            resize: vertical; /* Allow manual vertical resize */
            line-height: 1.6;
            margin-top: 5px;
        }

        /* New Styles for Results Section */
        .results-section .result-item {
            display: grid;
            grid-template-columns: 40px 1fr 80px; /* Label (40px) | Player Name (1fr) | Money (80px) */
            align-items: center;
            gap: 5px; 
            margin-bottom: 8px;
        }

        /* New header for alignment */
        .results-section .result-header {
            display: grid;
            grid-template-columns: 40px 1fr 80px;
            gap: 5px;
            margin-bottom: 5px;
            font-size: 11px;
            color: var(--color-text-secondary);
            font-weight: 600;
            padding-left: 40px; /* Align with inputs */
        }
        
        .results-section .result-header .label-money {
            text-align: right;
        }


        .results-section label {
            font-weight: 600;
            color: var(--color-text-primary);
            width: 40px;
            flex-shrink: 0;
        }

        .results-section input {
            flex-grow: 1;
            background-color: var(--color-bg-input);
            border: 1px solid var(--color-border);
            padding: 6px 10px;
            font-size: 12px;
            border-radius: 4px;
        }

        .results-section .money-input {
            width: 100%;
            text-align: right;
            font-weight: 600;
            color: var(--color-success); /* Use green for money won */
            background-color: var(--color-bg-input);
        }
        
        /* --- TABLE STYLES --- */
        .table-wrapper {
            flex-grow: 1;
            overflow-y: auto; 
        }
        
        table {
            width: auto;
            min-width: 700px; 
            border-collapse: separate; 
            border-spacing: 0;
        }
        
        th, td {
            padding: 10px;
            text-align: left;
            font-size: 12px;
            vertical-align: middle;
            border-bottom: 1px solid var(--color-border);
            border-right: 1px solid var(--color-border);
            white-space: nowrap; 
        }

        tbody tr:nth-child(odd) {
            background-color: var(--color-table-row-odd);
        }
        
        tbody tr:nth-child(even) {
            background-color: var(--color-table-row-even);
        }
        
        /* Fixed column styles (essential for table usability) */
        .fixed-col, .fixed-col-2, .fixed-col-3 {
            position: sticky;
            z-index: 35;
            border-right: 2px solid var(--color-accent-primary);
            box-shadow: 2px 0 3px rgba(0, 0, 0, 0.1);
        }
        
        .fixed-col { left: 0px; min-width: 160px; max-width: 160px; background: var(--color-fixed-column-bg); }
        .fixed-col-2 { left: 160px; min-width: 120px; max-width: 120px; background: var(--color-fixed-column-bg); }
        .fixed-col-3 { left: 280px; min-width: 120px; max-width: 120px; background: var(--color-fixed-column-bg); border-right: 3px solid var(--color-accent-primary); }

        thead th { top: 0; z-index: 45; }

        tbody tr:nth-child(odd) .fixed-col, tbody tr:nth-child(odd) .fixed-col-2, tbody tr:nth-child(odd) .fixed-col-3 {
            background-color: var(--color-table-row-odd);
        }
        
        tbody tr:nth-child(even) .fixed-col, tbody tr:nth-child(even) .fixed-col-2, tbody tr:nth-child(even) .fixed-col-3 {
            background-color: var(--color-table-row-even);
        }
        
        .total-cell {
            font-weight: bold;
            background: #2a3340; 
            font-size: 12px;
            color: var(--color-accent-success);
        }
        
        .total-cell:nth-of-type(3) {
            color: var(--color-accent-primary);
        }

        /* PHC Input Styles */
        .phc-input {
            background-color: #0b2241 !important; 
            color: var(--color-accent-primary) !important;
            font-weight: 600 !important;
            border: 1px solid #0d1440 !important;
        }

        /* Media Queries for Responsiveness */
        /* Color Picker Styles */
        .color-picker {
            position: fixed;
            background: var(--color-bg-container);
            border: 2px solid var(--color-accent-primary);
            border-radius: 12px;
            padding: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            z-index: 9999;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 6px;
            width: 180px;
            backdrop-filter: blur(5px);
            transform: scale(0.9);
            opacity: 0;
            transition: all 0.2s ease;
        }
        
        .color-picker.show {
            transform: scale(1);
            opacity: 1;
        }
        
        .color-picker-title {
            grid-column: 1 / -1;
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: var(--color-accent-primary);
            margin-bottom: 4px;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--color-border);
        }
        
        .color-option {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.15s ease;
            position: relative;
        }
        
        .color-option:hover {
            transform: scale(1.05);
            border-color: var(--color-text-primary);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .color-option:active {
            transform: scale(0.95);
        }
        
        .no-fill-option {
            background: linear-gradient(135deg, #e53e3e 25%, transparent 25%, transparent 75%, #e53e3e 75%), 
                        linear-gradient(135deg, transparent 25%, #e53e3e 25%, #e53e3e 75%, transparent 75%);
            background-size: 6px 6px;
            background-position: 0 0, 3px 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: bold;
            color: var(--color-text-primary);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        
        /* Score input hover effect for color picker hint */
        .score-cell input {
            cursor: pointer;
        }
        
        .score-cell input:hover {
            border-color: var(--color-accent-primary);
            box-shadow: 0 0 0 2px rgba(66, 153, 225, 0.2);
        }
        
        /* Low score highlighting - Bold Red for scores 31 or less */
        .low-score {
            color: #FF0000 !important;
            font-weight: bold !important;
        }
        
        /* Sorting styles - Simple hover effect only */
        .sortable {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }
        
        .sortable:hover {
            background-color: var(--color-table-hover);
        }
        
        /* Tab Navigation Styles */
        .tab-navigation {
            display: flex;
            background: var(--color-bg-app);
            border-bottom: 2px solid var(--color-accent-primary);
            padding: 0 20px;
        }
        
        .tab-button {
            background: none;
            border: none;
            color: var(--color-text-secondary);
            padding: 15px 25px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
        }
        
        .tab-button:hover {
            color: var(--color-text-primary);
            background: rgba(66, 153, 225, 0.1);
        }
        
        .tab-button.active {
            color: var(--color-accent-primary);
            border-bottom-color: var(--color-accent-primary);
            background: rgba(66, 153, 225, 0.1);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Analytics Styles */
        .analytics-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .analytics-section {
            background: var(--color-bg-container);
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid var(--color-border);
        }
        
        .analytics-section h3 {
            color: var(--color-accent-primary);
            margin-bottom: 15px;
            font-size: 18px;
            border-bottom: 2px solid var(--color-accent-primary);
            padding-bottom: 8px;
        }
        
        .analytics-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        
        .analytics-table th,
        .analytics-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--color-border);
            font-size: 14px;
        }
        
        .analytics-table th {
            background: var(--color-table-header);
            color: var(--color-text-primary);
            font-weight: bold;
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: background-color 0.2s;
        }
        
        .analytics-table th .sort-indicator {
            color: #a0aec0;
            font-size: 11px;
            margin-left: 4px;
            opacity: 0.7;
            transition: all 0.2s;
        }
        
        .analytics-table th.sorted-asc .sort-indicator {
            color: var(--color-accent-primary);
            opacity: 1;
        }
        
        .analytics-table th.sorted-desc .sort-indicator {
            color: var(--color-accent-primary);
            opacity: 1;
        }
        
        .analytics-table th:hover {
            background: var(--color-table-hover);
        }
        
        .analytics-table tbody tr:nth-child(odd) {
            background: var(--color-table-row-odd);
        }
        
        .analytics-table tbody tr:nth-child(even) {
            background: var(--color-table-row-even);
        }
        
        .analytics-table tbody tr:hover {
            background: var(--color-table-hover);
        }
        
        .positive-value {
            color: var(--color-accent-success);
            font-weight: bold;
        }
        
        .negative-value {
            color: var(--color-accent-danger);
            font-weight: bold;
        }
        
        .neutral-value {
            color: var(--color-text-secondary);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: var(--color-bg-app);
            border-radius: 6px;
            padding: 15px;
            text-align: center;
            border: 1px solid var(--color-border);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: var(--color-accent-primary);
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-top: 5px;
        }
        
        .performance-graph {
            width: 100%;
            height: 400px;
            background: var(--color-bg-app);
            border-radius: 6px;
            border: 1px solid var(--color-border);
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .graph-content {
            position: relative;
            width: 100%;
            height: 100%;
        }
        
        .graph-line {
            stroke-width: 2;
            fill: none;
        }
        
        .graph-dot {
            r: 4;
            stroke-width: 2;
            stroke: var(--color-bg-container);
        }
        
        /* Theme Modal Styles */
        .theme-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .theme-content {
            background: var(--color-bg-container);
            border-radius: 12px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
        }
        
        .theme-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            color: var(--color-text-secondary);
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }
        
        .theme-close:hover {
            color: var(--color-text-primary);
            background: rgba(255, 255, 255, 0.1);
        }
        
        .theme-header {
            text-align: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--color-accent-primary);
        }
        
        .theme-title {
            font-size: 24px;
            color: var(--color-accent-primary);
            margin-bottom: 5px;
        }
        
        .theme-subtitle {
            font-size: 14px;
            color: var(--color-text-secondary);
        }
        
        .theme-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .theme-card {
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .theme-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .theme-card.active {
            border-color: #4299e1;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
        }
        
        .theme-name {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 8px;
            text-align: center;
        }
        
        .theme-preview {
            height: 60px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
            position: relative;
            overflow: hidden;
        }
        
        .theme-preview-text {
            font-size: 12px;
            font-weight: 600;
            z-index: 1;
        }
        
        .theme-colors {
            display: flex;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .theme-color {
            flex: 1;
            height: 100%;
        }
        
        /* Additional comprehensive theming rules */
        .analytics-container,
        .analytics-section,
        .stats-grid,
        .analytics-table {
            background-color: var(--color-bg-container) !important;
            color: var(--color-text-primary) !important;
        }
        
        .analytics-table th {
            background-color: var(--color-table-header) !important;
            color: var(--color-text-primary) !important;
            border-color: var(--color-border) !important;
        }
        
        .analytics-table td {
            color: var(--color-text-primary) !important;
            border-color: var(--color-border) !important;
        }
        
        .analytics-table tr:nth-child(even) {
            background-color: var(--color-table-row-even) !important;
        }
        
        .analytics-table tr:nth-child(odd) {
            background-color: var(--color-table-row-odd) !important;
        }
        
        /* Tab styling */
        .tab-buttons {
            background-color: var(--color-bg-container) !important;
            border-color: var(--color-border) !important;
        }
        
        .tab-button {
            background-color: var(--color-bg-secondary) !important;
            color: var(--color-text-secondary) !important;
            border-color: var(--color-border) !important;
        }
        
        .tab-button.active {
            background-color: var(--color-accent-primary) !important;
            color: var(--color-text-primary) !important;
        }
        
        /* Performance graph styling */
        #performanceSvg text {
            fill: var(--color-text-secondary) !important;
        }
        
        #performanceSvg line {
            stroke: var(--color-border) !important;
        }
        
        #performanceSvg rect {
            fill: var(--color-bg-container) !important;
            stroke: var(--color-border) !important;
        }
        
        /* Modal styling improvements */
        .capture-modal,
        .theme-modal {
            background-color: var(--color-modal-backdrop) !important;
        }
        
        .capture-content,
        .theme-content {
            background-color: var(--color-modal-bg) !important;
            box-shadow: 0 20px 40px var(--color-shadow-heavy) !important;
        }
        
        /* Status message styling */
        .data-status {
            color: var(--color-text-secondary) !important;
        }
        
        /* Empty state styling */
        .empty-state {
            color: var(--color-text-secondary) !important;
        }
        
        .empty-state h3 {
            color: var(--color-text-primary) !important;
        }
        
        /* SCORECARD TAB STYLES */
        .scorecard-container {
            padding: 20px;
            max-width: 100%;
            overflow-x: auto;
        }
        
        .scorecard-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
            background: var(--color-bg-container);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
        }
        
        .scorecard-table {
            border-collapse: separate;
            border-spacing: 0;
            width: 100%;
            min-width: 1200px;
            background: var(--color-bg-container);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 6px var(--color-shadow);
        }
        
        .scorecard-table th,
        .scorecard-table td {
            padding: 8px 4px;
            text-align: center;
            font-size: 11px;
            border-right: 1px solid var(--color-border);
            border-bottom: 1px solid var(--color-border);
            min-width: 45px; /* Wider to accommodate both scores */
            position: relative;
        }
        
        .scorecard-table th {
            background: var(--color-table-header);
            color: var(--color-text-primary);
            font-weight: bold;
            font-size: 10px;
        }
        
        .scorecard-table .hole-header {
            background: var(--color-accent-primary);
            color: var(--color-text-primary);
            font-weight: bold;
        }
        
        .scorecard-table .player-name {
            background: var(--color-bg-secondary);
            color: var(--color-text-primary);
            font-weight: bold;
            text-align: left;
            padding-left: 10px;
            min-width: 120px;
            position: sticky;
            left: 0;
            z-index: 10;
        }
        
        /* Player name container with remove button */
        .player-name-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
            min-height: 24px;
            width: 100%;
        }
        
        .player-name-text {
            flex: 1;
            font-weight: bold;
            text-align: left;
        }
        
        .remove-player-btn {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
            transition: all 0.2s ease;
            padding: 0;
            margin: 0;
            flex-shrink: 0;
        }
        
        .remove-player-btn:hover {
            background: #c82333;
            transform: scale(1.1);
        }
        
        .remove-player-btn:active {
            transform: scale(0.95);
        }
        
        .scorecard-table .totals-col {
            background: var(--color-accent-primary);
            color: var(--color-text-primary);
            font-weight: bold;
            min-width: 45px;
        }
        
        .scorecard-input {
            width: 30px;
            height: 30px;
            border: none;
            background: transparent;
            text-align: center;
            font-size: 11px;
            font-weight: bold;
            color: var(--color-text-primary);
            border-radius: 50%;
        }
        
        .scorecard-input:focus {
            outline: 2px solid var(--color-accent-primary);
            background: var(--color-bg-primary);
        }
        
        .editable-input {
            background: var(--color-bg-input);
            color: var(--color-text-primary);
            border: 1px solid var(--color-border);
            padding: 4px;
            border-radius: 4px;
            text-align: center;
            width: 30px;
            font-size: 10px;
        }
        
        /* Remove spinner arrows from number inputs */
        .scorecard-input::-webkit-outer-spin-button,
        .scorecard-input::-webkit-inner-spin-button,
        .gross-score-input::-webkit-outer-spin-button,
        .gross-score-input::-webkit-inner-spin-button,
        .inline-score-input::-webkit-outer-spin-button,
        .inline-score-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        .editable-input::-webkit-outer-spin-button,
        .editable-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Firefox */
        .scorecard-input[type=number],
        .gross-score-input[type=number],
        .editable-input[type=number],
        .inline-score-input[type=number] {
            -moz-appearance: textfield;
        }
        
        /* Focus styling for better navigation visibility */
        .scorecard-input:focus,
        .editable-input:focus {
            outline: 2px solid var(--color-accent-primary);
            outline-offset: 1px;
        }
        
        /* Dual score display container */
        .score-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
            width: 100%;
        }
        
        /* Gross score input (no special styling) */
        .gross-score-input {
            width: 35px;
            height: 20px;
            border: 1px solid var(--color-border);
            background: var(--color-bg-input);
            text-align: center;
            font-size: 11px;
            font-weight: bold;
            color: var(--color-text-primary);
            border-radius: 4px;
        }
        
        .gross-score-input:focus {
            outline: 2px solid var(--color-accent-primary);
            background: var(--color-bg-primary);
        }
        
        /* Stableford points display (color-coded circles) */
        .stableford-display {
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            font-weight: bold;
            font-size: 9px;
            margin-top: 2px;
        }
        
        /* Stableford point colors */
        .stbl-0 { background: green; color: white; } /* 0 points - Double bogey or worse */
        .stbl-1 { background: blue; color: white; } /* 1 point - Bogey */
        .stbl-2 { background: white; color: black; } /* 2 points - Par */
        .stbl-3 { background: red; color: white; } /* 3 points - Birdie */
        .stbl-4 { background: purple; color: white; } /* 4+ points - Eagle or better */
        .stbl-nr { background: yellow; color: black; } /* No score entered */
        
        /* Gross score display (white circles) */
        .gross-score-display {
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            font-weight: bold;
            font-size: 10px;
            background: white;
            color: black;
            border: 1px solid #ccc;
            margin-top: 2px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .gross-score-display:hover {
            background: #f0f0f0;
            border-color: #888;
            transform: scale(1.05);
        }
        
        .gross-score-display.empty {
            background: #f8f9fa;
            color: #6c757d;
        }
        
        .gross-score-display.empty:hover {
            background: #e9ecef;
        }
        
        .front-nine, .back-nine {
            border-left: 3px solid var(--color-accent-primary);
        }
        
        .add-player-section {
            margin-bottom: 20px;
        }
        
        .course-setup,
        .scorecard-key {
            background: var(--color-bg-secondary);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--color-border);
        }
        
        .course-setup h3,
        .scorecard-key h3 {
            color: var(--color-accent-primary);
            margin-bottom: 10px;
        }
        
        .course-inputs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .course-inputs label {
            font-size: 10px;
            color: var(--color-text-secondary);
        }
        
        /* Scoring Key Styles */
        .key-content {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .key-section {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .key-section strong {
            color: var(--color-text-primary);
            font-size: 11px;
            min-width: 80px;
        }
        
        .stableford-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .key-item-inline {
            display: flex;
            align-items: center;
            gap: 3px;
        }
        
        .key-item-inline span {
            color: var(--color-text-secondary);
            font-size: 9px;
            font-weight: 500;
        }
        
        .key-section .gross-score-display,
        .key-section .stableford-display {
            flex-shrink: 0;
        }
        
        .key-section span {
            color: var(--color-text-secondary);
            font-size: 10px;
        }
        
        /* Make key examples non-clickable and visually distinct */
        .key-example {
            cursor: default !important;
            opacity: 0.8;
        }
        
        .key-example:hover {
            background: white !important;
            transform: none !important;
        }

        @media (max-width: 1000px) {
            /* Switch to single column stack on small screens */
            .content-wrapper {
                flex-direction: column;
            }

            .main-table-area {
                min-width: 100%;
                overflow-x: auto; /* Table can scroll horizontally */
            }

            .sidebar-area {
                width: 100%;
                border-left: none;
                border-top: 2px solid var(--color-accent-primary);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header id="mainHeader">
            <button class="header-edit-btn" title="Edit Header">Edit</button>
            <h1 id="mainTitle">Midweek Golf Swindle Tracker</h1>
            <p class="subtitle" id="mainSubtitle">Track player investments, scores, and prize money with ease</p>
            
            <div class="header-edit-form" id="headerEditForm" style="display: none;">
                <input type="text" id="headerTitleInput" placeholder="Main Title">
                <input type="text" id="headerSubtitleInput" placeholder="Subtitle">
                <div class="header-edit-buttons">
                    <button class="save-header-btn" id="saveHeaderBtn">Save</button>
                    <button class="cancel-header-btn" id="cancelHeaderBtn">Cancel</button>
                </div>
            </div>
        </header>
        
        <!-- Tab Navigation -->
        <div class="tab-navigation">
            <button class="tab-button active" onclick="switchTab('tracker')">📊 Tracker</button>
            <button class="tab-button" onclick="switchTab('analytics')">📈 Analytics</button>
            <button class="tab-button" onclick="switchTab('scorecard')">⛳ Scorecard</button>
        </div>
        
        <!-- Tracker Tab Content -->
        <div id="tracker-tab" class="tab-content active">
        <div class="controls">
            <div class="player-controls">
                <input type="text" id="playerName" placeholder="Player Name">
                <input type="text" id="playerPHC" placeholder="PHC" maxlength="10" class="phc-input">
                <button id="addPlayer">Add Player</button>
            </div>
            
            <div class="week-controls">
                <select id="weekSelector" title="Jump to Week">
                    <option value="">Jump to Week...</option>
                </select>
                <button id="addWeek" class="add-week-btn">Add New Week</button>
            </div>
            
            <div class="data-controls">
                <button id="themeSelector" class="theme-btn" title="Change Theme">🎨 Themes</button>
                <button id="captureWeek" class="capture-btn" title="Capture current week image">📸 Capture Week</button>
                <button id="capturePHC" class="capture-btn" title="Capture Players PHC Information">📋 Capture PHC</button>
                <button id="captureSummary" class="capture-btn" title="Capture complete weekly summary">📁 Full Summary</button>
                <button id="backupData" class="backup-btn">Backup</button>
                <button id="importData" class="import-btn">Import</button>
                <button id="clearData" class="clear-btn">Clear All</button>
                <input type="file" id="fileInput" accept=".json">
                <div id="dataStatus" class="data-status"></div>
            </div>
        </div>
        
        <div class="content-wrapper">
            
            <div class="main-table-area">
                <div class="table-wrapper">
                    <table id="trackerTable">
                        <thead>
                            <tr>
                                <th class="fixed-col sortable" data-sort="name" rowspan="2">Players Name <span id="sort-name" style="color:#a0aec0;font-size:11px;margin-left:4px;opacity:0.7;">↕</span></th>
                                <th class="fixed-col-2 sortable" data-sort="invested" rowspan="2">Invested Total <span id="sort-invested" style="color:#a0aec0;font-size:11px;margin-left:4px;opacity:0.7;">↕</span></th>
                                <th class="fixed-col-3 sortable" data-sort="prize" rowspan="2">Prize Total <span id="sort-prize" style="color:#a0aec0;font-size:11px;margin-left:4px;opacity:0.7;">↕</span></th>
                            </tr>
                            <tr id="weekSubHeaderRow">
                                </tr>
                        </thead>
                        <tbody id="tableBody">
                        </tbody>
                    </table>
                    <div id="emptyState" class="empty-state">
                        <h3>No players or weeks added yet</h3>
                        <p>Use the fields above to add your first player and a new week, then use the **Jump to Week** dropdown to select a week to view.</p>
                    </div>
                </div>
            </div>

            <div class="sidebar-area">
                
                <div class="results-section">
                    <h2>Results</h2>
                    
                    <div class="result-header">
                        <div></div> <div class="label-name">Player</div>
                        <div class="label-money">Won</div>
                    </div>
                    
                    <div class="result-item">
                        <label for="firstPlaceInput">1st</label>
                        <input type="text" id="firstPlaceInput" placeholder="Player Name">
                        <input type="number" id="firstPlaceMoneyInput" placeholder="0.00" step="0.01" min="0" class="money-input">
                    </div>
                    
                    <div class="result-item">
                        <label for="secondPlaceInput">2nd</label>
                        <input type="text" id="secondPlaceInput" placeholder="Player Name">
                        <input type="number" id="secondPlaceMoneyInput" placeholder="0.00" step="0.01" min="0" class="money-input">
                    </div>
                    
                    <div class="result-item">
                        <label for="thirdPlaceInput">3rd</label>
                        <input type="text" id="thirdPlaceInput" placeholder="Player Name">
                        <input type="number" id="thirdPlaceMoneyInput" placeholder="0.00" step="0.01" min="0" class="money-input">
                    </div>
                    
                    <div class="result-item">
                        <label for="fourthPlaceInput">4th</label>
                        <input type="text" id="fourthPlaceInput" placeholder="Player Name">
                        <input type="number" id="fourthPlaceMoneyInput" placeholder="0.00" step="0.01" min="0" class="money-input">
                    </div>
                    
                    <div style="margin-top: 15px; display: flex; gap: 8px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="saveWeeklyResults()" class="btn" style="font-size: 11px; padding: 6px 10px;">💾 Save Week</button>
                        <button onclick="reconstructHistoricalResults()" class="btn" style="font-size: 11px; padding: 6px 10px;" title="Rebuild historical data from all weeks">🔄 Rebuild History</button>
                        <button onclick="clearWeeklyResultsHistory()" class="btn clear-btn" style="font-size: 11px; padding: 6px 10px;" title="Clear all historical weekly results for fresh start">🗑️ Clear History</button>
                    </div>
                </div>

                <div class="rules-section">
                    <h2>Swindle Rules</h2>
                    <textarea id="rulesTextArea" placeholder="Enter your official swindle rules here. This text is saved automatically with your data.

Example:
- Entry Fee: £5 per player, per week.
- Prize Distribution: 1st place (50%), 2nd place (30%), Best PHC Change (20%).
- PHC adjustment max: 2.0 increase/decrease per week."></textarea>
                </div>
            </div>
        </div>
        </div>
        <!-- End Tracker Tab -->
        
        <!-- Analytics Tab Content -->
        <div id="analytics-tab" class="tab-content">
            <div class="analytics-container">
                
                <!-- Summary Stats -->
                <div class="analytics-section">
                    <h3>📊 Summary Statistics</h3>
                    <div class="stats-grid" id="summaryStats">
                        <!-- Statistics will be populated by JavaScript -->
                    </div>
                </div>
                
                <!-- Position Wins Analysis -->
                <div class="analytics-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">🏆 Position Wins Analysis</h3>
                        <button onclick="captureAnalyticsSection('positionWinsSection')" class="capture-btn" style="font-size: 12px; padding: 8px 15px;" title="Capture Position Wins Analysis">📷 Capture</button>
                    </div>
                    <div id="positionWinsSection">
                    <table class="analytics-table" id="positionWinsTable">
                        <thead>
                            <tr>
                                <th onclick="sortAnalyticsTable('positionWinsTable', 0)">Player <span class="sort-indicator">↕</span></th>
                                <th onclick="sortAnalyticsTable('positionWinsTable', 1)">1st Place <span class="sort-indicator">↕</span></th>
                                <th onclick="sortAnalyticsTable('positionWinsTable', 2)">2nd Place <span class="sort-indicator">↕</span></th>
                                <th onclick="sortAnalyticsTable('positionWinsTable', 3)">3rd Place <span class="sort-indicator">↕</span></th>
                                <th onclick="sortAnalyticsTable('positionWinsTable', 4)">4th Place <span class="sort-indicator">↕</span></th>
                                <th onclick="sortAnalyticsTable('positionWinsTable', 5)">Total Wins <span class="sort-indicator">↕</span></th>
                                <th onclick="sortAnalyticsTable('positionWinsTable', 6)">Total Money <span class="sort-indicator">↕</span></th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Position wins data will be populated by JavaScript -->
                        </tbody>
                    </table>
                    </div>
                </div>
                
                <!-- Week Performance Tracking -->
                <div class="analytics-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">🗺 Week Performance Tracking</h3>
                        <button onclick="captureAnalyticsSection('weekPerformanceSection')" class="capture-btn" style="font-size: 12px; padding: 8px 15px;" title="Capture Week Performance Tracking">📷 Capture</button>
                    </div>
                    <div id="weekPerformanceSection">
                    <table class="analytics-table" id="weekPerformanceTable">
                        <thead>
                            <tr>
                                <th onclick="sortAnalyticsTable('weekPerformanceTable', 0)">Player <span class="sort-indicator">↕</span></th>
                                <th onclick="sortAnalyticsTable('weekPerformanceTable', 1)">Dates Won <span class="sort-indicator">↕</span></th>
                                <th onclick="sortAnalyticsTable('weekPerformanceTable', 2)">Best Performance <span class="sort-indicator">↕</span></th>
                                <th onclick="sortAnalyticsTable('weekPerformanceTable', 3)">Win Rate % <span class="sort-indicator">↕</span></th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Week performance data will be populated by JavaScript -->
                        </tbody>
                    </table>
                    </div>
                </div>
                
                <!-- Investment vs Prize Analysis -->
                <div class="analytics-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0;">💰 Financial Analysis</h3>
                        <button onclick="captureAnalyticsSection('financialSection')" class="capture-btn" style="font-size: 12px; padding: 8px 15px;" title="Capture Financial Analysis">📷 Capture</button>
                    </div>
                    <div id="financialSection">
                    <table class="analytics-table" id="financialTable">
                        <thead>
                            <tr>
                                <th onclick="sortAnalyticsTable('financialTable', 0)">Player <span class="sort-indicator">↕</span></th>
                                <th onclick="sortAnalyticsTable('financialTable', 1)">Total Invested <span class="sort-indicator">↕</span></th>
                                <th onclick="sortAnalyticsTable('financialTable', 2)">Total Prizes <span class="sort-indicator">↕</span></th>
                                <th onclick="sortAnalyticsTable('financialTable', 3)">P&L <span class="sort-indicator">↕</span></th>
                                <th onclick="sortAnalyticsTable('financialTable', 4)">ROI % <span class="sort-indicator">↕</span></th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Financial data will be populated by JavaScript -->
                        </tbody>
                    </table>
                    </div>
                </div>
                
                <!-- Performance Graph -->
                <div class="analytics-section">
                    <h3>📈 Performance Trends</h3>
                    <div class="performance-graph" id="performanceGraph">
                        <svg width="100%" height="100%" id="performanceSvg">
                            <!-- Graph will be drawn by JavaScript -->
                        </svg>
                    </div>
                </div>
                
            </div>
        </div>
        <!-- End Analytics Tab -->
        
        <!-- SCORECARD Tab Content -->
        <div id="scorecard-tab" class="tab-content">
            <div class="scorecard-container">
                
                <!-- Course Setup and Color Key Section -->
                <div style="display: flex; gap: 20px; flex-wrap: wrap;">
                    <div class="course-setup" style="flex: 1; min-width: 300px;">
                        <h3>⛳ Course Setup</h3>
                        <div class="course-inputs">
                            <div>
                                <label>Course Name:</label>
                                <input type="text" id="courseName" placeholder="Course Name" style="width: 200px;">
                            </div>
                            <div>
                                <label>Date:</label>
                                <input type="date" id="scoreCardDate">
                            </div>
                            <button onclick="resetCourseDefaults()" class="btn">Reset to Defaults</button>
                            <button id="saveCourseBtn" class="btn">Save Course</button>
                        </div>
                    </div>
                    
                    <div class="scorecard-key" style="flex: 1; min-width: 300px;">
                        <h3>🔑 Scoring Key</h3>
                        <div class="key-content">
                            <div class="key-section">
                                <strong>Stableford:</strong> 
                                <div class="stableford-row">
                                    <div class="key-item-inline">
                                        <div class="stableford-display stbl-4 key-example">4</div><span>Eagle+</span>
                                    </div>
                                    <div class="key-item-inline">
                                        <div class="stableford-display stbl-3 key-example">3</div><span>Birdie</span>
                                    </div>
                                    <div class="key-item-inline">
                                        <div class="stableford-display stbl-2 key-example">2</div><span>Par</span>
                                    </div>
                                    <div class="key-item-inline">
                                        <div class="stableford-display stbl-1 key-example">1</div><span>Bogey</span>
                                    </div>
                                    <div class="key-item-inline">
                                        <div class="stableford-display stbl-0 key-example">0</div><span>Double+</span>
                                    </div>
                                    <div class="key-item-inline">
                                        <div class="stableford-display stbl-nr key-example">NR</div><span>No Return</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Player Management -->
                <div class="scorecard-controls">
                    <div class="add-player-section">
                        <input type="text" id="scorecardPlayerName" placeholder="Player Name">
                        <input type="text" id="scorecardPlayerPHC" placeholder="PHC" style="width: 60px;">
                        <button onclick="addScorecardPlayer()" class="btn">Add Player</button>
                        <button onclick="clearAllScores()" class="btn clear-btn">Clear All Scores</button>
                        <button onclick="captureScorecardImage()" class="capture-btn">📷 Capture Scorecard</button>
                    </div>
                </div>
                
                <!-- Scorecard Table -->
                <div class="scorecard-table-wrapper" style="overflow-x: auto;">
                    <table class="scorecard-table" id="scorecardTable">
                        <!-- Table will be populated by JavaScript -->
                    </table>
                </div>
                
            </div>
        </div>
        <!-- End SCORECARD Tab -->
        
    </div>
    
    <!-- Theme Modal -->
    <div id="themeModal" class="theme-modal">
        <div class="theme-content">
            <button class="theme-close" onclick="closeThemeModal()">&times;</button>
            <div class="theme-header">
                <div class="theme-title">🎨 Choose Theme</div>
                <div class="theme-subtitle">Select a color scheme for your Golf Swindle tracker</div>
            </div>
            <div class="theme-grid" id="themeGrid">
                <!-- Theme options will be populated by JavaScript -->
            </div>
        </div>
    </div>
</body>
    <div id="colorPicker" class="color-picker" style="display: none;"></div>
    
    <!-- Capture Modal -->
    <div id="captureModal" class="capture-modal">
        <div class="capture-content">
            <button class="capture-close" onclick="closeCaptureModal()">&times;</button>
            <div class="capture-header">
                <h2 class="capture-title">🏌️ Mid-Week Golf Swindle</h2>
                <p class="capture-subtitle">Weekly Results</p>
            </div>
            <div id="captureWeekInfo" class="capture-week-info"></div>
            <div id="captureTableContainer"></div>
            <div id="captureResultsContainer"></div>
            <div class="capture-actions">
                <button class="capture-download-btn" onclick="downloadCaptureImage()">💾 Download Image</button>
                <button class="capture-download-btn" onclick="closeCaptureModal()">❌ Close</button>
            </div>
        </div>
    </div>
    
    <!-- PHC Capture Modal -->
    <div id="phcCaptureModal" class="capture-modal">
        <div class="capture-content">
            <button class="capture-close" onclick="closePHCCaptureModal()">&times;</button>
            <div class="capture-header">
                <h2 class="capture-title">📋 Players PHC Information</h2>
                <p class="capture-subtitle">Alphabetical List</p>
            </div>
            <div id="phcCaptureContent"></div>
            <div class="capture-actions">
                <button class="capture-download-btn" onclick="downloadPHCImage()">📷 Download Image</button>
                <button class="capture-download-btn" onclick="closePHCCaptureModal()">❌ Close</button>
            </div>
        </div>
    </div>
    
    <!-- Hidden Capture Area for Clean Image Generation -->
    <div id="hiddenCaptureArea" style="position: absolute; left: -9999px; top: 0; background: #2d3748; padding: 20px; border-radius: 8px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
        <!-- Content will be populated by JavaScript -->
    </div>

    <script>
        // Data storage variables
        let trackerData = {
            players: [],
            weeks: [],
            version: '1.0',
            header: {
                title: "Midweek Golf Swindle Tracker",
                subtitle: "Track player investments, scores, and prize money with ease"
            },
            // New field for rules text
            rulesText: '',
            // New field for results, including money won
            results: {
                firstPlace: '', firstPlaceMoney: '',
                secondPlace: '', secondPlaceMoney: '',
                thirdPlace: '', thirdPlaceMoney: '',
                fourthPlace: '', fourthPlaceMoney: ''
            },
            // Historical weekly results for analytics
            weeklyResults: []
        };
        
        // State variable for single-week view
        let currentVisibleWeekIndex = -1; 

        // Sorting variables
        let currentSort = {
            column: null,
            direction: 'asc' // 'asc' or 'desc'
        };
        
        // Color picker variables and setup (omitted for brevity, assume correct CSS/HTML exists)
        let currentScoreInput = null;
        const colorPicker = document.getElementById('colorPicker');
        const colors = [
            '#4299e1', '#48bb78', '#f6e05e', '#ed8936', '#e53e3e', '#805ad5',
            '#a0aec0', '#4a5568', '#fbd38d', '#f6ad55', '#feb2b2', '#c53030'
        ];
        
        // Initialize color picker
        function initColorPicker() {
            const picker = document.getElementById('colorPicker');
            picker.innerHTML = ''; // Clear previous content
            
            // Add title
            const title = document.createElement('div');
            title.className = 'color-picker-title';
            title.textContent = 'Score Color';
            picker.appendChild(title);
            
            // Add color options
            colors.forEach(color => {
                const colorOption = document.createElement('div');
                colorOption.className = 'color-option';
                colorOption.style.backgroundColor = color;
                colorOption.title = `Apply ${color} color`;
                colorOption.addEventListener('click', function() {
                    if (currentScoreInput) {
                        currentScoreInput.style.backgroundColor = color;
                        const playerId = currentScoreInput.closest('tr').dataset.playerId;
                        const weekIndex = currentVisibleWeekIndex;
                        const player = trackerData.players.find(p => p.id === playerId);
                        if (player && player.weeks[weekIndex]) {
                            player.weeks[weekIndex].scoreColor = color;
                            saveDataToStorage();
                        }
                    }
                    hideColorPicker();
                });
                picker.appendChild(colorOption);
            });
            
            // Add "None" option
            const noFillOption = document.createElement('div');
            noFillOption.className = 'color-option no-fill-option';
            noFillOption.textContent = 'None';
            noFillOption.title = 'Remove color';
            noFillOption.addEventListener('click', function() {
                if (currentScoreInput) {
                    currentScoreInput.style.backgroundColor = '';
                    const playerId = currentScoreInput.closest('tr').dataset.playerId;
                    const weekIndex = currentVisibleWeekIndex;
                    const player = trackerData.players.find(p => p.id === playerId);
                    if (player && player.weeks[weekIndex]) {
                        player.weeks[weekIndex].scoreColor = '';
                        saveDataToStorage();
                    }
                }
                hideColorPicker();
            });
            picker.appendChild(noFillOption);
            
            // Close picker when clicking outside
            document.addEventListener('click', function(e) {
                if (picker.classList.contains('show') && !picker.contains(e.target) && e.target !== currentScoreInput) {
                    hideColorPicker();
                }
            });
        }
        
        function showColorPicker(inputElement) {
            const picker = document.getElementById('colorPicker');
            const rect = inputElement.getBoundingClientRect();
            
            // Position the picker near the input but ensure it stays within viewport
            let left = rect.left + (rect.width / 2) - 90; // Center horizontally on input
            let top = rect.bottom + 8; // 8px below the input
            
            // Adjust if picker would go off screen
            const pickerWidth = 180;
            const pickerHeight = 200; // Approximate height
            
            if (left + pickerWidth > window.innerWidth) {
                left = window.innerWidth - pickerWidth - 10;
            }
            if (left < 10) {
                left = 10;
            }
            if (top + pickerHeight > window.innerHeight) {
                top = rect.top - pickerHeight - 8; // Show above input instead
            }
            
            picker.style.left = left + 'px';
            picker.style.top = top + 'px';
            picker.style.display = 'grid';
            
            // Trigger animation
            requestAnimationFrame(() => {
                picker.classList.add('show');
            });
        }
        
        function hideColorPicker() {
            const picker = document.getElementById('colorPicker');
            picker.classList.remove('show');
            setTimeout(() => {
                if (!picker.classList.contains('show')) {
                    picker.style.display = 'none';
                }
            }, 200);
        }
        
        // Function to update score styling (kept as is)
        function updateScoreStyling(scoreInput) {
            const scoreValue = parseFloat(scoreInput.value);
            scoreInput.classList.remove('low-score');
            if (!isNaN(scoreValue) && scoreValue <= 31) {
                scoreInput.classList.add('low-score');
            }
        }
        
        // Header editing functions (kept as is)
        function initHeaderEditing() {
            const header = document.getElementById('mainHeader');
            const editBtn = document.querySelector('.header-edit-btn');
            const editForm = document.getElementById('headerEditForm');
            const titleInput = document.getElementById('headerTitleInput');
            const subtitleInput = document.getElementById('headerSubtitleInput');
            const saveBtn = document.getElementById('saveHeaderBtn');
            const cancelBtn = document.getElementById('cancelHeaderBtn');
            
            if (trackerData.header) {
                document.getElementById('mainTitle').textContent = trackerData.header.title;
                document.getElementById('mainSubtitle').textContent = trackerData.header.subtitle;
            }
            
            editBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                header.classList.add('editing');
                editForm.style.display = 'block';
                titleInput.value = document.getElementById('mainTitle').textContent;
                subtitleInput.value = document.getElementById('mainSubtitle').textContent;
                titleInput.focus();
            });
            
            saveBtn.addEventListener('click', function() {
                const newTitle = titleInput.value.trim() || "Midweek Golf Swindle Tracker";
                const newSubtitle = subtitleInput.value.trim() || "Track player investments, scores, and prize money with ease";
                
                document.getElementById('mainTitle').textContent = newTitle;
                document.getElementById('mainSubtitle').textContent = newSubtitle;
                
                trackerData.header = { title: newTitle, subtitle: newSubtitle };
                saveDataToStorage();
                
                editForm.style.display = 'none';
                header.classList.remove('editing');
            });
            
            cancelBtn.addEventListener('click', function() {
                editForm.style.display = 'none';
                header.classList.remove('editing');
            });
            
            document.addEventListener('click', function(e) {
                if (editForm.style.display === 'block' && !editForm.contains(e.target) && e.target !== editBtn) {
                    editForm.style.display = 'none';
                    header.classList.remove('editing');
                }
            });
            
            [titleInput, subtitleInput].forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') saveBtn.click();
                });
            });
        }
        
        // Sorting functions (kept as is)
        function initSorting() {
            const sortableHeaders = document.querySelectorAll('.sortable');
            console.log('Found sortable headers:', sortableHeaders.length);
            sortableHeaders.forEach((header, index) => {
                console.log(`Header ${index}:`, header.textContent, 'data-sort:', header.getAttribute('data-sort'));
                header.addEventListener('click', function() {
                    console.log('Header clicked:', this.textContent, 'data-sort:', this.getAttribute('data-sort'));
                    sortTable(this.getAttribute('data-sort'));
                });
            });
        }
        
        function sortTable(column) {
            console.log('sortTable called with column:', column);
            const tbody = document.getElementById('tableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            console.log('Found rows:', rows.length);
            if (rows.length === 0) {
                console.log('No rows to sort, returning');
                return;
            }
            
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            // Update header text with sort indicators
            updateSortHeaders(column, currentSort.direction);
            
            rows.sort((a, b) => {
                const aValue = getSortValue(a, column);
                const bValue = getSortValue(b, column);
                
                let result = 0;
                
                if (typeof aValue === 'string' && typeof bValue === 'string') {
                    result = aValue.localeCompare(bValue);
                } else {
                    result = (aValue < bValue) ? -1 : (aValue > bValue) ? 1 : 0;
                }
                
                return currentSort.direction === 'asc' ? result : -result;
            });
            
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
            
            // Show sorting feedback
            const columnNames = {
                'name': 'Player Name',
                'invested': 'Invested Total', 
                'prize': 'Prize Total',
                'week-phc': 'Week PHC',
                'week-invested': 'Week Invested',
                'week-score': 'Week Score',
                'week-prize': 'Week Prize'
            };
            const directionText = currentSort.direction === 'asc' ? 'ascending' : 'descending';
            showStatusMessage(`Sorted by ${columnNames[column]} (${directionText})`, 'success');
        }
        
        function updateSortHeaders(activeColumn, direction) {
            console.log('Updating sort headers:', activeColumn, direction);
            
            // Reset all sort indicators to default state
            ['sort-name', 'sort-invested', 'sort-prize', 'sort-week-phc', 'sort-week-invested', 'sort-week-score', 'sort-week-prize'].forEach(id => {
                const span = document.getElementById(id);
                if (span) {
                    span.innerHTML = '↕';
                    span.style.color = '#a0aec0';
                    span.style.opacity = '0.7';
                }
            });
            
            // Update the active column indicator
            const activeSpan = document.getElementById(`sort-${activeColumn}`);
            if (activeSpan) {
                const indicator = direction === 'asc' ? '↑' : '↓';
                activeSpan.innerHTML = indicator;
                activeSpan.style.color = '#4299e1';
                activeSpan.style.opacity = '1';
                console.log('Updated span for', activeColumn, 'to', indicator);
            }
        }
        
        function getSortValue(row, column) {
            const cells = row.querySelectorAll('td');
            
            switch(column) {
                case 'name':
                    const nameElement = cells[0] && cells[0].querySelector('.player-name-text');
                    return nameElement ? nameElement.textContent.trim().toLowerCase() : '';
                case 'invested':
                    if (!cells[1]) return 0;
                    const investedText = cells[1].textContent.replace(/[^\d.-]/g, '');
                    const investedValue = parseFloat(investedText);
                    return isNaN(investedValue) ? 0 : investedValue;
                case 'prize':
                    if (!cells[2]) return 0;
                    const prizeText = cells[2].textContent.replace(/[^\d.-]/g, '');
                    const prizeValue = parseFloat(prizeText);
                    return isNaN(prizeValue) ? 0 : prizeValue;
                case 'week-phc':
                    if (!cells[3]) return '';
                    const phcInput = cells[3].querySelector('input');
                    return phcInput ? phcInput.value.trim() : '';
                case 'week-invested':
                    if (!cells[4]) return 0;
                    const weekInvestedInput = cells[4].querySelector('input');
                    const weekInvestedValue = weekInvestedInput ? parseFloat(weekInvestedInput.value) : 0;
                    return isNaN(weekInvestedValue) ? 0 : weekInvestedValue;
                case 'week-score':
                    if (!cells[5]) return 0;
                    const scoreInput = cells[5].querySelector('input');
                    const scoreValue = scoreInput ? parseFloat(scoreInput.value) : 0;
                    return isNaN(scoreValue) ? 0 : scoreValue;
                case 'week-prize':
                    if (!cells[6]) return 0;
                    const weekPrizeInput = cells[6].querySelector('input');
                    const weekPrizeValue = weekPrizeInput ? parseFloat(weekPrizeInput.value) : 0;
                    return isNaN(weekPrizeValue) ? 0 : weekPrizeValue;
                default:
                    return '';
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // Set up main event listeners
            document.getElementById('addPlayer').addEventListener('click', addPlayerFromForm);
            document.getElementById('addWeek').addEventListener('click', addNewWeek);
            document.getElementById('captureWeek').addEventListener('click', openCaptureModal);
            document.getElementById('capturePHC').addEventListener('click', openPHCCaptureModal);
            document.getElementById('captureSummary').addEventListener('click', captureWeeklySummary);
            document.getElementById('backupData').addEventListener('click', backupData);
            document.getElementById('importData').addEventListener('click', () => document.getElementById('fileInput').click());
            document.getElementById('clearData').addEventListener('click', clearAllData);
            document.getElementById('fileInput').addEventListener('change', importData);
            document.getElementById('weekSelector').addEventListener('change', function() {
                const weekNum = parseInt(this.value); 
                if (!isNaN(weekNum) && weekNum > 0) {
                    currentVisibleWeekIndex = weekNum - 1; 
                    reconstructTable(currentVisibleWeekIndex);
                } else {
                    document.getElementById('weekSubHeaderRow').innerHTML = '';
                    document.querySelector('thead tr:first-child').querySelectorAll('.week-header').forEach(h => h.remove());
                    document.getElementById('tableBody').innerHTML = '';
                    currentVisibleWeekIndex = -1;
                    updateEmptyState();
                }
            });
            
            // *** DIRECT FIX FOR SAVE COURSE BUTTON ***
            console.log('🔧 Setting up Save Course button fix...');
            
            // Use setTimeout to ensure DOM is fully ready
            setTimeout(() => {
                const saveCourseBtn = document.getElementById('saveCourseBtn');
                if (saveCourseBtn) {
                    console.log('✅ Found Save Course button, adding click listener');
                    
                    saveCourseBtn.addEventListener('click', function(e) {
                        console.log('🎯 Save Course button clicked!');
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Get the course data
                        const courseNameInput = document.getElementById('courseName');
                        const dateInput = document.getElementById('scoreCardDate');
                        
                        if (!courseNameInput || !dateInput) {
                            alert('Course input fields not found!');
                            return;
                        }
                        
                        const courseName = courseNameInput.value.trim() || 'Golf Course';
                        const date = dateInput.value || new Date().toISOString().split('T')[0];
                        
                        console.log(`💾 Saving: ${courseName} on ${date}`);
                        
                        // Update the data
                        scorecardData.courseName = courseName;
                        scorecardData.date = date;
                        
                        // Save to localStorage
                        try {
                            localStorage.setItem('golfScorecardData', JSON.stringify(scorecardData));
                            alert(`Course "${courseName}" saved successfully!`);
                            console.log('✅ Course saved successfully');
                        } catch (error) {
                            alert('Error saving course: ' + error.message);
                            console.error('❌ Save error:', error);
                        }
                    });
                } else {
                    console.error('❌ Save Course button not found after timeout');
                }
            }, 100);
            
            console.log('🔧 Save Course button setup complete');
            
            // Rules Textarea Listener for auto-saving
            document.getElementById('rulesTextArea').addEventListener('input', function() {
                trackerData.rulesText = this.value;
                saveDataToStorage();
            });

            // Results input listeners for auto-saving and formatting
            const resultInputFields = [
                'firstPlace', 'firstPlaceMoney', 
                'secondPlace', 'secondPlaceMoney', 
                'thirdPlace', 'thirdPlaceMoney', 
                'fourthPlace', 'fourthPlaceMoney'
            ];

            resultInputFields.forEach(field => {
                const inputId = `${field}Input`;
                const input = document.getElementById(inputId);
                
                if(input) {
                    const isMoneyField = field.endsWith('Money');

                    input.addEventListener('input', function() {
                        if (isMoneyField) {
                            // Only save the value if it's a valid number or empty
                            let value = this.value.trim();
                            if (value === '' || !isNaN(parseFloat(value))) {
                                trackerData.results[field] = value;
                            }
                        } else {
                            trackerData.results[field] = this.value;
                        }
                        saveDataToStorage();
                        // Auto-save weekly results when results are entered
                        autoSaveWeeklyResults();
                    });

                    if (isMoneyField) {
                        // On blur, format to two decimal places if a number exists
                        input.addEventListener('blur', function() {
                            let value = parseFloat(this.value);
                            if (!isNaN(value)) {
                                const formattedValue = value.toFixed(2);
                                this.value = formattedValue;
                                trackerData.results[field] = formattedValue;
                                saveDataToStorage();
                                autoSaveWeeklyResults();
                            } else if (this.value.trim() !== '') {
                                // If non-numeric text was entered, clear it and the data
                                this.value = '';
                                trackerData.results[field] = '';
                                saveDataToStorage();
                            }
                        });
                    }
                }
            });

            [document.getElementById('playerName'), document.getElementById('playerPHC')].forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') addPlayerFromForm();
                });
            });
            
            initColorPicker();
            initHeaderEditing();
            initSorting();
            
            loadDataFromStorage();
        });
        
        // Local Storage Functions
        function saveDataToStorage() {
            try {
                localStorage.setItem('playerTrackerData', JSON.stringify(trackerData));
                showStatusMessage('Data saved automatically', 'success');
            } catch (error) {
                console.error('Failed to save data:', error);
                showStatusMessage('Failed to save data', 'error');
            }
        }
        
        function loadDataFromStorage() {
            try {
                const savedData = localStorage.getItem('playerTrackerData');
                if (savedData) {
                    trackerData = JSON.parse(savedData);
                    
                    // --- Compatibility Check and Load Header ---
                    if (!trackerData.header) {
                        trackerData.header = {
                            title: "Midweek Golf Swindle Tracker",
                            subtitle: "Track player investments, scores, and prize money with ease"
                        };
                    }
                    document.getElementById('mainTitle').textContent = trackerData.header.title;
                    document.getElementById('mainSubtitle').textContent = trackerData.header.subtitle;

                    // --- Load Rules Text ---
                    const rulesTextArea = document.getElementById('rulesTextArea');
                    if (trackerData.rulesText !== undefined) {
                         rulesTextArea.value = trackerData.rulesText;
                    } else {
                        // Ensure rulesText is initialized if old data didn't have it
                        trackerData.rulesText = '';
                        rulesTextArea.value = rulesTextArea.placeholder;
                    }

                    // --- Load Results Data (with backward compatibility) ---
                    if (!trackerData.results || trackerData.results.firstPlaceMoney === undefined) {
                        // If results structure is old or missing, initialize new fields
                        const oldResults = trackerData.results || {};
                        trackerData.results = {
                            firstPlace: oldResults.firstPlace || '',
                            firstPlaceMoney: '',
                            secondPlace: oldResults.secondPlace || '',
                            secondPlaceMoney: '',
                            thirdPlace: oldResults.thirdPlace || '',
                            thirdPlaceMoney: '',
                            fourthPlace: oldResults.fourthPlace || '',
                            fourthPlaceMoney: ''
                        };
                    }

                    document.getElementById('firstPlaceInput').value = trackerData.results.firstPlace;
                    document.getElementById('firstPlaceMoneyInput').value = trackerData.results.firstPlaceMoney;
                    document.getElementById('secondPlaceInput').value = trackerData.results.secondPlace;
                    document.getElementById('secondPlaceMoneyInput').value = trackerData.results.secondPlaceMoney;
                    document.getElementById('thirdPlaceInput').value = trackerData.results.thirdPlace;
                    document.getElementById('thirdPlaceMoneyInput').value = trackerData.results.thirdPlaceMoney;
                    document.getElementById('fourthPlaceInput').value = trackerData.results.fourthPlace;
                    document.getElementById('fourthPlaceMoneyInput').value = trackerData.results.fourthPlaceMoney;
                    
                    // --- Initialize weeklyResults for analytics ---
                    if (!trackerData.weeklyResults) {
                        trackerData.weeklyResults = [];
                    }

                    currentVisibleWeekIndex = trackerData.weeks.length > 0 ? trackerData.weeks.length - 1 : -1;

                    reconstructTable(currentVisibleWeekIndex);
                    if (trackerData.players.length > 0) {
                        showStatusMessage('Data loaded from previous session', 'success');
                    }
                } else {
                     updateEmptyState();
                }
            } catch (error) {
                console.error('Failed to load data:', error);
                showStatusMessage('Failed to load saved data', 'error');
                updateEmptyState();
            }
        }
        
        function reconstructTable(weekIndexToRender = currentVisibleWeekIndex) {
            const tbody = document.getElementById('tableBody');
            const mainHeaderRow = document.querySelector('thead tr:first-child');
            const weekSubHeaderRow = document.getElementById('weekSubHeaderRow');
            
            // Clear all existing dynamic columns (headers and body)
            mainHeaderRow.querySelectorAll('.week-header').forEach(header => header.remove());
            weekSubHeaderRow.innerHTML = '';
            tbody.innerHTML = '';
            
            // Clear and repopulate dropdown
            const weekSelector = document.getElementById('weekSelector');
            weekSelector.innerHTML = '<option value="">Jump to Week...</option>';
            
            // Populate Dropdown first
            trackerData.weeks.forEach((w, index) => {
                const option = document.createElement('option');
                option.value = index + 1;
                option.textContent = `Week ${index + 1} (${formatDateForDisplay(w.date)})`;
                weekSelector.appendChild(option);
            });

            // Only proceed if there are weeks AND a week is selected
            if (trackerData.weeks.length > 0 && weekIndexToRender !== -1) {
                
                if (weekIndexToRender < 0 || weekIndexToRender >= trackerData.weeks.length) {
                    weekIndexToRender = trackerData.weeks.length - 1; 
                }
                currentVisibleWeekIndex = weekIndexToRender;

                // 1. Reconstruct Headers for the ONE visible week
                const week = trackerData.weeks[currentVisibleWeekIndex];
                addWeekHeader(currentVisibleWeekIndex + 1, week.date);
                
                // Set the selected value in the dropdown
                weekSelector.value = currentVisibleWeekIndex + 1;
                
                // 2. Reconstruct Players for the ONE visible week
                trackerData.players.forEach(player => {
                    reconstructPlayer(player, currentVisibleWeekIndex);
                });
            } else {
                 currentVisibleWeekIndex = -1; 
            }

            updateTotals();
            updateEmptyState();
        }
        
        function addWeekHeader(weekNumber, dateValue = null) {
            const mainHeaderRow = document.querySelector('thead tr:first-child');
            const weekSubHeaderRow = document.getElementById('weekSubHeaderRow');
            
            const weekHeader = document.createElement('th');
            weekHeader.colSpan = 4;
            weekHeader.className = 'week-header';
            
            const weekContainer = document.createElement('div');
            weekContainer.className = 'week-header-container';
            
            const weekLabel = document.createElement('div');
            weekLabel.className = 'week-label';
            weekLabel.textContent = `WEEK ${weekNumber}`;
            weekContainer.appendChild(weekLabel);
            
            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.className = 'week-date-input';
            dateInput.value = dateValue || new Date().toISOString().split('T')[0];
            
            const weekIndex = weekNumber - 1;
            
            dateInput.addEventListener('change', function() {
                updateWeekDate(weekIndex, this.value);
                const weekSelector = document.getElementById('weekSelector');
                const option = weekSelector.querySelector(`option[value="${weekNumber}"]`);
                if(option) {
                    option.textContent = `Week ${weekNumber} (${formatDateForDisplay(this.value)})`;
                }
                saveDataToStorage();
            });
            
            const dateDisplay = document.createElement('div');
            dateDisplay.className = 'week-date-display';
            dateDisplay.textContent = formatDateForDisplay(dateInput.value);
            
            dateInput.addEventListener('change', function() {
                dateDisplay.textContent = formatDateForDisplay(this.value);
            });
            
            weekContainer.appendChild(dateDisplay);
            weekContainer.appendChild(dateInput);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'week-delete-btn';
            deleteBtn.textContent = '×';
            deleteBtn.title = `Delete Week ${weekNumber}`;
            deleteBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                deleteWeek(weekIndex);
            });
            weekContainer.appendChild(deleteBtn);
            
            weekHeader.appendChild(weekContainer);
            mainHeaderRow.appendChild(weekHeader);
            
            const headers = ['PHC', 'Invested', 'Score', 'Prize'];
            const classes = ['phc-cell', 'invested-cell', 'score-cell', 'prize-cell'];
            const sortKeys = ['week-phc', 'week-invested', 'week-score', 'week-prize'];
            
            headers.forEach((text, i) => {
                const header = document.createElement('th');
                header.className = `week-section ${classes[i]} sortable`;
                header.setAttribute('data-sort', sortKeys[i]);
                header.style.cursor = 'pointer';
                header.innerHTML = `${text} <span id="sort-${sortKeys[i]}" style="color:#a0aec0;font-size:11px;margin-left:4px;opacity:0.7;">↕</span>`;
                
                // Add click event listener for sorting
                header.addEventListener('click', function() {
                    console.log('Weekly header clicked:', this.textContent, 'data-sort:', this.getAttribute('data-sort'));
                    sortTable(this.getAttribute('data-sort'));
                });
                
                weekSubHeaderRow.appendChild(header);
            });
            
            if (trackerData.weeks[weekIndex]) {
                trackerData.weeks[weekIndex].date = dateInput.value;
            }
        }
        
        function formatDateForDisplay(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString + 'T00:00:00'); 
            const options = { weekday: 'short', day: 'numeric', month: 'short' };
            return date.toLocaleDateString('en-GB', options);
        }
        
        function updateWeekDate(weekIndex, dateValue) {
            if (trackerData.weeks[weekIndex]) {
                trackerData.weeks[weekIndex].date = dateValue;
            }
        }
        
        function reconstructPlayer(playerData, weekIndex) {
            const tbody = document.getElementById('tableBody');
            const row = document.createElement('tr');
            row.dataset.playerId = playerData.id; 
            
            // 1. Player Name Cell
            const nameCell = document.createElement('td');
            nameCell.className = 'fixed-col';
            
            const nameContainer = document.createElement('div');
            nameContainer.className = 'player-name-container';
            
            const nameText = document.createElement('div');
            nameText.className = 'player-name-text';
            nameText.textContent = playerData.name;
            nameContainer.appendChild(nameText);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = '×';
            deleteBtn.className = 'delete-btn';
            deleteBtn.title = 'Delete Player';
            deleteBtn.addEventListener('click', function() {
                deletePlayer(playerData.id);
            });
            nameContainer.appendChild(deleteBtn);
            
            nameCell.appendChild(nameContainer);
            
            // Global PHC Input
            const phcContainer = document.createElement('div');
            phcContainer.className = 'phc-input-container';
            
            const phcLabel = document.createElement('label');
            phcLabel.textContent = 'PHC:';
            phcContainer.appendChild(phcLabel);
            
            const phcInput = document.createElement('input');
            phcInput.type = 'text';
            phcInput.maxLength = 10;
            phcInput.value = playerData.phc || '';
            phcInput.placeholder = 'PHC';
            phcInput.addEventListener('input', function() {
                updatePlayerPHC(playerData.id, this.value);
                saveDataToStorage();
            });
            phcContainer.appendChild(phcInput);
            
            nameCell.appendChild(phcContainer);
            row.appendChild(nameCell);
            
            // 2. Money invested total cell
            const investedCell = document.createElement('td');
            investedCell.className = 'fixed-col-2 total-cell';
            investedCell.textContent = '£0.00';
            row.appendChild(investedCell);
            
            // 3. Prize money total cell
            const prizeCell = document.createElement('td');
            prizeCell.className = 'fixed-col-3 total-cell';
            prizeCell.textContent = '£0.00';
            row.appendChild(prizeCell);
            
            // 4. Add cells only for the visible week
            const weekData = playerData.weeks[weekIndex];
            
            if (weekData) {
                // Array of fields and classes for the 4 weekly columns
                const weekFields = ['phc', 'invested', 'score', 'prize'];
                const weekClasses = ['phc-cell', 'invested-cell', 'score-cell', 'prize-cell'];
                const weekTypes = ['text', 'number', 'number', 'number'];
                
                weekFields.forEach((field, i) => {
                    const cell = document.createElement('td');
                    cell.className = `week-section ${weekClasses[i]}`;
                    
                    const inputContainer = document.createElement('div');
                    inputContainer.className = (field === 'invested' || field === 'prize') ? 'currency-input' : '';
                    
                    const input = document.createElement('input');
                    input.type = weekTypes[i];
                    input.value = weekData[field] || '';
                    input.placeholder = (field === 'invested' || field === 'prize') ? '0.00' : (field === 'score' ? '0' : 'PHC');
                    
                    if (field === 'invested' || field === 'prize') {
                        input.step = '0.01';
                        input.min = '0';
                    } else if (field === 'score') {
                        input.min = '0';
                        input.title = 'Click for color picker';
                    } else if (field === 'phc') {
                        input.maxLength = 10;
                    }
                    
                    // Input event listener (Saves raw data, now updates totals for immediate feedback)
                    input.addEventListener('input', function() {
                        if (field === 'score') updateScoreStyling(this);
                        
                        updatePlayerWeekData(playerData.id, weekIndex, field, this.value, (field === 'score' ? this.style.backgroundColor : ''));
                        
                        // *** FIX APPLIED HERE: Update totals live when Invested or Prize changes ***
                        if (field === 'invested' || field === 'prize') {
                            updateTotals(); 
                        }
                        
                        saveDataToStorage();
                    });
                    
                    // Add blur listener for Invested and Prize to ensure formatting and reliable total update
                    if (field === 'invested' || field === 'prize') {
                        input.addEventListener('blur', function() {
                            let value = parseFloat(this.value);
                            let finalValue = '';
                            
                            if (!isNaN(value) && this.value.trim() !== '') {
                                // Format input value and store the formatted string
                                finalValue = value.toFixed(2);
                                this.value = finalValue;
                            } else {
                                // Clear input and data if non-numeric
                                this.value = '';
                                finalValue = '';
                            }
                            
                            updatePlayerWeekData(playerData.id, weekIndex, field, finalValue);
                            updateTotals(); // CRUCIAL: Calculate totals after the value is cleaned/formatted
                            saveDataToStorage();
                        });
                    }

                    
                    // Special Score color logic
                    if (field === 'score') {
                        if (weekData.scoreColor) {
                            input.style.backgroundColor = weekData.scoreColor;
                        }
                        updateScoreStyling(input);
                        
                        input.addEventListener('click', function(e) {
                            // Only show color picker if there's a score value entered
                            if (this.value && this.value.trim() !== '') {
                                e.stopPropagation();
                                currentScoreInput = this;
                                showColorPicker(this);
                            }
                        });
                    }
                    
                    inputContainer.appendChild(input);
                    cell.appendChild(inputContainer);
                    row.appendChild(cell);
                });
            }
            
            tbody.appendChild(row);
            
            updatePlayerTotals(playerData.id);
        }
        
        function addPlayerFromForm() {
            const nameInput = document.getElementById('playerName');
            const phcInput = document.getElementById('playerPHC');
            
            const name = nameInput.value.trim();
            const phc = phcInput.value.trim();
            
            if (name) {
                addPlayer(name, phc);
                nameInput.value = '';
                phcInput.value = '';
                nameInput.focus();
            }
        }
        
        function addPlayer(name, phc = '') {
            const playerId = Date.now().toString(); 
            
            const playerData = {
                id: playerId,
                name: name,
                phc: phc,
                weeks: []
            };
            
            // Initialize week data for existing weeks
            trackerData.weeks.forEach(() => {
                playerData.weeks.push({
                    phc: '', invested: '', score: '', prize: '', scoreColor: ''
                });
            });
            
            trackerData.players.push(playerData);
            
            reconstructTable(currentVisibleWeekIndex);
            saveDataToStorage();
            updateEmptyState();
            
            showStatusMessage(`Player "${name}" added`, 'success');
        }
        
        function deletePlayer(playerId) {
            if (confirm('Are you sure you want to delete this player?')) {
                trackerData.players = trackerData.players.filter(player => player.id !== playerId);
                reconstructTable(currentVisibleWeekIndex);
                saveDataToStorage();
                updateEmptyState();
                showStatusMessage('Player deleted', 'success');
            }
        }
        
        function updatePlayerPHC(playerId, phcValue) {
            const player = trackerData.players.find(p => p.id === playerId);
            if (player) {
                player.phc = phcValue;
            }
        }
        
        function updatePlayerWeekData(playerId, weekIndex, field, value, color = null) {
            const player = trackerData.players.find(p => p.id === playerId);
            if (player && player.weeks[weekIndex]) {
                player.weeks[weekIndex][field] = value;
                
                if (field === 'score' && color !== null) {
                    player.weeks[weekIndex].scoreColor = color;
                }
            }
        }
        
        function addNewWeek() {
            const weekNumber = trackerData.weeks.length + 1;
            
            trackerData.weeks.push({
                number: weekNumber,
                date: new Date().toISOString().split('T')[0]
            });
            
            trackerData.players.forEach(player => {
                player.weeks.push({
                    phc: '', invested: '', score: '', prize: '', scoreColor: ''
                });
            });
            
            currentVisibleWeekIndex = trackerData.weeks.length - 1;
            
            reconstructTable(currentVisibleWeekIndex);
            saveDataToStorage();
            
            showStatusMessage(`Week ${weekNumber} added`, 'success');
        }
        
        function deleteWeek(weekIndex) {
            if (confirm(`Are you sure you want to delete Week ${weekIndex + 1}? All data for this week will be lost.`)) {
                
                trackerData.weeks.splice(weekIndex, 1);
                
                trackerData.players.forEach(player => {
                    player.weeks.splice(weekIndex, 1);
                });
                
                let nextVisibleIndex = -1;
                if (trackerData.weeks.length > 0) {
                    nextVisibleIndex = Math.max(0, weekIndex - 1);
                }
                
                currentVisibleWeekIndex = nextVisibleIndex;
                
                reconstructTable(currentVisibleWeekIndex);
                saveDataToStorage();
                
                showStatusMessage('Week deleted successfully', 'success');
            }
        }
        
        function updateTotals() {
            trackerData.players.forEach(player => {
                updatePlayerTotals(player.id);
            });
        }
        
        function updatePlayerTotals(playerId) {
            const player = trackerData.players.find(p => p.id === playerId);
            if (!player) return;
            
            let investedTotal = 0;
            let prizeTotal = 0;
            
            player.weeks.forEach(week => {
                // Ensure the saved value is parsed correctly as a float, defaulting to 0
                investedTotal += parseFloat(week.invested) || 0;
                prizeTotal += parseFloat(week.prize) || 0;
            });
            
            const playerRow = document.querySelector(`#tableBody tr[data-player-id="${playerId}"]`);
            
            if (playerRow) {
                const cells = playerRow.querySelectorAll('td');
                if (cells.length >= 3) {
                    cells[1].textContent = `£${investedTotal.toFixed(2)}`;
                    cells[2].textContent = `£${prizeTotal.toFixed(2)}`;
                }
            }
        }
        
        function updateEmptyState() {
            const emptyState = document.getElementById('emptyState');
            const tableElement = document.getElementById('trackerTable');
            
            if (trackerData.players.length === 0 || currentVisibleWeekIndex === -1) {
                emptyState.style.display = 'block';
                tableElement.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
                tableElement.style.display = 'table';
            }
        }
        
        function backupData() {
            try {
                const dataStr = JSON.stringify(trackerData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const url = URL.createObjectURL(dataBlob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `golf-swindle-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showStatusMessage('Backup created successfully', 'success');
            } catch (error) {
                console.error('Backup failed:', error);
                showStatusMessage('Backup failed', 'error');
            }
        }
        
        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    if (importedData.players && Array.isArray(importedData.players) &&
                        importedData.weeks && Array.isArray(importedData.weeks)) {
                        
                        if (confirm('Importing data will replace all current data. Continue?')) {
                            trackerData = importedData;
                            
                            // Compatibility check and default initialization
                            if (!trackerData.header) {
                                trackerData.header = {
                                    title: "Midweek Golf Swindle Tracker",
                                    subtitle: "Track player investments, scores, and prize money with ease"
                                };
                            }
                            if (trackerData.rulesText === undefined) {
                                trackerData.rulesText = ''; 
                            }

                            if (!trackerData.results || trackerData.results.firstPlaceMoney === undefined) {
                                // If imported data lacks new fields, use old fields if available
                                const oldResults = trackerData.results || {};
                                trackerData.results = { 
                                    firstPlace: oldResults.firstPlace || '', firstPlaceMoney: '',
                                    secondPlace: oldResults.secondPlace || '', secondPlaceMoney: '',
                                    thirdPlace: oldResults.thirdPlace || '', thirdPlaceMoney: '',
                                    fourthPlace: oldResults.fourthPlace || '', fourthPlaceMoney: ''
                                };
                            }
                            
                            // FIX: Map old 'paid' to new 'invested' in imported data for compatibility
                            trackerData.players.forEach(player => {
                                player.weeks.forEach(week => {
                                    if (week.paid !== undefined) {
                                        week.invested = week.paid;
                                        delete week.paid;
                                    }
                                });
                            });


                            currentVisibleWeekIndex = trackerData.weeks.length > 0 ? trackerData.weeks.length - 1 : -1;

                            reconstructTable(currentVisibleWeekIndex);
                            
                            // Manually update the textarea and result inputs after import
                            const rulesTextArea = document.getElementById('rulesTextArea');
                            rulesTextArea.value = trackerData.rulesText || rulesTextArea.placeholder;
                            
                            document.getElementById('firstPlaceInput').value = trackerData.results.firstPlace;
                            document.getElementById('firstPlaceMoneyInput').value = trackerData.results.firstPlaceMoney;
                            document.getElementById('secondPlaceInput').value = trackerData.results.secondPlace;
                            document.getElementById('secondPlaceMoneyInput').value = trackerData.results.secondPlaceMoney;
                            document.getElementById('thirdPlaceInput').value = trackerData.results.thirdPlace;
                            document.getElementById('thirdPlaceMoneyInput').value = trackerData.results.thirdPlaceMoney;
                            document.getElementById('fourthPlaceInput').value = trackerData.results.fourthPlace;
                            document.getElementById('fourthPlaceMoneyInput').value = trackerData.results.fourthPlaceMoney;

                            saveDataToStorage();
                            showStatusMessage('Data imported successfully', 'success');
                        }
                    } else {
                        throw new Error('Invalid data format');
                    }
                } catch (error) {
                    console.error('Import failed:', error);
                    showStatusMessage('Failed to import data: Invalid file format', 'error');
                }
            };
            reader.readAsText(file);
            
            event.target.value = '';
        }
        
        function clearAllData() {
            if (confirm('Are you sure you want to clear ALL data? This action cannot be undone.')) {
                
                const rulesTextArea = document.getElementById('rulesTextArea');

                trackerData = {
                    players: [],
                    weeks: [],
                    version: '1.0',
                    header: {
                        title: "Midweek Golf Swindle Tracker",
                        subtitle: "Track player investments, scores, and prize money with ease"
                    },
                    rulesText: '', // Clear rules text
                    results: { // Clear all results fields
                        firstPlace: '', firstPlaceMoney: '',
                        secondPlace: '', secondPlaceMoney: '',
                        thirdPlace: '', thirdPlaceMoney: '',
                        fourthPlace: '', fourthPlaceMoney: ''
                    } 
                };
                
                rulesTextArea.value = rulesTextArea.placeholder; // Reset textarea placeholder
                document.getElementById('firstPlaceInput').value = '';
                document.getElementById('firstPlaceMoneyInput').value = '';
                document.getElementById('secondPlaceInput').value = '';
                document.getElementById('secondPlaceMoneyInput').value = '';
                document.getElementById('thirdPlaceInput').value = '';
                document.getElementById('thirdPlaceMoneyInput').value = '';
                document.getElementById('fourthPlaceInput').value = '';
                document.getElementById('fourthPlaceMoneyInput').value = '';
                
                currentVisibleWeekIndex = -1; 
                reconstructTable();
                saveDataToStorage();
                
                showStatusMessage('All data cleared', 'success');
            }
        }
        
        function showStatusMessage(message, type) {
            const statusEl = document.getElementById('dataStatus');
            statusEl.textContent = message;
            statusEl.className = 'data-status';
            statusEl.classList.add('show', type);
            
            setTimeout(() => {
                statusEl.classList.remove('show');
            }, 3000);
        }
        
        // Capture Week Functionality
        function openCaptureModal() {
            if (currentVisibleWeekIndex === -1 || !trackerData.weeks[currentVisibleWeekIndex]) {
                showStatusMessage('Please select a week to capture', 'error');
                return;
            }
            
            const weekData = trackerData.weeks[currentVisibleWeekIndex];
            const weekNumber = currentVisibleWeekIndex + 1;
            
            // Filter players who invested £5 for this week
            const fivePoundPlayers = trackerData.players.filter(player => {
                const playerWeekData = player.weeks[currentVisibleWeekIndex];
                return playerWeekData && parseFloat(playerWeekData.invested) === 5.0;
            });
            
            if (fivePoundPlayers.length === 0) {
                showStatusMessage('No players invested £5 this week', 'error');
                return;
            }
            
            // Generate capture content
            generateCaptureContent(weekNumber, weekData, fivePoundPlayers);
            
            // Show modal in compact mode for better capture
            const modal = document.getElementById('captureModal');
            modal.classList.add('capturing');
            modal.style.display = 'flex';
        }
        
        function generateCaptureContent(weekNumber, weekData, players) {
            const weekInfo = document.getElementById('captureWeekInfo');
            const tableContainer = document.getElementById('captureTableContainer');
            const resultsContainer = document.getElementById('captureResultsContainer');
            
            // Week info
            const dateText = weekData.date ? formatDateForDisplay(weekData.date) : '';
            weekInfo.innerHTML = `
                <h3 style="color: var(--color-accent-primary); margin-bottom: 5px; font-size: 18px;">Week ${weekNumber} Results</h3>
                <p style="color: var(--color-text-secondary); font-size: 12px;">${dateText ? `Date: ${dateText} • ` : ''}${players.length} players invested £5.00</p>
            `;
            
            // Sort players by Results table priority (1st, 2nd, 3rd, 4th), then by highest to lowest scores
            const playersWithScores = players.map(player => {
                const weekData = player.weeks[currentVisibleWeekIndex];
                return {
                    name: player.name,
                    phc: player.phc || '',
                    weekPhc: weekData.phc || '',
                    score: weekData.score ? parseFloat(weekData.score) : 0,
                    scoreColor: weekData.scoreColor || '',
                    prize: weekData.prize ? parseFloat(weekData.prize) : 0,
                    invested: weekData.invested ? parseFloat(weekData.invested) : 0
                };
            }).sort((a, b) => {
                // Get results table positions for priority ordering
                const results = trackerData.results || {};
                const aResultsPosition = getResultsPosition(a.name, results);
                const bResultsPosition = getResultsPosition(b.name, results);
                
                // If both players have results positions, sort by results priority
                if (aResultsPosition !== null && bResultsPosition !== null) {
                    return aResultsPosition - bResultsPosition; // Lower position number = higher priority
                }
                // If only one has a results position, prioritize that one
                if (aResultsPosition !== null) return -1;
                if (bResultsPosition !== null) return 1;
                
                // If neither has a results position, sort by score descending (highest first)
                return b.score - a.score;
            });
            
            // Generate players table
            let tableHtml = `
                <table class="capture-results-table">
                    <thead>
                        <tr>
                            <th>Position</th>
                            <th>Player</th>
                            <th>PHC</th>
                            <th>Week PHC</th>
                            <th>Score</th>
                            <th>Prize Won</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            playersWithScores.forEach((player, index) => {
                const position = index + 1;
                const positionText = position === 1 ? '🥇 1st' : 
                                   position === 2 ? '🥈 2nd' : 
                                   position === 3 ? '🥉 3rd' : 
                                   `${position}${getOrdinalSuffix(position)}`;
                                   
                const scoreStyle = player.scoreColor ? `background-color: ${player.scoreColor}; color: white; padding: 4px 8px; border-radius: 4px;` : '';
                const prizeText = player.prize > 0 ? `£${player.prize.toFixed(2)}` : '—';
                
                tableHtml += `
                    <tr>
                        <td class="capture-position">${positionText}</td>
                        <td><strong>${player.name}</strong></td>
                        <td>${player.phc}</td>
                        <td>${player.weekPhc}</td>
                        <td class="capture-score"><span style="${scoreStyle}">${player.score}</span></td>
                        <td class="capture-prize">${prizeText}</td>
                    </tr>
                `;
            });
            
            tableHtml += `
                    </tbody>
                </table>
            `;
            
            tableContainer.innerHTML = tableHtml;
            
            // Generate results summary
            const totalPot = players.length * 5.00;
            const totalPrizesAwarded = playersWithScores.reduce((sum, player) => sum + player.prize, 0);
            const remainingPot = totalPot - totalPrizesAwarded;
            
            // Create a more compact financial summary
            let resultsHtml = `
                <div style="background: var(--color-bg-app); border-radius: 6px; padding: 10px; margin-top: 10px; font-size: 11px;">
                    <h4 style="color: var(--color-accent-primary); margin-bottom: 8px; font-size: 13px;">💰 Financial Summary</h4>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span>Total Pot:</span>
                        <strong>£${totalPot.toFixed(2)}</strong>
                    </div>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                        <span>Prizes Awarded:</span>
                        <strong style="color: var(--color-accent-success);">£${totalPrizesAwarded.toFixed(2)}</strong>
                    </div>
            `;
            
            if (remainingPot > 0) {
                resultsHtml += `
                    <div style="display: flex; justify-content: space-between; padding-top: 3px; border-top: 1px solid var(--color-border); margin-top: 3px;">
                        <span>Remaining:</span>
                        <strong style="color: var(--color-text-secondary);">£${remainingPot.toFixed(2)}</strong>
                    </div>
                `;
            }
            
            resultsHtml += `</div>`;
            
            // Add official results if entered
            const results = trackerData.results;
            if (results && (results.firstPlace || results.secondPlace || results.thirdPlace || results.fourthPlace)) {
                resultsHtml += `
                    <div style="background: var(--color-bg-app); border-radius: 6px; padding: 10px; margin-top: 8px; font-size: 11px;">
                        <h4 style="color: var(--color-accent-primary); margin-bottom: 8px; font-size: 13px;">🏆 Official Results</h4>
                `;
                
                const positions = [
                    {place: '1st', player: results.firstPlace, money: results.firstPlaceMoney, emoji: '🥇'},
                    {place: '2nd', player: results.secondPlace, money: results.secondPlaceMoney, emoji: '🥈'},
                    {place: '3rd', player: results.thirdPlace, money: results.thirdPlaceMoney, emoji: '🥉'},
                    {place: '4th', player: results.fourthPlace, money: results.fourthPlaceMoney, emoji: '4️⃣'}
                ];
                
                positions.forEach(pos => {
                    if (pos.player) {
                        const moneyText = pos.money ? ` - £${parseFloat(pos.money).toFixed(2)}` : '';
                        resultsHtml += `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 3px;">
                                <span>${pos.emoji} ${pos.place} Place:</span>
                                <strong>${pos.player}${moneyText}</strong>
                            </div>
                        `;
                    }
                });
                
                resultsHtml += `</div>`;
            }
            
            resultsContainer.innerHTML = resultsHtml;
        }
        
        function getOrdinalSuffix(num) {
            const j = num % 10;
            const k = num % 100;
            if (j == 1 && k != 11) return 'st';
            if (j == 2 && k != 12) return 'nd';
            if (j == 3 && k != 13) return 'rd';
            return 'th';
        }
        
        // Helper function to get a player's position in the results table (1st, 2nd, 3rd, 4th)
        function getResultsPosition(playerName, results) {
            if (!results || !playerName) return null;
            
            // Check each position in order (1st = position 1, 2nd = position 2, etc.)
            if (results.firstPlace && results.firstPlace.toLowerCase() === playerName.toLowerCase()) {
                return 1;
            }
            if (results.secondPlace && results.secondPlace.toLowerCase() === playerName.toLowerCase()) {
                return 2;
            }
            if (results.thirdPlace && results.thirdPlace.toLowerCase() === playerName.toLowerCase()) {
                return 3;
            }
            if (results.fourthPlace && results.fourthPlace.toLowerCase() === playerName.toLowerCase()) {
                return 4;
            }
            
            return null; // Player not in results table
        }
        
        function closeCaptureModal() {
            const modal = document.getElementById('captureModal');
            modal.classList.remove('capturing');
            modal.style.display = 'none';
        }
        
        // PHC Capture Functionality
        function openPHCCaptureModal() {
            if (trackerData.players.length === 0) {
                showStatusMessage('No players found to capture PHC information', 'error');
                return;
            }
            
            generatePHCCaptureContent();
            
            const modal = document.getElementById('phcCaptureModal');
            modal.style.display = 'flex';
            showStatusMessage('PHC information ready for capture', 'success');
        }
        
        function generatePHCCaptureContent() {
            const container = document.getElementById('phcCaptureContent');
            
            // Sort players alphabetically by name
            const sortedPlayers = trackerData.players.slice().sort((a, b) => a.name.localeCompare(b.name));
            
            // Calculate totals for each player
            const playersWithTotals = sortedPlayers.map(player => {
                let investedTotal = 0;
                let prizeTotal = 0;
                
                player.weeks.forEach(week => {
                    investedTotal += parseFloat(week.invested) || 0;
                    prizeTotal += parseFloat(week.prize) || 0;
                });
                
                return {
                    ...player,
                    investedTotal,
                    prizeTotal
                };
            });
            
            let html = `
                <div style="background: var(--color-bg-app); border-radius: 6px; padding: 15px; margin-bottom: 15px; text-align: center;">
                    <h4 style="color: var(--color-accent-primary); margin: 0 0 5px 0; font-size: 16px;">🏆 Mid-Week Golf Swindle</h4>
                    <p style="color: var(--color-text-secondary); margin: 0; font-size: 12px;">${sortedPlayers.length} Players - PHC & Financial Summary</p>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 8px; max-height: 350px; overflow-y: auto;">
            `;
            
            playersWithTotals.forEach((player, index) => {
                html += `
                    <div style="
                        background: linear-gradient(135deg, var(--color-table-row-odd), var(--color-table-row-even));
                        border-radius: 6px;
                        padding: 8px;
                        border: 1px solid var(--color-border);
                        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
                        transition: transform 0.2s ease;
                        min-height: 100px;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                            <div style="background: var(--color-accent-primary); color: white; width: 18px; height: 18px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: bold;">${index + 1}</div>
                            <div style="text-align: right;">
                                <div style="color: var(--color-accent-primary); font-weight: bold; font-size: 11px;">PHC: ${player.phc || 'N/A'}</div>
                            </div>
                        </div>
                        
                        <div style="font-weight: bold; font-size: 11px; color: var(--color-text-primary); margin-bottom: 6px; text-align: center;">${player.name}</div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 10px;">
                            <div style="background: rgba(255, 87, 34, 0.1); padding: 4px; border-radius: 3px; text-align: center;">
                                <div style="color: var(--color-text-secondary); font-size: 8px;">INVESTED</div>
                                <div style="color: #ff5722; font-weight: bold; font-size: 9px;">£${player.investedTotal.toFixed(2)}</div>
                            </div>
                            <div style="background: rgba(76, 175, 80, 0.1); padding: 4px; border-radius: 3px; text-align: center;">
                                <div style="color: var(--color-text-secondary); font-size: 8px;">PRIZE WON</div>
                                <div style="color: var(--color-accent-success); font-weight: bold; font-size: 9px;">£${player.prizeTotal.toFixed(2)}</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 4px; padding: 3px; background: rgba(66, 153, 225, 0.1); border-radius: 2px; text-align: center; font-size: 9px;">
                            <span style="color: var(--color-text-secondary);">Net: </span>
                            <span style="color: ${(player.prizeTotal - player.investedTotal) >= 0 ? 'var(--color-accent-success)' : '#ff5722'}; font-weight: bold;">
                                £${(player.prizeTotal - player.investedTotal).toFixed(2)}
                            </span>
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div style="text-align: center; margin-top: 15px; padding: 8px; background: rgba(66, 153, 225, 0.1); border-radius: 4px; border: 1px solid rgba(66, 153, 225, 0.3);">
                    <p style="margin: 0; color: var(--color-text-secondary); font-size: 11px; font-style: italic;">
                        📅 Generated: ${new Date().toLocaleDateString()} at ${new Date().toLocaleTimeString()}
                    </p>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        function closePHCCaptureModal() {
            const modal = document.getElementById('phcCaptureModal');
            modal.style.display = 'none';
        }
        
        function downloadPHCImage() {
            // Try html2canvas first, but fallback to direct canvas immediately if it fails
            const hiddenArea = document.getElementById('hiddenCaptureArea');
            
            if (typeof html2canvas !== 'undefined') {
                // Try html2canvas approach
                createPHCHiddenCapture();
            } else {
                // Fallback to direct canvas generation
                generatePHCCanvasCapture();
            }
        }
        
        function createPHCHiddenCapture() {
            const hiddenArea = document.getElementById('hiddenCaptureArea');
            
            // Sort players alphabetically by name
            const sortedPlayers = trackerData.players.slice().sort((a, b) => a.name.localeCompare(b.name));
            
            // Calculate totals for each player
            const playersWithTotals = sortedPlayers.map(player => {
                let investedTotal = 0;
                let prizeTotal = 0;
                
                player.weeks.forEach(week => {
                    investedTotal += parseFloat(week.invested) || 0;
                    prizeTotal += parseFloat(week.prize) || 0;
                });
                
                return {
                    ...player,
                    investedTotal,
                    prizeTotal
                };
            });
            
            // Create clean HTML for PHC capture with grid layout
            let captureHtml = `
                <div style="color: #edf2f7; width: 600px; font-size: 12px;">
                    <div style="text-align: center; margin-bottom: 15px;">
                        <h1 style="color: #4299e1; font-size: 20px; margin: 0 0 5px 0;">🏆 Mid-Week Golf Swindle</h1>
                        <h2 style="color: #4299e1; font-size: 16px; margin: 5px 0;">📋 Players PHC & Financial Summary</h2>
                        <p style="color: #a0aec0; font-size: 11px; margin: 5px 0;">${sortedPlayers.length} Players (Alphabetical Order)</p>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px;">
            `;
            
            playersWithTotals.forEach((player, index) => {
                const netAmount = player.prizeTotal - player.investedTotal;
                const netColor = netAmount >= 0 ? '#48bb78' : '#ff5722';
                
                captureHtml += `
                    <div style="
                        background: linear-gradient(135deg, #2d3748, #242b36);
                        border-radius: 4px;
                        padding: 6px;
                        border: 1px solid #4a5568;
                        min-height: 80px;
                    ">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                            <div style="background: #4299e1; color: white; width: 14px; height: 14px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 7px; font-weight: bold;">${index + 1}</div>
                            <div style="color: #4299e1; font-weight: bold; font-size: 8px;">PHC: ${player.phc || 'N/A'}</div>
                        </div>
                        
                        <div style="font-weight: bold; font-size: 9px; color: #edf2f7; margin-bottom: 4px; text-align: center;">${player.name}</div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2px; font-size: 7px;">
                            <div style="background: rgba(255, 87, 34, 0.2); padding: 2px; border-radius: 2px; text-align: center;">
                                <div style="color: #a0aec0; font-size: 6px;">INVESTED</div>
                                <div style="color: #ff5722; font-weight: bold; font-size: 7px;">£${player.investedTotal.toFixed(2)}</div>
                            </div>
                            <div style="background: rgba(76, 175, 80, 0.2); padding: 2px; border-radius: 2px; text-align: center;">
                                <div style="color: #a0aec0; font-size: 6px;">PRIZE WON</div>
                                <div style="color: #48bb78; font-weight: bold; font-size: 7px;">£${player.prizeTotal.toFixed(2)}</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 2px; padding: 2px; background: rgba(66, 153, 225, 0.2); border-radius: 1px; text-align: center; font-size: 6px;">
                            <span style="color: #a0aec0;">Net: </span>
                            <span style="color: ${netColor}; font-weight: bold;">£${netAmount.toFixed(2)}</span>
                        </div>
                    </div>
                `;
            });
            
            captureHtml += `
                    </div>
                    
                    <div style="text-align: center; margin-top: 10px; padding: 6px; background: rgba(66, 153, 225, 0.1); border-radius: 4px; border: 1px solid rgba(66, 153, 225, 0.3);">
                        <p style="margin: 0; color: #a0aec0; font-size: 9px; font-style: italic;">
                            📅 Generated: ${new Date().toLocaleDateString()} • ${new Date().toLocaleTimeString()}
                        </p>
                    </div>
                </div>
            `;
            
            hiddenArea.innerHTML = captureHtml;
            
            // Perform canvas capture
            performPHCCapture(hiddenArea);
        }
        
        function performPHCCapture(element) {
            // Check if html2canvas is available
            if (typeof html2canvas === 'undefined') {
                console.log('html2canvas not available, using canvas fallback');
                generatePHCCanvasCapture();
                return;
            }
            
            // Set a shorter timeout for html2canvas
            const timeoutId = setTimeout(() => {
                console.log('html2canvas timeout, falling back to canvas');
                generatePHCCanvasCapture();
            }, 3000);
            
            // Wait a moment for layout to settle
            setTimeout(() => {
                html2canvas(element, {
                    backgroundColor: '#2d3748',
                    scale: 3,
                    useCORS: true,
                    allowTaint: true,
                    width: 800,
                    height: 600,
                    scrollX: 0,
                    scrollY: 0,
                    logging: false,
                    letterRendering: true,
                    allowTaint: false,
                    foreignObjectRendering: false
                }).then(canvas => {
                    clearTimeout(timeoutId);
                    
                    // Reset hidden area
                    element.innerHTML = '';
                    
                    const link = document.createElement('a');
                    const dateStr = new Date().toISOString().split('T')[0];
                    const filename = `golf-swindle-phc-${dateStr}.png`;
                    link.download = filename;
                    link.href = canvas.toDataURL('image/png');
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showStatusMessage(`PHC information downloaded: ${filename}`, 'success');
                    
                    // Close modal after successful download
                    setTimeout(() => {
                        closePHCCaptureModal();
                    }, 1500);
                }).catch(error => {
                    clearTimeout(timeoutId);
                    console.error('PHC Capture failed:', error);
                    showStatusMessage('Using canvas fallback method', 'info');
                    // Fallback to canvas generation
                    generatePHCCanvasCapture();
                });
            }, 100);
        }
        
        function generatePHCCanvasCapture() {
            // Sort players alphabetically by name
            const sortedPlayers = trackerData.players.slice().sort((a, b) => a.name.localeCompare(b.name));
            
            // Calculate totals for each player
            const playersWithTotals = sortedPlayers.map(player => {
                let investedTotal = 0;
                let prizeTotal = 0;
                
                player.weeks.forEach(week => {
                    investedTotal += parseFloat(week.invested) || 0;
                    prizeTotal += parseFloat(week.prize) || 0;
                });
                
                return {
                    ...player,
                    investedTotal,
                    prizeTotal
                };
            });
            
            // Calculate dimensions for grid layout
            const width = 600;
            const cardHeight = 90;
            const headerHeight = 80;
            const footerHeight = 30;
            const cardsPerRow = 5;
            const rows = Math.ceil(playersWithTotals.length / cardsPerRow);
            const height = headerHeight + (rows * cardHeight) + footerHeight + 40;
            
            // Create canvas with higher DPI for crisp text
            const canvas = document.createElement('canvas');
            const dpiScale = 4; // 4x for very high DPI
            canvas.width = width * dpiScale;
            canvas.height = height * dpiScale;
            const ctx = canvas.getContext('2d');
            
            // Scale for high DPI and enable text antialiasing
            ctx.scale(dpiScale, dpiScale);
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.textRenderingOptimization = 'optimizeQuality';
            
            // Background
            ctx.fillStyle = '#2d3748';
            ctx.fillRect(0, 0, width, height);
            
            // Header with improved font rendering
            ctx.fillStyle = '#4299e1';
            ctx.font = 'bold 22px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('🏆 Mid-Week Golf Swindle', width / 2, 28);
            
            ctx.fillStyle = '#4299e1';
            ctx.font = 'bold 18px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
            ctx.fillText('📋 Players PHC & Financial Summary', width / 2, 50);
            
            ctx.fillStyle = '#a0aec0';
            ctx.font = '14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
            ctx.fillText(`${playersWithTotals.length} Players (Alphabetical Order)`, width / 2, 70);
            
            let startY = headerHeight;
            
            // Draw player cards in grid
            playersWithTotals.forEach((player, index) => {
                const col = index % cardsPerRow;
                const row = Math.floor(index / cardsPerRow);
                const cardWidth = 110;
                const gap = 8;
                const x = 10 + col * (cardWidth + gap);
                const y = startY + row * cardHeight;
                
                const netAmount = player.prizeTotal - player.investedTotal;
                
                // Card background
                ctx.fillStyle = '#2d3748';
                ctx.fillRect(x, y, cardWidth, cardHeight - 10);
                
                // Card border
                ctx.strokeStyle = '#4a5568';
                ctx.lineWidth = 1;
                ctx.strokeRect(x, y, cardWidth, cardHeight - 10);
                
                // Player number circle
                ctx.fillStyle = '#4299e1';
                ctx.beginPath();
                ctx.arc(x + 15, y + 15, 10, 0, 2 * Math.PI);
                ctx.fill();
                
                ctx.fillStyle = 'white';
                ctx.font = 'bold 10px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText((index + 1).toString(), x + 15, y + 20);
                
                // PHC in top right
                ctx.fillStyle = '#4299e1';
                ctx.font = 'bold 11px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(`PHC: ${player.phc || 'N/A'}`, x + cardWidth - 10, y + 20);
                
                // Player name
                ctx.fillStyle = '#edf2f7';
                ctx.font = 'bold 12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(player.name, x + cardWidth / 2, y + 38);
                
                // Invested amount
                ctx.fillStyle = 'rgba(255, 87, 34, 0.3)';
                ctx.fillRect(x + 5, y + 42, (cardWidth - 15) / 2, 18);
                
                ctx.fillStyle = '#a0aec0';
                ctx.font = '9px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('INVESTED', x + 5 + (cardWidth - 15) / 4, y + 50);
                
                ctx.fillStyle = '#ff5722';
                ctx.font = 'bold 10px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
                ctx.fillText(`£${player.investedTotal.toFixed(2)}`, x + 5 + (cardWidth - 15) / 4, y + 60);
                
                // Prize amount
                ctx.fillStyle = 'rgba(76, 175, 80, 0.3)';
                ctx.fillRect(x + 10 + (cardWidth - 15) / 2, y + 42, (cardWidth - 15) / 2, 18);
                
                ctx.fillStyle = '#a0aec0';
                ctx.font = '9px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('PRIZE WON', x + 10 + (cardWidth - 15) / 2 + (cardWidth - 15) / 4, y + 50);
                
                ctx.fillStyle = '#48bb78';
                ctx.font = 'bold 10px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
                ctx.fillText(`£${player.prizeTotal.toFixed(2)}`, x + 10 + (cardWidth - 15) / 2 + (cardWidth - 15) / 4, y + 60);
                
                // Net amount
                ctx.fillStyle = 'rgba(66, 153, 225, 0.2)';
                ctx.fillRect(x + 5, y + 63, cardWidth - 10, 12);
                
                ctx.fillStyle = '#a0aec0';
                ctx.font = '9px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText('Net:', x + 8, y + 73);
                
                ctx.fillStyle = netAmount >= 0 ? '#48bb78' : '#ff5722';
                ctx.font = 'bold 10px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(`£${netAmount.toFixed(2)}`, x + cardWidth - 8, y + 73);
            });
            
            // Footer
            let footerY = startY + (rows * cardHeight) + 10;
            ctx.fillStyle = '#4a5568';
            ctx.fillRect(10, footerY, width - 20, footerHeight);
            
            ctx.fillStyle = '#a0aec0';
            ctx.font = '12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`📅 Generated: ${new Date().toLocaleDateString()} • ${new Date().toLocaleTimeString()}`, width / 2, footerY + 22);
            
            // Download
            const link = document.createElement('a');
            const dateStr = new Date().toISOString().split('T')[0];
            const filename = `golf-swindle-phc-${dateStr}.png`;
            link.download = filename;
            link.href = canvas.toDataURL('image/png');
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatusMessage(`PHC information downloaded: ${filename}`, 'success');
            
            // Close modal after successful download
            setTimeout(() => {
                closePHCCaptureModal();
            }, 1500);
        }
        
        function createHiddenCapture() {
            const hiddenArea = document.getElementById('hiddenCaptureArea');
            const weekNumber = currentVisibleWeekIndex + 1;
            const weekData = trackerData.weeks[currentVisibleWeekIndex];
            const dateText = weekData.date ? formatDateForDisplay(weekData.date) : '';
            
            // Filter players who invested £5 for this week
            const fivePoundPlayers = trackerData.players.filter(player => {
                const playerWeekData = player.weeks[currentVisibleWeekIndex];
                return playerWeekData && parseFloat(playerWeekData.invested) === 5.0;
            });
            
            // Sort players by score (highest first for Stableford)
            const playersWithScores = fivePoundPlayers.map(player => {
                const weekData = player.weeks[currentVisibleWeekIndex];
                return {
                    name: player.name,
                    phc: player.phc || '',
                    weekPhc: weekData.phc || '',
                    score: weekData.score ? parseFloat(weekData.score) : 0,
                    scoreColor: weekData.scoreColor || '',
                    prize: weekData.prize ? parseFloat(weekData.prize) : 0,
                    invested: weekData.invested ? parseFloat(weekData.invested) : 0
                };
            }).sort((a, b) => b.score - a.score);
            
            // Create clean HTML for capture
            let captureHtml = `
                <div style="color: #edf2f7; width: 480px; font-size: 14px;">
                    <div style="text-align: center; margin-bottom: 20px;">
                        <h1 style="color: #4299e1; font-size: 24px; margin: 0 0 5px 0;">🏌️ Mid-Week Golf Swindle</h1>
                        <p style="color: #a0aec0; font-size: 16px; margin: 0 0 5px 0;">Weekly Results</p>
                        <h2 style="color: #4299e1; font-size: 20px; margin: 10px 0 5px 0;">Week ${weekNumber} Results</h2>
                        <p style="color: #a0aec0; font-size: 12px; margin: 0;">${dateText ? `Date: ${dateText} • ` : ''}${fivePoundPlayers.length} players invested £5.00</p>
                    </div>
                    
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; background: #1a202c; border-radius: 6px; overflow: hidden;">
                        <thead>
                            <tr style="background: #4a5568;">
                                <th style="padding: 8px 6px; text-align: center; font-size: 12px; color: #edf2f7; border-right: 1px solid #2d3748;">Pos</th>
                                <th style="padding: 8px 6px; text-align: left; font-size: 12px; color: #edf2f7; border-right: 1px solid #2d3748;">Player</th>
                                <th style="padding: 8px 6px; text-align: center; font-size: 12px; color: #edf2f7; border-right: 1px solid #2d3748;">PHC</th>
                                <th style="padding: 8px 6px; text-align: center; font-size: 12px; color: #edf2f7; border-right: 1px solid #2d3748;">Week PHC</th>
                                <th style="padding: 8px 6px; text-align: center; font-size: 12px; color: #edf2f7; border-right: 1px solid #2d3748;">Score</th>
                                <th style="padding: 8px 6px; text-align: right; font-size: 12px; color: #edf2f7;">Prize</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            playersWithScores.forEach((player, index) => {
                const position = index + 1;
                const positionText = position === 1 ? '🥇 1st' : 
                                   position === 2 ? '🥈 2nd' : 
                                   position === 3 ? '🥉 3rd' : 
                                   `${position}${getOrdinalSuffix(position)}`;
                
                const rowBg = index % 2 === 0 ? '#2d3748' : '#242b36';
                const scoreStyle = player.scoreColor ? `background-color: ${player.scoreColor}; color: white; padding: 2px 6px; border-radius: 3px;` : '';
                const prizeText = player.prize > 0 ? `£${player.prize.toFixed(2)}` : '—';
                
                captureHtml += `
                    <tr style="background: ${rowBg};">
                        <td style="padding: 6px; text-align: center; font-size: 11px; color: #4299e1; font-weight: bold; border-right: 1px solid #4a5568;">${positionText}</td>
                        <td style="padding: 6px; text-align: left; font-size: 11px; font-weight: bold; border-right: 1px solid #4a5568;">${player.name}</td>
                        <td style="padding: 6px; text-align: center; font-size: 11px; border-right: 1px solid #4a5568;">${player.phc}</td>
                        <td style="padding: 6px; text-align: center; font-size: 11px; border-right: 1px solid #4a5568;">${player.weekPhc}</td>
                        <td style="padding: 6px; text-align: center; font-size: 11px; font-weight: bold; border-right: 1px solid #4a5568;"><span style="${scoreStyle}">${player.score}</span></td>
                        <td style="padding: 6px; text-align: right; font-size: 11px; font-weight: bold; color: #48bb78;">${prizeText}</td>
                    </tr>
                `;
            });
            
            const totalPot = fivePoundPlayers.length * 5.00;
            const totalPrizesAwarded = playersWithScores.reduce((sum, player) => sum + player.prize, 0);
            const remainingPot = totalPot - totalPrizesAwarded;
            
            captureHtml += `
                        </tbody>
                    </table>
                    
                    <div style="background: #1a202c; border-radius: 6px; padding: 12px; font-size: 12px;">
                        <h4 style="color: #4299e1; margin: 0 0 8px 0; font-size: 14px;">💰 Financial Summary</h4>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span>Total Pot:</span>
                            <strong>£${totalPot.toFixed(2)}</strong>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                            <span>Prizes Awarded:</span>
                            <strong style="color: #48bb78;">£${totalPrizesAwarded.toFixed(2)}</strong>
                        </div>
            `;
            
            if (remainingPot > 0) {
                captureHtml += `
                        <div style="display: flex; justify-content: space-between; padding-top: 4px; border-top: 1px solid #4a5568; margin-top: 4px;">
                            <span>Remaining:</span>
                            <strong style="color: #a0aec0;">£${remainingPot.toFixed(2)}</strong>
                        </div>
                `;
            }
            
            captureHtml += '</div>';
            
            // Add official results if available
            const results = trackerData.results;
            if (results && (results.firstPlace || results.secondPlace || results.thirdPlace || results.fourthPlace)) {
                captureHtml += `
                    <div style="background: #1a202c; border-radius: 6px; padding: 12px; margin-top: 10px; font-size: 12px;">
                        <h4 style="color: #4299e1; margin: 0 0 8px 0; font-size: 14px;">🏆 Official Results</h4>
                `;
                
                const positions = [
                    {place: '1st', player: results.firstPlace, money: results.firstPlaceMoney, emoji: '🥇'},
                    {place: '2nd', player: results.secondPlace, money: results.secondPlaceMoney, emoji: '🥈'},
                    {place: '3rd', player: results.thirdPlace, money: results.thirdPlaceMoney, emoji: '🥉'},
                    {place: '4th', player: results.fourthPlace, money: results.fourthPlaceMoney, emoji: '4️⃣'}
                ];
                
                positions.forEach(pos => {
                    if (pos.player) {
                        const moneyText = pos.money ? ` - £${parseFloat(pos.money).toFixed(2)}` : '';
                        captureHtml += `
                            <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                                <span>${pos.emoji} ${pos.place} Place:</span>
                                <strong>${pos.player}${moneyText}</strong>
                            </div>
                        `;
                    }
                });
                
                captureHtml += '</div>';
            }
            
            captureHtml += '</div>';
            
            hiddenArea.innerHTML = captureHtml;
        }
        
        function downloadCaptureImage() {
            // Show loading message
            showStatusMessage('Generating clean image...', 'success');
            
            // Generate capture directly using canvas
            setTimeout(() => {
                generateCanvasCapture();
            }, 100);
        }
        
        function generateCanvasCapture() {
            const weekNumber = currentVisibleWeekIndex + 1;
            const weekData = trackerData.weeks[currentVisibleWeekIndex];
            const dateText = weekData.date ? formatDateForDisplay(weekData.date) : '';
            
            // Filter players who invested £5 for this week
            const fivePoundPlayers = trackerData.players.filter(player => {
                const playerWeekData = player.weeks[currentVisibleWeekIndex];
                return playerWeekData && parseFloat(playerWeekData.invested) === 5.0;
            });
            
            // Sort players by Results table priority (1st, 2nd, 3rd, 4th), then by highest to lowest scores
            const playersWithScores = fivePoundPlayers.map(player => {
                const weekData = player.weeks[currentVisibleWeekIndex];
                return {
                    name: player.name,
                    phc: player.phc || '',
                    weekPhc: weekData.phc || '',
                    score: weekData.score ? parseFloat(weekData.score) : 0,
                    scoreColor: weekData.scoreColor || '',
                    prize: weekData.prize ? parseFloat(weekData.prize) : 0,
                    invested: weekData.invested ? parseFloat(weekData.invested) : 0
                };
            }).sort((a, b) => {
                // Get results table positions for priority ordering
                const results = trackerData.results || {};
                const aResultsPosition = getResultsPosition(a.name, results);
                const bResultsPosition = getResultsPosition(b.name, results);
                
                // If both players have results positions, sort by results priority
                if (aResultsPosition !== null && bResultsPosition !== null) {
                    return aResultsPosition - bResultsPosition; // Lower position number = higher priority
                }
                // If only one has a results position, prioritize that one
                if (aResultsPosition !== null) return -1;
                if (bResultsPosition !== null) return 1;
                
                // If neither has a results position, sort by score descending (highest first)
                return b.score - a.score;
            });
            
            // Calculate dimensions
            const width = 500;
            const rowHeight = 35;
            const headerHeight = 100;
            const tableHeaderHeight = 30;
            const summaryHeight = 80;
            const height = headerHeight + tableHeaderHeight + (playersWithScores.length * rowHeight) + summaryHeight + 20;
            
            // Create canvas with high DPI for sharp text
            const canvas = document.createElement('canvas');
            const dpiScale = 4; // 4x for very high DPI
            canvas.width = width * dpiScale;
            canvas.height = height * dpiScale;
            const ctx = canvas.getContext('2d');
            
            // Scale for high DPI and enable text antialiasing
            ctx.scale(dpiScale, dpiScale);
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.textRenderingOptimization = 'optimizeQuality';
            
            // Background
            ctx.fillStyle = '#2d3748';
            ctx.fillRect(0, 0, width, height);
            
            // Header with improved font rendering
            ctx.fillStyle = '#4299e1';
            ctx.font = 'bold 26px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('🏌️‍♀️ Mid-Week Golf Swindle', width / 2, 32);
            
            ctx.fillStyle = '#a0aec0';
            ctx.font = '18px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
            ctx.fillText('Weekly Results', width / 2, 54);
            
            ctx.fillStyle = '#4299e1';
            ctx.font = 'bold 22px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
            ctx.fillText(`Week ${weekNumber} Results`, width / 2, 78);
            
            ctx.fillStyle = '#a0aec0';
            ctx.font = '14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
            ctx.fillText(`${dateText ? `Date: ${dateText} • ` : ''}${fivePoundPlayers.length} players invested £5.00`, width / 2, 98);
            
            let y = headerHeight;
            
            // Table header
            ctx.fillStyle = '#4a5568';
            ctx.fillRect(10, y, width - 20, tableHeaderHeight);
            
            ctx.fillStyle = '#edf2f7';
            ctx.font = 'bold 14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('Pos', 40, y + 22);
            ctx.textAlign = 'left';
            ctx.fillText('Player', 70, y + 22);
            ctx.textAlign = 'center';
            ctx.fillText('PHC', 200, y + 22);
            ctx.fillText('Week PHC', 250, y + 22);
            ctx.fillText('Score', 320, y + 22);
            ctx.textAlign = 'right';
            ctx.fillText('Prize', 470, y + 22);
            
            y += tableHeaderHeight;
            
            // Table rows
            playersWithScores.forEach((player, index) => {
                const position = index + 1;
                const positionText = position === 1 ? '🥇 1st' : 
                                   position === 2 ? '🥈 2nd' : 
                                   position === 3 ? '🥉 3rd' : 
                                   `${position}${getOrdinalSuffix(position)}`;
                
                const rowBg = index % 2 === 0 ? '#2d3748' : '#242b36';
                const prizeText = player.prize > 0 ? `£${player.prize.toFixed(2)}` : '—';
                
                // Row background
                ctx.fillStyle = rowBg;
                ctx.fillRect(10, y, width - 20, rowHeight);
                
                // Row border
                ctx.strokeStyle = '#4a5568';
                ctx.lineWidth = 1;
                ctx.strokeRect(10, y, width - 20, rowHeight);
                
                // Text with improved font rendering
                ctx.fillStyle = '#4299e1';
                ctx.font = 'bold 13px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText(positionText, 40, y + 24);
                
                ctx.fillStyle = '#edf2f7';
                ctx.font = 'bold 13px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
                ctx.textAlign = 'left';
                ctx.fillText(player.name, 70, y + 24);
                
                ctx.textAlign = 'center';
                ctx.fillText(player.phc, 200, y + 24);
                ctx.fillText(player.weekPhc, 250, y + 24);
                
                // Score with color background if present
                if (player.scoreColor) {
                    ctx.fillStyle = player.scoreColor;
                    ctx.fillRect(305, y + 10, 30, 15);
                    ctx.fillStyle = 'white';
                } else {
                    ctx.fillStyle = '#edf2f7';
                }
                ctx.font = 'bold 13px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
                ctx.fillText(player.score.toString(), 320, y + 24);
                
                ctx.fillStyle = '#48bb78';
                ctx.font = 'bold 13px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
                ctx.textAlign = 'right';
                ctx.fillText(prizeText, 470, y + 24);
                
                y += rowHeight;
            });
            
            // Financial summary
            y += 10;
            const totalPot = fivePoundPlayers.length * 5.00;
            const totalPrizesAwarded = playersWithScores.reduce((sum, player) => sum + player.prize, 0);
            
            ctx.fillStyle = '#1a202c';
            ctx.fillRect(10, y, width - 20, summaryHeight);
            
            ctx.fillStyle = '#4299e1';
            ctx.font = 'bold 16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('💰 Financial Summary', 20, y + 22);
            
            ctx.fillStyle = '#edf2f7';
            ctx.font = '14px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
            ctx.fillText('Total Pot:', 20, y + 44);
            ctx.textAlign = 'right';
            ctx.fillText(`£${totalPot.toFixed(2)}`, width - 30, y + 44);
            
            ctx.textAlign = 'left';
            ctx.fillText('Prizes Awarded:', 20, y + 62);
            ctx.fillStyle = '#48bb78';
            ctx.textAlign = 'right';
            ctx.fillText(`£${totalPrizesAwarded.toFixed(2)}`, width - 30, y + 62);
            
            // Download
            console.log('Canvas created:', canvas.width, 'x', canvas.height);
            console.log('Players in capture:', playersWithScores.length);
            
            const link = document.createElement('a');
            const dateStr = trackerData.weeks[currentVisibleWeekIndex]?.date || new Date().toISOString().split('T')[0];
            const filename = `golf-swindle-week-${weekNumber}-${dateStr}.png`;
            link.download = filename;
            link.href = canvas.toDataURL('image/png');
            
            console.log('Download link created:', filename);
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatusMessage(`Clean image downloaded: ${filename}`, 'success');
            
            // Don't close modal immediately so user can see the success message
            setTimeout(() => {
                closeCaptureModal();
            }, 2000);
        }
        
        function performCapture(element) {
            // Wait a moment for layout to settle
            setTimeout(() => {
                html2canvas(element, {
                    backgroundColor: '#2d3748',
                    scale: 4,
                    useCORS: true,
                    allowTaint: false,
                    width: 600,
                    height: 800,
                    scrollX: 0,
                    scrollY: 0,
                    logging: false,
                    letterRendering: true,
                    foreignObjectRendering: false
                }).then(canvas => {
                    // Reset hidden area position
                    element.style.left = '-9999px';
                    element.style.position = 'absolute';
                    element.style.zIndex = '0';
                    
                    // Create download link
                    const link = document.createElement('a');
                    const weekNumber = currentVisibleWeekIndex + 1;
                    const dateStr = trackerData.weeks[currentVisibleWeekIndex]?.date || new Date().toISOString().split('T')[0];
                    link.download = `golf-swindle-week-${weekNumber}-${dateStr}.png`;
                    link.href = canvas.toDataURL();
                    
                    // Trigger download
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    showStatusMessage('Image downloaded successfully!', 'success');
                }).catch(error => {
                    // Reset hidden area position on error too
                    element.style.left = '-9999px';
                    element.style.position = 'absolute';
                    element.style.zIndex = '0';
                    
                    console.error('Capture failed:', error);
                    showStatusMessage('Image capture failed', 'error');
                });
            }, 200); // Small delay to ensure layout is settled
        }
        
        // Comprehensive Weekly Summary Capture
        function captureWeeklySummary() {
            if (currentVisibleWeekIndex === -1 || !trackerData.weeks[currentVisibleWeekIndex]) {
                showStatusMessage('Please select a week to capture summary', 'error');
                return;
            }
            
            if (trackerData.players.length === 0) {
                showStatusMessage('No players found to capture', 'error');
                return;
            }
            
            showStatusMessage('Generating comprehensive summary...', 'success');
            
            setTimeout(() => {
                generateWeeklySummaryCanvas();
            }, 100);
        }
        
        function generateWeeklySummaryCanvas() {
            const weekNumber = currentVisibleWeekIndex + 1;
            const weekData = trackerData.weeks[currentVisibleWeekIndex];
            const dateText = weekData.date ? formatDateForDisplay(weekData.date) : '';
            
            // Get all players in the current table display order
            const allPlayers = getCurrentTableOrder();
            
            // Calculate layout dimensions to match the display layout
            const width = 1400; // Wider to accommodate side-by-side layout
            const headerHeight = 120;
            const playerRowHeight = 45;
            const playersTableHeight = (allPlayers.length * playerRowHeight) + 85; // +85 for headers and title
            const sidebarWidth = 300; // Width for Results and Rules sections
            const mainContentHeight = Math.max(playersTableHeight, 500); // Minimum height for sidebar content
            const height = headerHeight + mainContentHeight + 60; // Total height
            
            // Create high-resolution canvas
            const canvas = document.createElement('canvas');
            const dpiScale = 4;
            canvas.width = width * dpiScale;
            canvas.height = height * dpiScale;
            const ctx = canvas.getContext('2d');
            
            // Scale and optimize for text
            ctx.scale(dpiScale, dpiScale);
            ctx.imageSmoothingEnabled = true;
            ctx.imageSmoothingQuality = 'high';
            ctx.textRenderingOptimization = 'optimizeQuality';
            
            // Background
            ctx.fillStyle = '#1a202c';
            ctx.fillRect(0, 0, width, height);
            
            let currentY = 20;
            
            // HEADER SECTION
            drawSummaryHeader(ctx, width, currentY, weekNumber, dateText);
            currentY += headerHeight;
            
            // MAIN CONTENT AREA (Players table + Sidebar)
            const tableWidth = width - sidebarWidth - 60; // Leave space for sidebar
            const sidebarX = tableWidth + 40; // Position sidebar to the right
            
            // PLAYERS TABLE SECTION (Left side)
            drawPlayersTableSideBySide(ctx, tableWidth, currentY, allPlayers, weekNumber);
            
            // RESULTS SECTION (Top right)
            drawResultsSectionSideBySide(ctx, sidebarX, sidebarWidth, currentY);
            
            // RULES SECTION (Bottom right)
            drawRulesSectionSideBySide(ctx, sidebarX, sidebarWidth, currentY + 200);
            
            // Download the image
            const link = document.createElement('a');
            const dateStr = weekData.date || new Date().toISOString().split('T')[0];
            const filename = `golf-swindle-summary-week-${weekNumber}-${dateStr}.png`;
            link.download = filename;
            link.href = canvas.toDataURL('image/png');
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatusMessage(`Complete summary downloaded: ${filename}`, 'success');
        }
        
        function drawSummaryHeader(ctx, width, startY, weekNumber, dateText) {
            // Main title
            ctx.fillStyle = '#4299e1';
            ctx.font = 'bold 32px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText('🏌️ Mid-Week Golf Swindle', width / 2, startY + 35);
            
            // Week info
            ctx.fillStyle = '#4299e1';
            ctx.font = 'bold 24px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
            ctx.fillText(`Week ${weekNumber} - Complete Summary`, width / 2, startY + 70);
            
            // Date
            ctx.fillStyle = '#a0aec0';
            ctx.font = '16px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
            ctx.fillText(dateText ? `${dateText}` : new Date().toLocaleDateString(), width / 2, startY + 95);
        }
        
        function drawPlayersTableSideBySide(ctx, tableWidth, startY, players, weekNumber) {
            const tableX = 30;
            const rowHeight = 45;
            const headerHeight = 35;
            
            // Table background
            ctx.fillStyle = '#2d3748';
            ctx.fillRect(tableX, startY, tableWidth, (players.length * rowHeight) + headerHeight + 50);
            
            // Table border
            ctx.strokeStyle = '#4a5568';
            ctx.lineWidth = 2;
            ctx.strokeRect(tableX, startY, tableWidth, (players.length * rowHeight) + headerHeight + 50);
            
            // Section title
            ctx.fillStyle = '#4299e1';
            ctx.font = 'bold 20px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('📊 All Players Summary', tableX + 20, startY + 25);
            
            let y = startY + 40;
            
            // Table headers
            ctx.fillStyle = '#4a5568';
            ctx.fillRect(tableX + 10, y, tableWidth - 20, headerHeight);
            
            // Adjusted column widths to fit in the narrower space
            const colWidths = [140, 80, 100, 90, 80, 90, 80, 90]; 
            const headers = ['Player Name', 'PHC', 'Total Invested', 'Total Won', 'Week PHC', 'Week Invested', 'Week Score', 'Week Prize'];
            
            ctx.fillStyle = '#edf2f7';
            ctx.font = 'bold 12px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
            ctx.textAlign = 'center';
            
            let colX = tableX + 15;
            headers.forEach((header, i) => {
                if (i === 0) {
                    ctx.textAlign = 'left';
                    ctx.fillText(header, colX + 5, y + 22);
                } else {
                    ctx.textAlign = 'center';
                    ctx.fillText(header, colX + colWidths[i] / 2, y + 22);
                }
                colX += colWidths[i];
            });
            
            y += headerHeight;
            
            // Player rows
            players.forEach((player, index) => {
                const weekPlayerData = player.weeks[currentVisibleWeekIndex] || {};
                
                // Calculate totals
                let totalInvested = 0;
                let totalPrize = 0;
                player.weeks.forEach(week => {
                    totalInvested += parseFloat(week.invested) || 0;
                    totalPrize += parseFloat(week.prize) || 0;
                });
                
                // Row background
                const rowBg = index % 2 === 0 ? '#242b36' : '#2d3748';
                ctx.fillStyle = rowBg;
                ctx.fillRect(tableX + 10, y, tableWidth - 20, rowHeight);
                
                // Row border
                ctx.strokeStyle = '#4a5568';
                ctx.lineWidth = 1;
                ctx.strokeRect(tableX + 10, y, tableWidth - 20, rowHeight);
                
                // Data
                const rowData = [
                    player.name,
                    player.phc || 'N/A',
                    `£${totalInvested.toFixed(2)}`,
                    `£${totalPrize.toFixed(2)}`,
                    weekPlayerData.phc || '-',
                    weekPlayerData.invested ? `£${parseFloat(weekPlayerData.invested).toFixed(2)}` : '-',
                    weekPlayerData.score || '-',
                    weekPlayerData.prize ? `£${parseFloat(weekPlayerData.prize).toFixed(2)}` : '-'
                ];
                
                ctx.fillStyle = '#edf2f7';
                ctx.font = '11px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
                
                colX = tableX + 15;
                rowData.forEach((data, i) => {
                    if (i === 0) {
                        ctx.textAlign = 'left';
                        ctx.fillText(data, colX + 5, y + 28);
                    } else if (i === 1 || i === 4 || i === 6) { // PHC, Week PHC, Score - center
                        ctx.textAlign = 'center';
                        ctx.fillText(data, colX + colWidths[i] / 2, y + 28);
                    } else { // Money amounts - right align
                        ctx.textAlign = 'right';
                        ctx.fillText(data, colX + colWidths[i] - 5, y + 28);
                    }
                    colX += colWidths[i];
                });
                
                y += rowHeight;
            });
            
            return y + 20;
        }
        
        function drawResultsSectionSideBySide(ctx, sectionX, sectionWidth, startY) {
            const sectionHeight = 180;
            
            // Results background
            ctx.fillStyle = '#2d3748';
            ctx.fillRect(sectionX, startY, sectionWidth, sectionHeight);
            
            ctx.strokeStyle = '#4a5568';
            ctx.lineWidth = 2;
            ctx.strokeRect(sectionX, startY, sectionWidth, sectionHeight);
            
            // Results title
            ctx.fillStyle = '#4299e1';
            ctx.font = 'bold 18px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('🏆 Results', sectionX + 15, startY + 25);
            
            // Results data
            const results = trackerData.results;
            const positions = [
                {emoji: '🥇', place: '1st', player: results.firstPlace, money: results.firstPlaceMoney},
                {emoji: '🥈', place: '2nd', player: results.secondPlace, money: results.secondPlaceMoney},
                {emoji: '🥉', place: '3rd', player: results.thirdPlace, money: results.thirdPlaceMoney},
                {emoji: '🔵', place: '4th', player: results.fourthPlace, money: results.fourthPlaceMoney}
            ];
            
            ctx.font = '13px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
            
            positions.forEach((pos, index) => {
                const y = startY + 55 + (index * 25);
                
                // Draw everything on the same line
                const playerText = pos.player || 'Not set';
                const moneyText = pos.money ? ` (£${parseFloat(pos.money).toFixed(2)})` : '';
                
                // Draw emoji, place, and player name all on same line
                ctx.fillStyle = '#4299e1';
                ctx.textAlign = 'left';
                ctx.fillText(`${pos.emoji} ${pos.place} Place:`, sectionX + 15, y);
                
                // Continue on same line with player name
                ctx.fillStyle = '#edf2f7';
                ctx.fillText(` ${playerText}`, sectionX + 105, y); // Position after "1st Place:"
                
                // Money amount on the far right of same line
                if (pos.money) {
                    ctx.fillStyle = '#48bb78';
                    ctx.textAlign = 'right';
                    ctx.fillText(`£${parseFloat(pos.money).toFixed(2)}`, sectionX + sectionWidth - 15, y);
                }
            });
        }
        
        function drawRulesSectionSideBySide(ctx, sectionX, sectionWidth, startY) {
            const sectionHeight = 280;
            
            // Rules background
            ctx.fillStyle = '#2d3748';
            ctx.fillRect(sectionX, startY, sectionWidth, sectionHeight);
            
            ctx.strokeStyle = '#4a5568';
            ctx.lineWidth = 2;
            ctx.strokeRect(sectionX, startY, sectionWidth, sectionHeight);
            
            // Rules title
            ctx.fillStyle = '#4299e1';
            ctx.font = 'bold 18px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
            ctx.textAlign = 'left';
            ctx.fillText('📋 Swindle Rules', sectionX + 15, startY + 25);
            
            // Parse and display rules as numbered list
            const rulesText = trackerData.rulesText || 'No rules set';
            const lineHeight = 22;
            let y = startY + 50;
            
            ctx.font = '13px -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif';
            
            if (rulesText && rulesText !== 'No rules set') {
                // Parse rules more intelligently - look for actual numbered rules
                let ruleLines = [];
                
                // First try to split by line breaks
                const lines = rulesText.split(/\r?\n/).filter(line => line.trim().length > 0);
                
                // Check if it already has numbered format (1., 2., etc.)
                const hasNumberedFormat = lines.some(line => /^\d+\./.test(line.trim()));
                
                if (hasNumberedFormat) {
                    // Extract only the numbered rules, skip "Rules:" header
                    ruleLines = lines.filter(line => /^\d+\./.test(line.trim()))
                                   .map(line => line.replace(/^\d+\.\s*/, '').trim());
                } else {
                    // Try to split by sentences or numbered patterns
                    const cleanedText = rulesText.replace(/^Rules:\s*/i, '').trim();
                    // Split by periods followed by numbers or capital letters, or by line breaks
                    ruleLines = cleanedText.split(/(?<=\.)\s*(?=\d+\.|[A-Z])|\r?\n/)
                                          .filter(line => line.trim().length > 0)
                                          .map(line => line.trim());
                }
                
                // Remove empty rules and "Rules:" if it appears
                ruleLines = ruleLines.filter(rule => rule && !rule.match(/^Rules:\s*$/i));
                
                ruleLines.forEach((rule, index) => {
                    const ruleText = rule.trim();
                    if (ruleText && y < startY + sectionHeight - 30) {
                        // Draw rule number
                        ctx.fillStyle = '#4299e1';
                        ctx.textAlign = 'left';
                        ctx.fillText(`${index + 1}.`, sectionX + 15, y);
                        
                        // Word wrap the rule text
                        ctx.fillStyle = '#edf2f7';
                        const maxWidth = sectionWidth - 50;
                        const words = ruleText.split(' ');
                        let line = '';
                        let currentY = y;
                        
                        for (let n = 0; n < words.length; n++) {
                            const testLine = line + words[n] + ' ';
                            const metrics = ctx.measureText(testLine);
                            const testWidth = metrics.width;
                            
                            if (testWidth > maxWidth && n > 0) {
                                ctx.fillText(line.trim(), sectionX + 35, currentY);
                                line = words[n] + ' ';
                                currentY += lineHeight;
                            } else {
                                line = testLine;
                            }
                        }
                        if (line.trim()) {
                            ctx.fillText(line.trim(), sectionX + 35, currentY);
                        }
                        
                        y = currentY + lineHeight + 3; // Spacing between rules
                    }
                });
            } else {
                ctx.fillText('No rules set', sectionX + 15, y);
            }
        }
        
        // Get current theme colors from CSS custom properties
        function getCurrentThemeColors() {
            const root = document.documentElement;
            const computedStyle = getComputedStyle(root);
            
            return {
                bgPrimary: computedStyle.getPropertyValue('--color-bg-primary').trim() || '#0f172a',
                bgSecondary: computedStyle.getPropertyValue('--color-bg-secondary').trim() || '#1e293b',
                bgContainer: computedStyle.getPropertyValue('--color-bg-container').trim() || '#334155',
                textPrimary: computedStyle.getPropertyValue('--color-text-primary').trim() || '#f1f5f9',
                textSecondary: computedStyle.getPropertyValue('--color-text-secondary').trim() || '#cbd5e1',
                accentPrimary: computedStyle.getPropertyValue('--color-accent-primary').trim() || '#0ea5e9',
                success: computedStyle.getPropertyValue('--color-success').trim() || '#10b981',
                error: computedStyle.getPropertyValue('--color-error').trim() || '#ef4444',
                border: computedStyle.getPropertyValue('--color-border').trim() || '#475569',
                tableHeader: computedStyle.getPropertyValue('--color-table-header').trim() || '#334155',
                tableRowOdd: computedStyle.getPropertyValue('--color-table-row-odd').trim() || '#334155',
                tableRowEven: computedStyle.getPropertyValue('--color-table-row-even').trim() || '#1e293b'
            };
        }
        
        // Capture individual analytics sections as images
        function captureAnalyticsSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (!section) {
                console.error(`Section ${sectionId} not found`);
                showStatusMessage(`Section ${sectionId} not found`, 'error');
                return;
            }
            
            // Get section title for filename
            const parentSection = section.closest('.analytics-section');
            const titleElement = parentSection.querySelector('h3');
            const sectionTitle = titleElement ? titleElement.textContent.replace(/[^\w\s-]/g, '').trim() : sectionId;
            
            console.log(`📷 Capturing analytics section: ${sectionTitle}`);
            
            // Go straight to manual capture for reliability
            // html2canvas often has issues with CSS variables and complex styling
            captureAnalyticsSectionManually(section, sectionTitle);
        }
        
        function captureAnalyticsSectionWithCanvas(section, sectionTitle) {
            // First try to make the section more visible for capture
            const originalStyle = section.style.cssText;
            section.style.backgroundColor = '#2d3748';
            section.style.color = '#edf2f7';
            section.style.padding = '20px';
            section.style.border = '1px solid #4a5568';
            section.style.borderRadius = '8px';
            
            const options = {
                backgroundColor: '#2d3748',
                scale: 1.5,
                logging: true,
                useCORS: true,
                allowTaint: true,
                width: section.scrollWidth,
                height: section.scrollHeight,
                x: 0,
                y: 0,
                scrollX: 0,
                scrollY: 0,
                windowWidth: window.innerWidth,
                windowHeight: window.innerHeight
            };
            
            console.log('📷 Attempting html2canvas capture with options:', options);
            
            html2canvas(section, options).then(canvas => {
                // Restore original styles
                section.style.cssText = originalStyle;
                
                // Check if canvas has content
                const ctx = canvas.getContext('2d');
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const hasContent = imageData.data.some(pixel => pixel !== 0);
                
                if (!hasContent) {
                    console.log('⚠️ html2canvas produced empty image, falling back to manual capture');
                    captureAnalyticsSectionManually(section, sectionTitle);
                    return;
                }
                
                // Create download link
                const link = document.createElement('a');
                link.download = `${sectionTitle.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.png`;
                link.href = canvas.toDataURL('image/png', 0.9);
                
                // Trigger download
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showStatusMessage(`${sectionTitle} captured successfully`, 'success');
                console.log(`✅ ${sectionTitle} section captured and downloaded`);
            }).catch(error => {
                // Restore original styles
                section.style.cssText = originalStyle;
                console.error('Canvas capture failed:', error);
                captureAnalyticsSectionManually(section, sectionTitle);
            });
        }
        
        function captureAnalyticsSectionManually(section, sectionTitle) {
            console.log(`🎨 Manual capture for: ${sectionTitle}`);
            
            // Get current theme colors
            const themeColors = getCurrentThemeColors();
            
            // Create canvas
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // Calculate required canvas size based on table content
            const table = section.querySelector('table');
            let canvasWidth = 1000;
            let canvasHeight = 150; // Base height for title and padding
            
            if (table) {
                const rows = Array.from(table.querySelectorAll('tr'));
                const headerCells = rows.length > 0 ? Array.from(rows[0].querySelectorAll('th, td')) : [];
                const numCols = headerCells.length;
                const numDataRows = rows.length - 1; // Exclude header
                
                // Calculate width based on number of columns, accounting for special columns
                let baseWidth = numCols * 140;
                
                // Check if we have a "Dates Won" column which needs extra width
                const hasDatesWonColumn = headerCells.some(cell => 
                    cell.textContent.replace(/[\u2191\u2193\u2195]/g, '').trim().toLowerCase().includes('dates won')
                );
                
                if (hasDatesWonColumn) {
                    baseWidth += 200; // Add extra width for the dates column
                    console.log('📋 Adding extra width for Dates Won column');
                }
                
                canvasWidth = Math.max(900, baseWidth + 100); // At least 900px with padding
                
                // Calculate height based on number of rows
                canvasHeight = 150 + // Title area
                              40 +  // Header row
                              (numDataRows * 35) + // Data rows
                              50;   // Bottom padding
                
                console.log(`📋 Table: ${numCols} cols, ${numDataRows} data rows`);
                console.log(`📋 Canvas size: ${canvasWidth}x${canvasHeight}`);
            }
            
            // Set calculated canvas size
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;
            
            // Set background using theme colors
            ctx.fillStyle = themeColors.bgContainer;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Draw title using theme colors
            const parentSection = section.closest('.analytics-section');
            const titleElement = parentSection.querySelector('h3');
            const title = titleElement ? titleElement.textContent : sectionTitle;
            
            ctx.fillStyle = themeColors.accentPrimary;
            ctx.font = 'bold 24px Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(title, canvas.width / 2, 50);
            
            // Find and draw table
            if (table) {
                drawAnalyticsTableToCanvas(ctx, table, 20, 90, canvas.width - 40, themeColors);
            } else {
                // If no table, show message
                ctx.fillStyle = themeColors.textSecondary;
                ctx.font = '16px Arial, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No data available for this section', canvas.width / 2, canvas.height / 2);
                ctx.fillText('Please ensure data is loaded in the analytics section', canvas.width / 2, canvas.height / 2 + 30);
            }
            
            // Add timestamp
            ctx.fillStyle = themeColors.textSecondary;
            ctx.font = '12px Arial, sans-serif';
            ctx.textAlign = 'right';
            ctx.fillText(`Generated: ${new Date().toLocaleDateString()}`, canvas.width - 50, canvas.height - 20);
            
            // Create download link
            const link = document.createElement('a');
            link.download = `${sectionTitle.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.png`;
            link.href = canvas.toDataURL('image/png', 0.9);
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showStatusMessage(`${sectionTitle} captured (manual mode)`, 'success');
            console.log(`✅ ${sectionTitle} section captured manually and downloaded`);
        }
        
        function drawAnalyticsTableToCanvas(ctx, table, startX, startY, maxWidth, themeColors) {
            const rows = Array.from(table.querySelectorAll('tr'));
            
            if (rows.length === 0) {
                ctx.fillStyle = themeColors.textSecondary;
                ctx.font = '16px Arial, sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('No table data found', startX + maxWidth / 2, startY + 50);
                return;
            }
            
            console.log(`📋 Drawing table with ${rows.length} rows`);
            
            const rowHeight = 35;
            const headerHeight = 40;
            let y = startY;
            
            // Get header data
            const headerRow = rows[0];
            const headerCells = Array.from(headerRow.querySelectorAll('th, td'));
            const numCols = headerCells.length;
            
            // Calculate dynamic column widths based on content
            const colWidths = [];
            let totalWidth = 0;
            
            // First pass: calculate minimum widths based on header text and content
            headerCells.forEach((cell, colIndex) => {
                const headerText = cell.textContent.replace(/[\u2191\u2193\u2195]/g, '').trim();
                let minWidth = Math.max(120, headerText.length * 10); // At least 120px or based on text
                
                // Special handling for "Dates Won" column - make it much wider
                if (headerText.toLowerCase().includes('dates won')) {
                    minWidth = Math.max(300, minWidth); // Much wider for dates column
                    console.log(`📋 Setting Dates Won column (${colIndex}) to width: ${minWidth}px`);
                }
                
                colWidths[colIndex] = minWidth;
                totalWidth += minWidth;
            });
            
            // Scale widths to fit maxWidth while maintaining proportions
            if (totalWidth > maxWidth) {
                const scaleFactor = maxWidth / totalWidth;
                colWidths.forEach((width, i) => {
                    colWidths[i] = Math.floor(width * scaleFactor);
                });
            } else if (totalWidth < maxWidth) {
                // Distribute extra space evenly
                const extraSpace = maxWidth - totalWidth;
                const extraPerCol = Math.floor(extraSpace / numCols);
                colWidths.forEach((width, i) => {
                    colWidths[i] = width + extraPerCol;
                });
            }
            
            console.log(`📋 Table has ${numCols} columns with widths:`, colWidths);
            
            // Draw header
            let x = startX;
            headerCells.forEach((cell, colIndex) => {
                const currentColWidth = colWidths[colIndex];
                
                // Header background
                ctx.fillStyle = themeColors.tableHeader;
                ctx.fillRect(x, y, currentColWidth, headerHeight);
                
                // Header border
                ctx.strokeStyle = themeColors.accentPrimary;
                ctx.lineWidth = 1;
                ctx.strokeRect(x, y, currentColWidth, headerHeight);
                
                // Header text
                ctx.fillStyle = themeColors.textPrimary;
                ctx.font = 'bold 13px Arial, sans-serif';
                ctx.textAlign = 'center';
                
                const headerText = cell.textContent.replace(/[\u2191\u2193\u2195]/g, '').trim();
                console.log(`📋 Header ${colIndex}: "${headerText}" (width: ${currentColWidth}px)`);
                
                // Word wrap header text if needed
                const words = headerText.split(' ');
                if (words.length > 1 && headerText.length > 12) {
                    ctx.fillText(words[0], x + currentColWidth / 2, y + 18);
                    if (words.length > 1) {
                        ctx.fillText(words.slice(1).join(' '), x + currentColWidth / 2, y + 32);
                    }
                } else {
                    ctx.fillText(headerText, x + currentColWidth / 2, y + 25);
                }
                
                x += currentColWidth;
            });
            
            y += headerHeight;
            
            // Draw data rows
            const dataRows = rows.slice(1);
            dataRows.forEach((row, rowIndex) => {
                const cells = Array.from(row.querySelectorAll('td'));
                
                if (cells.length === 0) return;
                
                // Skip empty placeholder rows
                if (cells.length === 1 && cells[0].getAttribute('colspan')) {
                    const messageText = cells[0].textContent.trim();
                    ctx.fillStyle = themeColors.textSecondary;
                    ctx.font = '16px Arial, sans-serif';
                    ctx.textAlign = 'center';
                    ctx.fillText(messageText, startX + maxWidth / 2, y + 25);
                    return;
                }
                
                x = startX;
                
                cells.forEach((cell, colIndex) => {
                    if (colIndex >= numCols) return; // Don't exceed column count
                    
                    const currentColWidth = colWidths[colIndex];
                    
                    // Row background
                    ctx.fillStyle = rowIndex % 2 === 0 ? themeColors.tableRowEven : themeColors.tableRowOdd;
                    ctx.fillRect(x, y, currentColWidth, rowHeight);
                    
                    // Row border
                    ctx.strokeStyle = themeColors.border;
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x, y, currentColWidth, rowHeight);
                    
                    // Cell text
                    const cellText = cell.textContent.trim();
                    const headerText = headerCells[colIndex] ? headerCells[colIndex].textContent.replace(/[\u2191\u2193\u2195]/g, '').trim() : '';
                    console.log(`📋 Row ${rowIndex}, Col ${colIndex}: "${cellText}" (width: ${currentColWidth}px)`);
                    
                    // Color based on content
                    if (cellText.includes('£') || cellText.includes('%')) {
                        ctx.fillStyle = cell.classList.contains('negative-value') ? themeColors.error : themeColors.success;
                    } else {
                        ctx.fillStyle = themeColors.textPrimary;
                    }
                    
                    ctx.font = '11px Arial, sans-serif';
                    
                    // Special handling for "Dates Won" column - ALWAYS left-align
                    if (headerText.toLowerCase().includes('dates won')) {
                        ctx.textAlign = 'left';
                        
                        if (cellText.length > 30) {
                            // Use smaller font for long date lists
                            ctx.font = '10px Arial, sans-serif';
                            
                            // Split long text into multiple lines if needed
                            const maxLineLength = Math.floor(currentColWidth / 6); // Characters per line
                            const words = cellText.split(', ');
                            let lines = [];
                            let currentLine = '';
                            
                            words.forEach(word => {
                                if ((currentLine + word).length <= maxLineLength) {
                                    currentLine += (currentLine ? ', ' : '') + word;
                                } else {
                                    if (currentLine) lines.push(currentLine);
                                    currentLine = word;
                                }
                            });
                            if (currentLine) lines.push(currentLine);
                            
                            // Limit to 2 lines max
                            if (lines.length > 2) {
                                lines = lines.slice(0, 2);
                                lines[1] = lines[1].substring(0, maxLineLength - 3) + '...';
                            }
                            
                            // Draw multiple lines
                            lines.forEach((line, lineIndex) => {
                                ctx.fillText(line, x + 5, y + 15 + (lineIndex * 12));
                            });
                        } else {
                            // Short text in Dates Won column - still left-aligned
                            ctx.fillText(cellText, x + 5, y + 22);
                        }
                    } else {
                        // Normal text handling for other columns
                        ctx.textAlign = 'center';
                        const maxChars = Math.floor(currentColWidth / 8); // Rough estimate
                        const displayText = cellText.length > maxChars ? cellText.substring(0, maxChars - 3) + '...' : cellText;
                        ctx.fillText(displayText, x + currentColWidth / 2, y + 22);
                    }
                    
                    x += currentColWidth;
                });
                
                y += rowHeight;
            });
            
            console.log(`🎨 Table drawing completed: ${dataRows.length} data rows rendered`);
        }
        
        // Helper function to get current table display order
        function getCurrentTableOrder() {
            const tableRows = document.querySelectorAll('#tableBody tr');
            const orderedPlayers = [];
            
            // If there are rows displayed, get the order from the DOM
            if (tableRows.length > 0) {
                tableRows.forEach(row => {
                    const playerId = row.dataset.playerId;
                    const player = trackerData.players.find(p => p.id === playerId);
                    if (player) {
                        orderedPlayers.push(player);
                    }
                });
                return orderedPlayers;
            } else {
                // Fallback to original data order if no table is displayed
                return trackerData.players.slice();
            }
        }
        
        // === ANALYTICS FUNCTIONS ===
        
        // Tab switching function
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab and activate button
            const selectedTab = document.getElementById(`${tabName}-tab`);
            const selectedButton = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            if (selectedButton) {
                selectedButton.classList.add('active');
            }
            
            // If switching to analytics, refresh the data
            if (tabName === 'analytics') {
                refreshAnalytics();
            }
        }
        
        // Main analytics refresh function
        function refreshAnalytics() {
            // Auto-reconstruct historical data if missing and we have weeks with prize data
            if ((!trackerData.weeklyResults || trackerData.weeklyResults.length === 0) && trackerData.weeks.length > 0) {
                console.log('🔄 No historical results found, attempting auto-reconstruction...');
                
                // Check if any players have prize money in any week
                const hasPrizeData = trackerData.players.some(player => 
                    player.weeks && player.weeks.some(week => 
                        week.prize && parseFloat(week.prize) > 0
                    )
                );
                
                if (hasPrizeData) {
                    console.log('🏆 Found prize data in weeks, auto-reconstructing...');
                    reconstructHistoricalResults();
                    return; // refreshAnalytics will be called again after reconstruction
                }
            }
            
            updateSummaryStats();
            updatePositionWinsTable();
            updateWeekPerformanceTable();
            updateFinancialTable();
            updatePerformanceGraph();
        }
        
        // Update summary statistics
        function updateSummaryStats() {
            const statsContainer = document.getElementById('summaryStats');
            if (!statsContainer) return;
            
            const stats = calculateSummaryStats();
            
            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-value">${stats.totalPlayers}</div>
                    <div class="stat-label">Total Players</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.totalWeeks}</div>
                    <div class="stat-label">Weeks Played</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">£${stats.totalInvested.toFixed(2)}</div>
                    <div class="stat-label">Total Invested</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">£${stats.totalPrizes.toFixed(2)}</div>
                    <div class="stat-label">Total Prizes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">£${stats.avgWeeklyPot.toFixed(2)}</div>
                    <div class="stat-label">Avg Weekly Pot</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${stats.mostActivePlayer}</div>
                    <div class="stat-label">Most Active Player</div>
                </div>
            `;
        }
        
        // Calculate summary statistics
        function calculateSummaryStats() {
            let totalInvested = 0;
            let totalPrizes = 0;
            let maxWeeksPlayed = 0;
            let mostActivePlayer = 'N/A';
            
            trackerData.players.forEach(player => {
                let playerInvested = 0;
                let playerPrizes = 0;
                let weeksPlayed = 0;
                
                player.weeks.forEach(week => {
                    if (week.invested && parseFloat(week.invested) > 0) weeksPlayed++;
                    playerInvested += parseFloat(week.invested) || 0;
                    playerPrizes += parseFloat(week.prize) || 0;
                });
                
                totalInvested += playerInvested;
                totalPrizes += playerPrizes;
                
                if (weeksPlayed > maxWeeksPlayed) {
                    maxWeeksPlayed = weeksPlayed;
                    mostActivePlayer = player.name;
                }
            });
            
            return {
                totalPlayers: trackerData.players.length,
                totalWeeks: trackerData.weeks.length,
                totalInvested,
                totalPrizes,
                avgWeeklyPot: trackerData.weeks.length > 0 ? totalInvested / trackerData.weeks.length : 0,
                mostActivePlayer
            };
        }
        
        // Update position wins table
        function updatePositionWinsTable() {
            const table = document.getElementById('positionWinsTable');
            if (!table) {
                console.error('🚫 Position wins table not found');
                return;
            }
            
            const tbody = table.querySelector('tbody');
            const positionData = calculatePositionWins();
            
            console.log('📊 Position wins data calculated:', positionData.length, 'players with wins');
            
            tbody.innerHTML = '';
            
            if (positionData.length === 0) {
                // Show a message when no position data is available
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="7" style="text-align: center; padding: 20px; color: var(--color-text-secondary); font-style: italic;">
                        No position wins data available.<br>
                        <small>Enter player names and prize money in the Results section to see position analytics.</small>
                    </td>
                `;
                tbody.appendChild(row);
                return;
            }
            
            positionData.forEach(player => {
                const row = document.createElement('tr');
                const totalWins = player.first + player.second + player.third + player.fourth;
                const totalMoney = player.firstMoney + player.secondMoney + player.thirdMoney + player.fourthMoney;
                
                // Format position data to show both count and money
                const formatPosition = (count, money) => {
                    if (count === 0) return '-';
                    return `${count}x (£${money.toFixed(2)})`;
                };
                
                row.innerHTML = `
                    <td>${player.name}</td>
                    <td class="positive-value">${formatPosition(player.first, player.firstMoney)}</td>
                    <td class="positive-value">${formatPosition(player.second, player.secondMoney)}</td>
                    <td class="positive-value">${formatPosition(player.third, player.thirdMoney)}</td>
                    <td class="positive-value">${formatPosition(player.fourth, player.fourthMoney)}</td>
                    <td class="positive-value">${totalWins}</td>
                    <td class="positive-value">£${totalMoney.toFixed(2)}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Calculate position wins from historical data across all weeks
        function calculatePositionWins() {
            const playerWins = {};
            
            // Initialize all players
            trackerData.players.forEach(player => {
                playerWins[player.name] = {
                    name: player.name,
                    first: 0, second: 0, third: 0, fourth: 0,
                    firstMoney: 0, secondMoney: 0, thirdMoney: 0, fourthMoney: 0
                };
            });
            
            let hasHistoricalData = false;
            
            // Process historical weekly results if available
            if (trackerData.weeklyResults && Array.isArray(trackerData.weeklyResults) && trackerData.weeklyResults.length > 0) {
                console.log('📊 Processing historical weekly results:', trackerData.weeklyResults.length, 'weeks');
                hasHistoricalData = true;
                
                trackerData.weeklyResults.forEach((weekResult, index) => {
                    console.log(`Week ${index + 1} results:`, weekResult);
                    
                    if (weekResult.firstPlace && weekResult.firstPlaceMoney) {
                        if (!playerWins[weekResult.firstPlace]) {
                            playerWins[weekResult.firstPlace] = {
                                name: weekResult.firstPlace,
                                first: 0, second: 0, third: 0, fourth: 0,
                                firstMoney: 0, secondMoney: 0, thirdMoney: 0, fourthMoney: 0
                            };
                        }
                        playerWins[weekResult.firstPlace].first++;
                        playerWins[weekResult.firstPlace].firstMoney += parseFloat(weekResult.firstPlaceMoney) || 0;
                    }
                    if (weekResult.secondPlace && weekResult.secondPlaceMoney) {
                        if (!playerWins[weekResult.secondPlace]) {
                            playerWins[weekResult.secondPlace] = {
                                name: weekResult.secondPlace,
                                first: 0, second: 0, third: 0, fourth: 0,
                                firstMoney: 0, secondMoney: 0, thirdMoney: 0, fourthMoney: 0
                            };
                        }
                        playerWins[weekResult.secondPlace].second++;
                        playerWins[weekResult.secondPlace].secondMoney += parseFloat(weekResult.secondPlaceMoney) || 0;
                    }
                    if (weekResult.thirdPlace && weekResult.thirdPlaceMoney) {
                        if (!playerWins[weekResult.thirdPlace]) {
                            playerWins[weekResult.thirdPlace] = {
                                name: weekResult.thirdPlace,
                                first: 0, second: 0, third: 0, fourth: 0,
                                firstMoney: 0, secondMoney: 0, thirdMoney: 0, fourthMoney: 0
                            };
                        }
                        playerWins[weekResult.thirdPlace].third++;
                        playerWins[weekResult.thirdPlace].thirdMoney += parseFloat(weekResult.thirdPlaceMoney) || 0;
                    }
                    if (weekResult.fourthPlace && weekResult.fourthPlaceMoney) {
                        if (!playerWins[weekResult.fourthPlace]) {
                            playerWins[weekResult.fourthPlace] = {
                                name: weekResult.fourthPlace,
                                first: 0, second: 0, third: 0, fourth: 0,
                                firstMoney: 0, secondMoney: 0, thirdMoney: 0, fourthMoney: 0
                            };
                        }
                        playerWins[weekResult.fourthPlace].fourth++;
                        playerWins[weekResult.fourthPlace].fourthMoney += parseFloat(weekResult.fourthPlaceMoney) || 0;
                    }
                });
            }
            
            // Always also include current week results (even if we have historical data)
            const results = trackerData.results;
            if (results && (results.firstPlace || results.secondPlace || results.thirdPlace || results.fourthPlace)) {
                console.log('📊 Processing current week results:', results);
                
                if (results.firstPlace && results.firstPlaceMoney) {
                    if (!playerWins[results.firstPlace]) {
                        playerWins[results.firstPlace] = {
                            name: results.firstPlace,
                            first: 0, second: 0, third: 0, fourth: 0,
                            firstMoney: 0, secondMoney: 0, thirdMoney: 0, fourthMoney: 0
                        };
                    }
                    // Only add current week if not in historical data or if no historical data exists
                    if (!hasHistoricalData || !trackerData.weeklyResults.some(wr => 
                        wr.firstPlace === results.firstPlace && 
                        wr.firstPlaceMoney === results.firstPlaceMoney
                    )) {
                        playerWins[results.firstPlace].first++;
                        playerWins[results.firstPlace].firstMoney += parseFloat(results.firstPlaceMoney) || 0;
                    }
                }
                if (results.secondPlace && results.secondPlaceMoney) {
                    if (!playerWins[results.secondPlace]) {
                        playerWins[results.secondPlace] = {
                            name: results.secondPlace,
                            first: 0, second: 0, third: 0, fourth: 0,
                            firstMoney: 0, secondMoney: 0, thirdMoney: 0, fourthMoney: 0
                        };
                    }
                    if (!hasHistoricalData || !trackerData.weeklyResults.some(wr => 
                        wr.secondPlace === results.secondPlace && 
                        wr.secondPlaceMoney === results.secondPlaceMoney
                    )) {
                        playerWins[results.secondPlace].second++;
                        playerWins[results.secondPlace].secondMoney += parseFloat(results.secondPlaceMoney) || 0;
                    }
                }
                if (results.thirdPlace && results.thirdPlaceMoney) {
                    if (!playerWins[results.thirdPlace]) {
                        playerWins[results.thirdPlace] = {
                            name: results.thirdPlace,
                            first: 0, second: 0, third: 0, fourth: 0,
                            firstMoney: 0, secondMoney: 0, thirdMoney: 0, fourthMoney: 0
                        };
                    }
                    if (!hasHistoricalData || !trackerData.weeklyResults.some(wr => 
                        wr.thirdPlace === results.thirdPlace && 
                        wr.thirdPlaceMoney === results.thirdPlaceMoney
                    )) {
                        playerWins[results.thirdPlace].third++;
                        playerWins[results.thirdPlace].thirdMoney += parseFloat(results.thirdPlaceMoney) || 0;
                    }
                }
                if (results.fourthPlace && results.fourthPlaceMoney) {
                    if (!playerWins[results.fourthPlace]) {
                        playerWins[results.fourthPlace] = {
                            name: results.fourthPlace,
                            first: 0, second: 0, third: 0, fourth: 0,
                            firstMoney: 0, secondMoney: 0, thirdMoney: 0, fourthMoney: 0
                        };
                    }
                    if (!hasHistoricalData || !trackerData.weeklyResults.some(wr => 
                        wr.fourthPlace === results.fourthPlace && 
                        wr.fourthPlaceMoney === results.fourthPlaceMoney
                    )) {
                        playerWins[results.fourthPlace].fourth++;
                        playerWins[results.fourthPlace].fourthMoney += parseFloat(results.fourthPlaceMoney) || 0;
                    }
                }
            }
            
            console.log('📊 Final position wins data:', playerWins);
            
            return Object.values(playerWins)
                .filter(player => player.first > 0 || player.second > 0 || player.third > 0 || player.fourth > 0) // Only show players with wins
                .sort((a, b) => (b.firstMoney + b.secondMoney + b.thirdMoney + b.fourthMoney) - 
                               (a.firstMoney + a.secondMoney + a.thirdMoney + a.fourthMoney));
        }
        
        // Update week performance table
        function updateWeekPerformanceTable() {
            const table = document.getElementById('weekPerformanceTable');
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            const performanceData = calculateWeekPerformance();
            
            tbody.innerHTML = '';
            performanceData.forEach(player => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${player.name}</td>
                    <td class="positive-value">${player.weeksWon.join(', ') || 'None'}</td>
                    <td class="positive-value">${player.bestWeek || 'N/A'}</td>
                    <td class="positive-value">${player.winRate.toFixed(1)}%</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Calculate week performance with actual dates
        function calculateWeekPerformance() {
            return trackerData.players.map(player => {
                const weeksWon = [];
                let totalWeeksPlayed = 0;
                let bestWeek = null;
                let bestScore = 0;
                
                // First check historical weekly results for wins
                if (trackerData.weeklyResults && trackerData.weeklyResults.length > 0) {
                    trackerData.weeklyResults.forEach(weekResult => {
                        const weekDate = formatDateForDisplay(weekResult.date);
                        
                        // Check if this player won any position this week
                        if (weekResult.firstPlace === player.name ||
                            weekResult.secondPlace === player.name ||
                            weekResult.thirdPlace === player.name ||
                            weekResult.fourthPlace === player.name) {
                            weeksWon.push(weekDate);
                        }
                    });
                }
                
                // Also check player's week data for participation and scores
                player.weeks.forEach((week, index) => {
                    if (week.invested && parseFloat(week.invested) > 0) {
                        totalWeeksPlayed++;
                    }
                    
                    // Add wins from player data if not already captured by historical results
                    if (week.prize && parseFloat(week.prize) > 0) {
                        const weekDate = trackerData.weeks[index] ? formatDateForDisplay(trackerData.weeks[index].date) : `Week ${index + 1}`;
                        if (!weeksWon.includes(weekDate)) {
                            weeksWon.push(weekDate);
                        }
                    }
                    
                    // Track best score with date
                    if (week.score && parseFloat(week.score) > bestScore) {
                        bestScore = parseFloat(week.score);
                        const weekDate = trackerData.weeks[index] ? formatDateForDisplay(trackerData.weeks[index].date) : `Week ${index + 1}`;
                        bestWeek = `${weekDate} (${bestScore})`;
                    }
                });
                
                // Remove duplicates and sort dates
                const uniqueWeeksWon = [...new Set(weeksWon)];
                uniqueWeeksWon.sort((a, b) => {
                    // Try to sort by date if possible
                    const dateA = new Date(a.split(' ')[1] + ' ' + a.split(' ')[0] + ' ' + new Date().getFullYear());
                    const dateB = new Date(b.split(' ')[1] + ' ' + b.split(' ')[0] + ' ' + new Date().getFullYear());
                    if (!isNaN(dateA) && !isNaN(dateB)) {
                        return dateA - dateB;
                    }
                    return a.localeCompare(b);
                });
                
                const winRate = totalWeeksPlayed > 0 ? (uniqueWeeksWon.length / totalWeeksPlayed) * 100 : 0;
                
                return {
                    name: player.name,
                    weeksWon: uniqueWeeksWon,
                    bestWeek,
                    winRate
                };
            }).sort((a, b) => b.winRate - a.winRate);
        }
        
        // Update financial analysis table
        function updateFinancialTable() {
            const table = document.getElementById('financialTable');
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            const financialData = calculateFinancialAnalysis();
            
            tbody.innerHTML = '';
            financialData.forEach(player => {
                const row = document.createElement('tr');
                const plClass = player.pl >= 0 ? 'positive-value' : 'negative-value';
                const roiClass = player.roi >= 0 ? 'positive-value' : 'negative-value';
                
                row.innerHTML = `
                    <td>${player.name}</td>
                    <td class="neutral-value">£${player.totalInvested.toFixed(2)}</td>
                    <td class="positive-value">£${player.totalPrizes.toFixed(2)}</td>
                    <td class="${plClass}">${player.pl >= 0 ? '+' : ''}£${player.pl.toFixed(2)}</td>
                    <td class="${roiClass}">${player.roi >= 0 ? '+' : ''}${player.roi.toFixed(1)}%</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Calculate financial analysis
        function calculateFinancialAnalysis() {
            return trackerData.players.map(player => {
                let totalInvested = 0;
                let totalPrizes = 0;
                
                player.weeks.forEach(week => {
                    totalInvested += parseFloat(week.invested) || 0;
                    totalPrizes += parseFloat(week.prize) || 0;
                });
                
                const pl = totalPrizes - totalInvested;
                const roi = totalInvested > 0 ? (pl / totalInvested) * 100 : 0;
                
                return {
                    name: player.name,
                    totalInvested,
                    totalPrizes,
                    pl,
                    roi
                };
            }).sort((a, b) => b.pl - a.pl);
        }
        
        // Update performance graph
        function updatePerformanceGraph() {
            const svg = document.getElementById('performanceSvg');
            if (!svg) return;
            
            const width = 800;
            const height = 350;
            const margin = { top: 20, right: 80, bottom: 50, left: 60 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;
            
            svg.innerHTML = ''; // Clear previous content
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            
            if (trackerData.weeks.length === 0) {
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', width / 2);
                text.setAttribute('y', height / 2);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('fill', '#a0aec0');
                text.setAttribute('font-size', '16');
                text.textContent = 'No data available for performance graph';
                svg.appendChild(text);
                return;
            }
            
            // Create chart background
            const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            bg.setAttribute('x', margin.left);
            bg.setAttribute('y', margin.top);
            bg.setAttribute('width', chartWidth);
            bg.setAttribute('height', chartHeight);
            bg.setAttribute('fill', '#1a202c');
            bg.setAttribute('stroke', '#4a5568');
            svg.appendChild(bg);
            
            // Draw axes
            drawAxes(svg, margin, chartWidth, chartHeight, width, height);
            
            // Draw player performance lines
            drawPlayerLines(svg, margin, chartWidth, chartHeight);
        }
        
        function drawAxes(svg, margin, chartWidth, chartHeight, width, height) {
            // X-axis (weeks)
            const xAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            xAxis.setAttribute('x1', margin.left);
            xAxis.setAttribute('y1', margin.top + chartHeight);
            xAxis.setAttribute('x2', margin.left + chartWidth);
            xAxis.setAttribute('y2', margin.top + chartHeight);
            xAxis.setAttribute('stroke', '#4a5568');
            svg.appendChild(xAxis);
            
            // Y-axis (cumulative P&L)
            const yAxis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            yAxis.setAttribute('x1', margin.left);
            yAxis.setAttribute('y1', margin.top);
            yAxis.setAttribute('x2', margin.left);
            yAxis.setAttribute('y2', margin.top + chartHeight);
            yAxis.setAttribute('stroke', '#4a5568');
            svg.appendChild(yAxis);
            
            // Week labels
            for (let i = 0; i < trackerData.weeks.length; i++) {
                const x = margin.left + (i / Math.max(trackerData.weeks.length - 1, 1)) * chartWidth;
                const weekLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                weekLabel.setAttribute('x', x);
                weekLabel.setAttribute('y', margin.top + chartHeight + 20);
                weekLabel.setAttribute('text-anchor', 'middle');
                weekLabel.setAttribute('fill', '#a0aec0');
                weekLabel.setAttribute('font-size', '12');
                weekLabel.textContent = `W${i + 1}`;
                svg.appendChild(weekLabel);
            }
            
            // Y-axis label
            const yLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            yLabel.setAttribute('x', 20);
            yLabel.setAttribute('y', margin.top + chartHeight / 2);
            yLabel.setAttribute('text-anchor', 'middle');
            yLabel.setAttribute('fill', '#a0aec0');
            yLabel.setAttribute('font-size', '12');
            yLabel.setAttribute('transform', `rotate(-90, 20, ${margin.top + chartHeight / 2})`);
            yLabel.textContent = 'Cumulative P&L (£)';
            svg.appendChild(yLabel);
        }
        
        function drawPlayerLines(svg, margin, chartWidth, chartHeight) {
            const colors = ['#4299e1', '#48bb78', '#f6e05e', '#ed8936', '#e53e3e', '#805ad5'];
            let maxPL = 0;
            let minPL = 0;
            
            // Calculate min/max for scaling
            trackerData.players.forEach(player => {
                let cumulativePL = 0;
                player.weeks.forEach(week => {
                    const invested = parseFloat(week.invested) || 0;
                    const prize = parseFloat(week.prize) || 0;
                    cumulativePL += (prize - invested);
                    maxPL = Math.max(maxPL, cumulativePL);
                    minPL = Math.min(minPL, cumulativePL);
                });
            });
            
            const range = Math.max(Math.abs(maxPL), Math.abs(minPL), 10); // Minimum range of 10
            
            // Draw zero line
            const zeroY = margin.top + chartHeight / 2;
            const zeroLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            zeroLine.setAttribute('x1', margin.left);
            zeroLine.setAttribute('y1', zeroY);
            zeroLine.setAttribute('x2', margin.left + chartWidth);
            zeroLine.setAttribute('y2', zeroY);
            zeroLine.setAttribute('stroke', '#4a5568');
            zeroLine.setAttribute('stroke-dasharray', '3,3');
            svg.appendChild(zeroLine);
            
            // Draw player lines
            trackerData.players.forEach((player, playerIndex) => {
                const color = colors[playerIndex % colors.length];
                let cumulativePL = 0;
                let pathData = '';
                
                player.weeks.forEach((week, weekIndex) => {
                    const invested = parseFloat(week.invested) || 0;
                    const prize = parseFloat(week.prize) || 0;
                    cumulativePL += (prize - invested);
                    
                    const x = margin.left + (weekIndex / Math.max(trackerData.weeks.length - 1, 1)) * chartWidth;
                    const y = zeroY - (cumulativePL / range) * (chartHeight / 2);
                    
                    if (weekIndex === 0) {
                        pathData += `M ${x} ${y}`;
                    } else {
                        pathData += ` L ${x} ${y}`;
                    }
                    
                    // Draw dot
                    const dot = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    dot.setAttribute('cx', x);
                    dot.setAttribute('cy', y);
                    dot.setAttribute('r', 3);
                    dot.setAttribute('fill', color);
                    dot.setAttribute('stroke', '#2d3748');
                    dot.setAttribute('stroke-width', 2);
                    svg.appendChild(dot);
                });
                
                if (pathData) {
                    const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', pathData);
                    path.setAttribute('stroke', color);
                    path.setAttribute('stroke-width', 2);
                    path.setAttribute('fill', 'none');
                    svg.appendChild(path);
                }
                
                // Legend
                const legendY = margin.top + 20 + (playerIndex * 20);
                const legendLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                legendLine.setAttribute('x1', margin.left + chartWidth + 10);
                legendLine.setAttribute('y1', legendY);
                legendLine.setAttribute('x2', margin.left + chartWidth + 30);
                legendLine.setAttribute('y2', legendY);
                legendLine.setAttribute('stroke', color);
                legendLine.setAttribute('stroke-width', 2);
                svg.appendChild(legendLine);
                
                const legendText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                legendText.setAttribute('x', margin.left + chartWidth + 35);
                legendText.setAttribute('y', legendY + 4);
                legendText.setAttribute('fill', '#edf2f7');
                legendText.setAttribute('font-size', '12');
                legendText.textContent = player.name;
                svg.appendChild(legendText);
            });
        }
        
        // Track sort state for each analytics table
        const analyticsSortState = {};
        
        // Sort analytics table with enhanced functionality
        function sortAnalyticsTable(tableId, columnIndex) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const headers = table.querySelectorAll('thead th');
            
            if (rows.length === 0) return;
            
            // Initialize or update sort state for this table
            if (!analyticsSortState[tableId]) {
                analyticsSortState[tableId] = { column: -1, direction: 'asc' };
            }
            
            const sortState = analyticsSortState[tableId];
            
            // Determine new sort direction
            if (sortState.column === columnIndex) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = columnIndex;
                sortState.direction = 'asc';
            }
            
            // Reset all header classes and indicators
            headers.forEach((header, index) => {
                header.classList.remove('sorted-asc', 'sorted-desc');
                const indicator = header.querySelector('.sort-indicator');
                if (indicator) {
                    indicator.textContent = '↕';
                }
            });
            
            // Update active header
            const activeHeader = headers[columnIndex];
            const activeIndicator = activeHeader.querySelector('.sort-indicator');
            if (sortState.direction === 'asc') {
                activeHeader.classList.add('sorted-asc');
                if (activeIndicator) activeIndicator.textContent = '↑';
            } else {
                activeHeader.classList.add('sorted-desc');
                if (activeIndicator) activeIndicator.textContent = '↓';
            }
            
            // Determine if column contains numeric data
            const sampleText = rows[0].cells[columnIndex].textContent.trim();
            const isNumeric = !isNaN(parseFloat(sampleText.replace(/[^\d.-]/g, ''))) && 
                              sampleText.replace(/[^\d.-]/g, '').length > 0;
            
            // Special handling for specific column types
            const isPercentage = sampleText.includes('%');
            const isCurrency = sampleText.includes('£') || sampleText.includes('$');
            const isWeeksList = columnIndex === 1 && tableId === 'weekPerformanceTable'; // "Weeks Won" column
            
            rows.sort((a, b) => {
                let aVal = a.cells[columnIndex].textContent.trim();
                let bVal = b.cells[columnIndex].textContent.trim();
                let result = 0;
                
                if (isWeeksList) {
                    // Special handling for "Dates Won" column - sort by count of dates
                    const aCount = aVal === 'None' ? 0 : (aVal.split(',').length);
                    const bCount = bVal === 'None' ? 0 : (bVal.split(',').length);
                    result = aCount - bCount;
                } else if (isNumeric || isPercentage || isCurrency) {
                    // Handle numeric values (including currency and percentages)
                    const aNum = parseFloat(aVal.replace(/[^\d.-]/g, '')) || 0;
                    const bNum = parseFloat(bVal.replace(/[^\d.-]/g, '')) || 0;
                    result = aNum - bNum;
                } else {
                    // Text sorting
                    result = aVal.localeCompare(bVal, undefined, { numeric: true, sensitivity: 'base' });
                }
                
                // Apply sort direction
                return sortState.direction === 'asc' ? result : -result;
            });
            
            // Update table with sorted rows
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
            
            // Show sorting feedback
            const columnName = headers[columnIndex].textContent.replace(/[\u2191\u2193\u2195]/g, '').trim();
            const directionText = sortState.direction === 'asc' ? 'ascending' : 'descending';
            console.log(`Analytics table sorted by ${columnName} (${directionText})`);
        }
        
        // Function to save current week's results to historical data
        function saveWeeklyResults() {
            const results = trackerData.results;
            
            // Check if current week has any results
            if (!results.firstPlace && !results.secondPlace && !results.thirdPlace && !results.fourthPlace) {
                console.log('No results to save for current week');
                return false;
            }
            
            // Initialize weeklyResults array if it doesn't exist
            if (!trackerData.weeklyResults) {
                trackerData.weeklyResults = [];
            }
            
            // Create weekly result record
            const weeklyResult = {
                weekNumber: trackerData.weeks.length,
                date: trackerData.weeks.length > 0 ? trackerData.weeks[trackerData.weeks.length - 1].date : new Date().toISOString().split('T')[0],
                firstPlace: results.firstPlace || '',
                firstPlaceMoney: results.firstPlaceMoney || '',
                secondPlace: results.secondPlace || '',
                secondPlaceMoney: results.secondPlaceMoney || '',
                thirdPlace: results.thirdPlace || '',
                thirdPlaceMoney: results.thirdPlaceMoney || '',
                fourthPlace: results.fourthPlace || '',
                fourthPlaceMoney: results.fourthPlaceMoney || '',
                timestamp: new Date().toISOString()
            };
            
            // Check if results for this week already exist
            const existingIndex = trackerData.weeklyResults.findIndex(wr => 
                wr.weekNumber === weeklyResult.weekNumber || 
                wr.date === weeklyResult.date
            );
            
            if (existingIndex >= 0) {
                // Update existing record
                trackerData.weeklyResults[existingIndex] = weeklyResult;
                console.log(`Updated results for Week ${weeklyResult.weekNumber}`);
            } else {
                // Add new record
                trackerData.weeklyResults.push(weeklyResult);
                console.log(`Saved new results for Week ${weeklyResult.weekNumber}`);
            }
            
            saveDataToStorage();
            return true;
        }
        
        // Auto-save weekly results when results are entered
        function autoSaveWeeklyResults() {
            // Delay to ensure all inputs are processed
            setTimeout(() => {
                saveWeeklyResults();
                // Refresh analytics if on analytics tab
                const analyticsTab = document.getElementById('analytics-tab');
                if (analyticsTab && analyticsTab.classList.contains('active')) {
                    refreshAnalytics();
                }
            }, 100);
        }
        
        // Clear all weekly results history (for fresh start or testing)
        function clearWeeklyResultsHistory() {
            if (confirm('Are you sure you want to clear ALL weekly results history?\n\nThis will remove all historical position wins data and cannot be undone.')) {
                trackerData.weeklyResults = [];
                saveDataToStorage();
                
                // Refresh analytics if visible
                const analyticsTab = document.getElementById('analytics-tab');
                if (analyticsTab && analyticsTab.classList.contains('active')) {
                    refreshAnalytics();
                }
                
                showStatusMessage('Weekly results history cleared', 'success');
                console.log('📊 Weekly results history cleared');
            }
        }
        
        // Reconstruct historical weekly results from all existing data
        function reconstructHistoricalResults() {
            console.log('🔄 Reconstructing historical weekly results...');
            
            if (!trackerData.weeklyResults) {
                trackerData.weeklyResults = [];
            }
            
            // Strategy: Look through all weeks and try to find position winners based on:
            // 1. Prize money in player week data
            // 2. Current results if it's the latest week
            
            const reconstructedResults = [];
            
            // Process each week
            trackerData.weeks.forEach((week, weekIndex) => {
                console.log(`🔍 Processing Week ${weekIndex + 1} (${week.date})`);
                
                // Find players who won money this week
                const weekWinners = [];
                
                trackerData.players.forEach(player => {
                    if (player.weeks && player.weeks[weekIndex]) {
                        const weekData = player.weeks[weekIndex];
                        const prize = parseFloat(weekData.prize) || 0;
                        
                        if (prize > 0) {
                            weekWinners.push({
                                name: player.name,
                                prize: prize,
                                score: parseFloat(weekData.score) || 0
                            });
                        }
                    }
                });
                
                if (weekWinners.length > 0) {
                    // Sort by prize amount (highest first) to determine positions
                    weekWinners.sort((a, b) => b.prize - a.prize);
                    
                    console.log(`🏆 Week ${weekIndex + 1} winners:`, weekWinners);
                    
                    const weekResult = {
                        weekNumber: weekIndex + 1,
                        date: week.date,
                        firstPlace: weekWinners[0] ? weekWinners[0].name : '',
                        firstPlaceMoney: weekWinners[0] ? weekWinners[0].prize.toFixed(2) : '',
                        secondPlace: weekWinners[1] ? weekWinners[1].name : '',
                        secondPlaceMoney: weekWinners[1] ? weekWinners[1].prize.toFixed(2) : '',
                        thirdPlace: weekWinners[2] ? weekWinners[2].name : '',
                        thirdPlaceMoney: weekWinners[2] ? weekWinners[2].prize.toFixed(2) : '',
                        fourthPlace: weekWinners[3] ? weekWinners[3].name : '',
                        fourthPlaceMoney: weekWinners[3] ? weekWinners[3].prize.toFixed(2) : '',
                        timestamp: new Date().toISOString(),
                        reconstructed: true
                    };
                    
                    reconstructedResults.push(weekResult);
                }
            });
            
            // Add current week results if not already captured
            const currentResults = trackerData.results;
            const currentWeekIndex = trackerData.weeks.length;
            
            if (currentResults && (currentResults.firstPlace || currentResults.secondPlace || currentResults.thirdPlace || currentResults.fourthPlace)) {
                const currentWeekResult = {
                    weekNumber: currentWeekIndex,
                    date: trackerData.weeks.length > 0 ? trackerData.weeks[trackerData.weeks.length - 1].date : new Date().toISOString().split('T')[0],
                    firstPlace: currentResults.firstPlace || '',
                    firstPlaceMoney: currentResults.firstPlaceMoney || '',
                    secondPlace: currentResults.secondPlace || '',
                    secondPlaceMoney: currentResults.secondPlaceMoney || '',
                    thirdPlace: currentResults.thirdPlace || '',
                    thirdPlaceMoney: currentResults.thirdPlaceMoney || '',
                    fourthPlace: currentResults.fourthPlace || '',
                    fourthPlaceMoney: currentResults.fourthPlaceMoney || '',
                    timestamp: new Date().toISOString(),
                    current: true
                };
                
                reconstructedResults.push(currentWeekResult);
            }
            
            // Replace weeklyResults with reconstructed data
            trackerData.weeklyResults = reconstructedResults;
            saveDataToStorage();
            
            console.log(`✅ Reconstructed ${reconstructedResults.length} weeks of historical results`);
            showStatusMessage(`Reconstructed ${reconstructedResults.length} weeks of historical data`, 'success');
            
            // Refresh analytics
            const analyticsTab = document.getElementById('analytics-tab');
            if (analyticsTab && analyticsTab.classList.contains('active')) {
                refreshAnalytics();
            }
            
            return reconstructedResults;
        }
        
        // Theme System
        const themes = {
            'Dark Ocean': {
                '--color-bg-primary': '#0f172a',
                '--color-bg-secondary': '#1e293b',
                '--color-bg-container': '#334155',
                '--color-bg-app': '#0f172a',
                '--color-bg-sidebar': '#1e293b',
                '--color-bg-input': '#1e293b',
                '--color-text-primary': '#f1f5f9',
                '--color-text-secondary': '#cbd5e1',
                '--color-text-muted': '#94a3b8',
                '--color-accent-primary': '#0ea5e9',
                '--color-accent-secondary': '#0284c7',
                '--color-success': '#10b981',
                '--color-warning': '#f59e0b',
                '--color-error': '#ef4444',
                '--color-btn-primary': '#0ea5e9',
                '--color-btn-primary-hover': '#0284c7',
                '--color-btn-success': '#10b981',
                '--color-btn-warning': '#f59e0b',
                '--color-btn-danger': '#ef4444',
                '--color-btn-purple': '#8b5cf6',
                '--color-btn-purple-hover': '#7c3aed',
                '--color-btn-orange': '#f97316',
                '--color-border': '#475569',
                '--color-border-light': '#64748b',
                '--color-divider': '#475569',
                '--color-table-header': '#334155',
                '--color-table-row-odd': '#334155',
                '--color-table-row-even': '#1e293b',
                '--color-table-hover': '#3f4e63',
                '--color-fixed-column-bg': '#334155',
                '--color-modal-backdrop': 'rgba(0, 0, 0, 0.8)',
                '--color-modal-bg': '#334155',
                '--color-shadow': 'rgba(0, 0, 0, 0.3)',
                '--color-shadow-heavy': 'rgba(0, 0, 0, 0.5)',
                '--color-header-start': '#1e293b',
                '--color-header-end': '#0f172a'
            },
            'Light Ocean': {
                '--color-bg-primary': '#f0f9ff',
                '--color-bg-secondary': '#e0f2fe',
                '--color-bg-container': '#bae6fd',
                '--color-bg-app': '#f0f9ff',
                '--color-bg-sidebar': '#e0f2fe',
                '--color-bg-input': '#ffffff',
                '--color-text-primary': '#0c4a6e',
                '--color-text-secondary': '#0369a1',
                '--color-text-muted': '#0284c7',
                '--color-accent-primary': '#0ea5e9',
                '--color-accent-secondary': '#0284c7',
                '--color-success': '#059669',
                '--color-warning': '#d97706',
                '--color-error': '#dc2626',
                '--color-btn-primary': '#0ea5e9',
                '--color-btn-primary-hover': '#0284c7',
                '--color-btn-success': '#059669',
                '--color-btn-warning': '#d97706',
                '--color-btn-danger': '#dc2626',
                '--color-btn-purple': '#7c3aed',
                '--color-btn-purple-hover': '#6d28d9',
                '--color-btn-orange': '#ea580c',
                '--color-border': '#7dd3fc',
                '--color-border-light': '#38bdf8',
                '--color-divider': '#7dd3fc',
                '--color-table-header': '#bae6fd',
                '--color-table-row-odd': '#bae6fd',
                '--color-table-row-even': '#e0f2fe',
                '--color-table-hover': '#7dd3fc',
                '--color-fixed-column-bg': '#bae6fd',
                '--color-modal-backdrop': 'rgba(0, 0, 0, 0.5)',
                '--color-modal-bg': '#bae6fd',
                '--color-shadow': 'rgba(0, 0, 0, 0.1)',
                '--color-shadow-heavy': 'rgba(0, 0, 0, 0.2)',
                '--color-header-start': '#e0f2fe',
                '--color-header-end': '#f0f9ff'
            },
            'Royal Purple': {
                '--color-bg-primary': '#1a1625',
                '--color-bg-secondary': '#2d2438',
                '--color-bg-container': '#44337a',
                '--color-bg-app': '#1a1625',
                '--color-bg-sidebar': '#2d2438',
                '--color-bg-input': '#2d2438',
                '--color-text-primary': '#f7fafc',
                '--color-text-secondary': '#e2e8f0',
                '--color-text-muted': '#cbd5e1',
                '--color-accent-primary': '#9f7aea',
                '--color-accent-secondary': '#805ad5',
                '--color-success': '#68d391',
                '--color-warning': '#f6e05e',
                '--color-error': '#fc8181',
                '--color-btn-primary': '#9f7aea',
                '--color-btn-primary-hover': '#805ad5',
                '--color-btn-success': '#68d391',
                '--color-btn-warning': '#f6e05e',
                '--color-btn-danger': '#fc8181',
                '--color-btn-purple': '#9f7aea',
                '--color-btn-purple-hover': '#805ad5',
                '--color-btn-orange': '#ed8936',
                '--color-border': '#553c9a',
                '--color-border-light': '#6d4cae',
                '--color-divider': '#553c9a',
                '--color-table-header': '#44337a',
                '--color-table-row-odd': '#44337a',
                '--color-table-row-even': '#2d2438',
                '--color-table-hover': '#553c9a',
                '--color-fixed-column-bg': '#44337a',
                '--color-modal-backdrop': 'rgba(0, 0, 0, 0.8)',
                '--color-modal-bg': '#44337a',
                '--color-shadow': 'rgba(0, 0, 0, 0.3)',
                '--color-shadow-heavy': 'rgba(0, 0, 0, 0.5)',
                '--color-header-start': '#2d2438',
                '--color-header-end': '#1a1625'
            },
            'Light Green': {
                '--color-bg-primary': '#f0fdf4',
                '--color-bg-secondary': '#dcfce7',
                '--color-bg-container': '#bbf7d0',
                '--color-bg-app': '#f0fdf4',
                '--color-bg-sidebar': '#dcfce7',
                '--color-bg-input': '#ffffff',
                '--color-text-primary': '#14532d',
                '--color-text-secondary': '#166534',
                '--color-text-muted': '#15803d',
                '--color-accent-primary': '#16a34a',
                '--color-accent-secondary': '#15803d',
                '--color-success': '#22c55e',
                '--color-warning': '#d97706',
                '--color-error': '#dc2626',
                '--color-btn-primary': '#16a34a',
                '--color-btn-primary-hover': '#15803d',
                '--color-btn-success': '#22c55e',
                '--color-btn-warning': '#d97706',
                '--color-btn-danger': '#dc2626',
                '--color-btn-purple': '#7c3aed',
                '--color-btn-purple-hover': '#6d28d9',
                '--color-btn-orange': '#ea580c',
                '--color-border': '#86efac',
                '--color-border-light': '#4ade80',
                '--color-divider': '#86efac',
                '--color-table-header': '#bbf7d0',
                '--color-table-row-odd': '#bbf7d0',
                '--color-table-row-even': '#dcfce7',
                '--color-table-hover': '#86efac',
                '--color-fixed-column-bg': '#bbf7d0',
                '--color-modal-backdrop': 'rgba(0, 0, 0, 0.5)',
                '--color-modal-bg': '#bbf7d0',
                '--color-shadow': 'rgba(0, 0, 0, 0.1)',
                '--color-shadow-heavy': 'rgba(0, 0, 0, 0.2)',
                '--color-header-start': '#dcfce7',
                '--color-header-end': '#f0fdf4'
            },
            'Arctic Blue': {
                '--color-bg-primary': '#0c1420',
                '--color-bg-secondary': '#1a2332',
                '--color-bg-container': '#2d3748',
                '--color-bg-app': '#0c1420',
                '--color-bg-sidebar': '#1a2332',
                '--color-bg-input': '#1a2332',
                '--color-text-primary': '#f0f9ff',
                '--color-text-secondary': '#bae6fd',
                '--color-text-muted': '#7dd3fc',
                '--color-accent-primary': '#0ea5e9',
                '--color-accent-secondary': '#0284c7',
                '--color-success': '#22d3ee',
                '--color-warning': '#fbbf24',
                '--color-error': '#f87171',
                '--color-btn-primary': '#0ea5e9',
                '--color-btn-primary-hover': '#0284c7',
                '--color-btn-success': '#22d3ee',
                '--color-btn-warning': '#fbbf24',
                '--color-btn-danger': '#f87171',
                '--color-btn-purple': '#8b5cf6',
                '--color-btn-purple-hover': '#7c3aed',
                '--color-btn-orange': '#f97316',
                '--color-border': '#075985',
                '--color-border-light': '#0891b2',
                '--color-divider': '#075985',
                '--color-table-header': '#2d3748',
                '--color-table-row-odd': '#2d3748',
                '--color-table-row-even': '#1a2332',
                '--color-table-hover': '#374151',
                '--color-fixed-column-bg': '#2d3748',
                '--color-modal-backdrop': 'rgba(0, 0, 0, 0.8)',
                '--color-modal-bg': '#2d3748',
                '--color-shadow': 'rgba(0, 0, 0, 0.3)',
                '--color-shadow-heavy': 'rgba(0, 0, 0, 0.5)',
                '--color-header-start': '#1a2332',
                '--color-header-end': '#0c1420'
            },
            'Emerald City': {
                '--color-bg-primary': '#022c22',
                '--color-bg-secondary': '#064e3b',
                '--color-bg-container': '#065f46',
                '--color-bg-app': '#022c22',
                '--color-bg-sidebar': '#064e3b',
                '--color-bg-input': '#064e3b',
                '--color-text-primary': '#ecfdf5',
                '--color-text-secondary': '#d1fae5',
                '--color-text-muted': '#a7f3d0',
                '--color-accent-primary': '#10b981',
                '--color-accent-secondary': '#059669',
                '--color-success': '#34d399',
                '--color-warning': '#fbbf24',
                '--color-error': '#f87171',
                '--color-btn-primary': '#10b981',
                '--color-btn-primary-hover': '#059669',
                '--color-btn-success': '#34d399',
                '--color-btn-warning': '#fbbf24',
                '--color-btn-danger': '#f87171',
                '--color-btn-purple': '#8b5cf6',
                '--color-btn-purple-hover': '#7c3aed',
                '--color-btn-orange': '#f97316',
                '--color-border': '#047857',
                '--color-border-light': '#059669',
                '--color-divider': '#047857',
                '--color-table-header': '#065f46',
                '--color-table-row-odd': '#065f46',
                '--color-table-row-even': '#064e3b',
                '--color-table-hover': '#047857',
                '--color-fixed-column-bg': '#065f46',
                '--color-modal-backdrop': 'rgba(0, 0, 0, 0.8)',
                '--color-modal-bg': '#065f46',
                '--color-shadow': 'rgba(0, 0, 0, 0.3)',
                '--color-shadow-heavy': 'rgba(0, 0, 0, 0.5)',
                '--color-header-start': '#064e3b',
                '--color-header-end': '#022c22'
            },
            'Warm Cream': {
                '--color-bg-primary': '#fffbeb',
                '--color-bg-secondary': '#fef3c7',
                '--color-bg-container': '#fde68a',
                '--color-bg-app': '#fffbeb',
                '--color-bg-sidebar': '#fef3c7',
                '--color-bg-input': '#ffffff',
                '--color-text-primary': '#92400e',
                '--color-text-secondary': '#b45309',
                '--color-text-muted': '#d97706',
                '--color-accent-primary': '#f59e0b',
                '--color-accent-secondary': '#d97706',
                '--color-success': '#059669',
                '--color-warning': '#dc2626',
                '--color-error': '#dc2626',
                '--color-btn-primary': '#f59e0b',
                '--color-btn-primary-hover': '#d97706',
                '--color-btn-success': '#059669',
                '--color-btn-warning': '#dc2626',
                '--color-btn-danger': '#dc2626',
                '--color-btn-purple': '#7c3aed',
                '--color-btn-purple-hover': '#6d28d9',
                '--color-btn-orange': '#ea580c',
                '--color-border': '#fed7aa',
                '--color-border-light': '#fdba74',
                '--color-divider': '#fed7aa',
                '--color-table-header': '#fde68a',
                '--color-table-row-odd': '#fde68a',
                '--color-table-row-even': '#fef3c7',
                '--color-table-hover': '#fed7aa',
                '--color-fixed-column-bg': '#fde68a',
                '--color-modal-backdrop': 'rgba(0, 0, 0, 0.5)',
                '--color-modal-bg': '#fde68a',
                '--color-shadow': 'rgba(0, 0, 0, 0.1)',
                '--color-shadow-heavy': 'rgba(0, 0, 0, 0.2)',
                '--color-header-start': '#fef3c7',
                '--color-header-end': '#fffbeb'
            },
            'Light Purple': {
                '--color-bg-primary': '#faf5ff',
                '--color-bg-secondary': '#f3e8ff',
                '--color-bg-container': '#ddd6fe',
                '--color-bg-app': '#faf5ff',
                '--color-bg-sidebar': '#f3e8ff',
                '--color-bg-input': '#ffffff',
                '--color-text-primary': '#581c87',
                '--color-text-secondary': '#6b21a8',
                '--color-text-muted': '#7c3aed',
                '--color-accent-primary': '#8b5cf6',
                '--color-accent-secondary': '#7c3aed',
                '--color-success': '#059669',
                '--color-warning': '#d97706',
                '--color-error': '#dc2626',
                '--color-btn-primary': '#8b5cf6',
                '--color-btn-primary-hover': '#7c3aed',
                '--color-btn-success': '#059669',
                '--color-btn-warning': '#d97706',
                '--color-btn-danger': '#dc2626',
                '--color-btn-purple': '#8b5cf6',
                '--color-btn-purple-hover': '#7c3aed',
                '--color-btn-orange': '#ea580c',
                '--color-border': '#c4b5fd',
                '--color-border-light': '#a78bfa',
                '--color-divider': '#c4b5fd',
                '--color-table-header': '#ddd6fe',
                '--color-table-row-odd': '#ddd6fe',
                '--color-table-row-even': '#f3e8ff',
                '--color-table-hover': '#c4b5fd',
                '--color-fixed-column-bg': '#ddd6fe',
                '--color-modal-backdrop': 'rgba(0, 0, 0, 0.5)',
                '--color-modal-bg': '#ddd6fe',
                '--color-shadow': 'rgba(0, 0, 0, 0.1)',
                '--color-shadow-heavy': 'rgba(0, 0, 0, 0.2)',
                '--color-header-start': '#f3e8ff',
                '--color-header-end': '#faf5ff'
            },
            'Light Gray': {
                '--color-bg-primary': '#f9fafb',
                '--color-bg-secondary': '#f3f4f6',
                '--color-bg-container': '#e5e7eb',
                '--color-bg-app': '#f9fafb',
                '--color-bg-sidebar': '#f3f4f6',
                '--color-bg-input': '#ffffff',
                '--color-text-primary': '#374151',
                '--color-text-secondary': '#4b5563',
                '--color-text-muted': '#6b7280',
                '--color-accent-primary': '#6366f1',
                '--color-accent-secondary': '#4f46e5',
                '--color-success': '#059669',
                '--color-warning': '#d97706',
                '--color-error': '#dc2626',
                '--color-btn-primary': '#6366f1',
                '--color-btn-primary-hover': '#4f46e5',
                '--color-btn-success': '#059669',
                '--color-btn-warning': '#d97706',
                '--color-btn-danger': '#dc2626',
                '--color-btn-purple': '#8b5cf6',
                '--color-btn-purple-hover': '#7c3aed',
                '--color-btn-orange': '#ea580c',
                '--color-border': '#d1d5db',
                '--color-border-light': '#9ca3af',
                '--color-divider': '#d1d5db',
                '--color-table-header': '#e5e7eb',
                '--color-table-row-odd': '#e5e7eb',
                '--color-table-row-even': '#f3f4f6',
                '--color-table-hover': '#d1d5db',
                '--color-fixed-column-bg': '#e5e7eb',
                '--color-modal-backdrop': 'rgba(0, 0, 0, 0.5)',
                '--color-modal-bg': '#e5e7eb',
                '--color-shadow': 'rgba(0, 0, 0, 0.1)',
                '--color-shadow-heavy': 'rgba(0, 0, 0, 0.2)',
                '--color-header-start': '#f3f4f6',
                '--color-header-end': '#f9fafb'
            },
            'Midnight Blue': {
                '--color-bg-primary': '#0c0a1f',
                '--color-bg-secondary': '#1e1b3a',
                '--color-bg-container': '#312e81',
                '--color-bg-app': '#0c0a1f',
                '--color-bg-sidebar': '#1e1b3a',
                '--color-bg-input': '#1e1b3a',
                '--color-text-primary': '#e0e7ff',
                '--color-text-secondary': '#c7d2fe',
                '--color-text-muted': '#a5b4fc',
                '--color-accent-primary': '#6366f1',
                '--color-accent-secondary': '#4f46e5',
                '--color-success': '#22c55e',
                '--color-warning': '#eab308',
                '--color-error': '#ef4444',
                '--color-btn-primary': '#6366f1',
                '--color-btn-primary-hover': '#4f46e5',
                '--color-btn-success': '#22c55e',
                '--color-btn-warning': '#eab308',
                '--color-btn-danger': '#ef4444',
                '--color-btn-purple': '#6366f1',
                '--color-btn-purple-hover': '#4f46e5',
                '--color-btn-orange': '#f97316',
                '--color-border': '#3730a3',
                '--color-border-light': '#4f46e5',
                '--color-divider': '#3730a3',
                '--color-table-header': '#312e81',
                '--color-table-row-odd': '#312e81',
                '--color-table-row-even': '#1e1b3a',
                '--color-table-hover': '#3730a3',
                '--color-fixed-column-bg': '#312e81',
                '--color-modal-backdrop': 'rgba(0, 0, 0, 0.8)',
                '--color-modal-bg': '#312e81',
                '--color-shadow': 'rgba(0, 0, 0, 0.3)',
                '--color-shadow-heavy': 'rgba(0, 0, 0, 0.5)',
                '--color-header-start': '#1e1b3a',
                '--color-header-end': '#0c0a1f'
            },
            'Sunset Orange': {
                '--color-bg-primary': '#1a0d08',
                '--color-bg-secondary': '#2d1b12',
                '--color-bg-container': '#c2410c',
                '--color-bg-app': '#1a0d08',
                '--color-bg-sidebar': '#2d1b12',
                '--color-bg-input': '#2d1b12',
                '--color-text-primary': '#fed7aa',
                '--color-text-secondary': '#fdba74',
                '--color-text-muted': '#fb923c',
                '--color-accent-primary': '#ea580c',
                '--color-accent-secondary': '#dc2626',
                '--color-success': '#16a34a',
                '--color-warning': '#eab308',
                '--color-error': '#dc2626',
                '--color-btn-primary': '#ea580c',
                '--color-btn-primary-hover': '#dc2626',
                '--color-btn-success': '#16a34a',
                '--color-btn-warning': '#eab308',
                '--color-btn-danger': '#dc2626',
                '--color-btn-purple': '#8b5cf6',
                '--color-btn-purple-hover': '#7c3aed',
                '--color-btn-orange': '#ea580c',
                '--color-border': '#9a3412',
                '--color-border-light': '#c2410c',
                '--color-divider': '#9a3412',
                '--color-table-header': '#c2410c',
                '--color-table-row-odd': '#c2410c',
                '--color-table-row-even': '#2d1b12',
                '--color-table-hover': '#9a3412',
                '--color-fixed-column-bg': '#c2410c',
                '--color-modal-backdrop': 'rgba(0, 0, 0, 0.8)',
                '--color-modal-bg': '#c2410c',
                '--color-shadow': 'rgba(0, 0, 0, 0.3)',
                '--color-shadow-heavy': 'rgba(0, 0, 0, 0.5)',
                '--color-header-start': '#2d1b12',
                '--color-header-end': '#1a0d08'
            },
            'Light Coral': {
                '--color-bg-primary': '#fff5f5',
                '--color-bg-secondary': '#fed7d7',
                '--color-bg-container': '#fbb6ce',
                '--color-bg-app': '#fff5f5',
                '--color-bg-sidebar': '#fed7d7',
                '--color-bg-input': '#ffffff',
                '--color-text-primary': '#7b1113',
                '--color-text-secondary': '#991b1b',
                '--color-text-muted': '#b91c1c',
                '--color-accent-primary': '#e11d48',
                '--color-accent-secondary': '#be123c',
                '--color-success': '#059669',
                '--color-warning': '#d97706',
                '--color-error': '#dc2626',
                '--color-btn-primary': '#e11d48',
                '--color-btn-primary-hover': '#be123c',
                '--color-btn-success': '#059669',
                '--color-btn-warning': '#d97706',
                '--color-btn-danger': '#dc2626',
                '--color-btn-purple': '#7c3aed',
                '--color-btn-purple-hover': '#6d28d9',
                '--color-btn-orange': '#ea580c',
                '--color-border': '#f9a8d4',
                '--color-border-light': '#f472b6',
                '--color-divider': '#f9a8d4',
                '--color-table-header': '#fbb6ce',
                '--color-table-row-odd': '#fbb6ce',
                '--color-table-row-even': '#fed7d7',
                '--color-table-hover': '#f9a8d4',
                '--color-fixed-column-bg': '#fbb6ce',
                '--color-modal-backdrop': 'rgba(0, 0, 0, 0.5)',
                '--color-modal-bg': '#fbb6ce',
                '--color-shadow': 'rgba(0, 0, 0, 0.1)',
                '--color-shadow-heavy': 'rgba(0, 0, 0, 0.2)',
                '--color-header-start': '#fed7d7',
                '--color-header-end': '#fff5f5'
            },
            'Deep Forest': {
                '--color-bg-primary': '#0f1419',
                '--color-bg-secondary': '#1c2e1f',
                '--color-bg-container': '#1f2937',
                '--color-bg-app': '#0f1419',
                '--color-bg-sidebar': '#1c2e1f',
                '--color-bg-input': '#1c2e1f',
                '--color-text-primary': '#d1fae5',
                '--color-text-secondary': '#a7f3d0',
                '--color-text-muted': '#6ee7b7',
                '--color-accent-primary': '#34d399',
                '--color-accent-secondary': '#10b981',
                '--color-success': '#22c55e',
                '--color-warning': '#f59e0b',
                '--color-error': '#ef4444',
                '--color-btn-primary': '#34d399',
                '--color-btn-primary-hover': '#10b981',
                '--color-btn-success': '#22c55e',
                '--color-btn-warning': '#f59e0b',
                '--color-btn-danger': '#ef4444',
                '--color-btn-purple': '#8b5cf6',
                '--color-btn-purple-hover': '#7c3aed',
                '--color-btn-orange': '#f97316',
                '--color-border': '#374151',
                '--color-border-light': '#4b5563',
                '--color-divider': '#374151',
                '--color-table-header': '#1f2937',
                '--color-table-row-odd': '#1f2937',
                '--color-table-row-even': '#1c2e1f',
                '--color-table-hover': '#374151',
                '--color-fixed-column-bg': '#1f2937',
                '--color-modal-backdrop': 'rgba(0, 0, 0, 0.8)',
                '--color-modal-bg': '#1f2937',
                '--color-shadow': 'rgba(0, 0, 0, 0.3)',
                '--color-shadow-heavy': 'rgba(0, 0, 0, 0.5)',
                '--color-header-start': '#1c2e1f',
                '--color-header-end': '#0f1419'
            },
            'Light Mint': {
                '--color-bg-primary': '#f0fdfa',
                '--color-bg-secondary': '#ccfbf1',
                '--color-bg-container': '#99f6e4',
                '--color-bg-app': '#f0fdfa',
                '--color-bg-sidebar': '#ccfbf1',
                '--color-bg-input': '#ffffff',
                '--color-text-primary': '#134e4a',
                '--color-text-secondary': '#115e59',
                '--color-text-muted': '#0f766e',
                '--color-accent-primary': '#14b8a6',
                '--color-accent-secondary': '#0d9488',
                '--color-success': '#059669',
                '--color-warning': '#d97706',
                '--color-error': '#dc2626',
                '--color-btn-primary': '#14b8a6',
                '--color-btn-primary-hover': '#0d9488',
                '--color-btn-success': '#059669',
                '--color-btn-warning': '#d97706',
                '--color-btn-danger': '#dc2626',
                '--color-btn-purple': '#7c3aed',
                '--color-btn-purple-hover': '#6d28d9',
                '--color-btn-orange': '#ea580c',
                '--color-border': '#5eead4',
                '--color-border-light': '#2dd4bf',
                '--color-divider': '#5eead4',
                '--color-table-header': '#99f6e4',
                '--color-table-row-odd': '#99f6e4',
                '--color-table-row-even': '#ccfbf1',
                '--color-table-hover': '#5eead4',
                '--color-fixed-column-bg': '#99f6e4',
                '--color-modal-backdrop': 'rgba(0, 0, 0, 0.5)',
                '--color-modal-bg': '#99f6e4',
                '--color-shadow': 'rgba(0, 0, 0, 0.1)',
                '--color-shadow-heavy': 'rgba(0, 0, 0, 0.2)',
                '--color-header-start': '#ccfbf1',
                '--color-header-end': '#f0fdfa'
            },
            'Crimson Steel': {
                '--color-bg-primary': '#1c1917',
                '--color-bg-secondary': '#292524',
                '--color-bg-container': '#44403c',
                '--color-bg-app': '#1c1917',
                '--color-bg-sidebar': '#292524',
                '--color-bg-input': '#292524',
                '--color-text-primary': '#fecaca',
                '--color-text-secondary': '#fca5a5',
                '--color-text-muted': '#f87171',
                '--color-accent-primary': '#dc2626',
                '--color-accent-secondary': '#b91c1c',
                '--color-success': '#16a34a',
                '--color-warning': '#eab308',
                '--color-error': '#ef4444',
                '--color-btn-primary': '#dc2626',
                '--color-btn-primary-hover': '#b91c1c',
                '--color-btn-success': '#16a34a',
                '--color-btn-warning': '#eab308',
                '--color-btn-danger': '#ef4444',
                '--color-btn-purple': '#8b5cf6',
                '--color-btn-purple-hover': '#7c3aed',
                '--color-btn-orange': '#f97316',
                '--color-border': '#57534e',
                '--color-border-light': '#6b7280',
                '--color-divider': '#57534e',
                '--color-table-header': '#44403c',
                '--color-table-row-odd': '#44403c',
                '--color-table-row-even': '#292524',
                '--color-table-hover': '#57534e',
                '--color-fixed-column-bg': '#44403c',
                '--color-modal-backdrop': 'rgba(0, 0, 0, 0.8)',
                '--color-modal-bg': '#44403c',
                '--color-shadow': 'rgba(0, 0, 0, 0.3)',
                '--color-shadow-heavy': 'rgba(0, 0, 0, 0.5)',
                '--color-header-start': '#292524',
                '--color-header-end': '#1c1917'
            },
            'Light Rose': {
                '--color-bg-primary': '#fff1f2',
                '--color-bg-secondary': '#ffe4e6',
                '--color-bg-container': '#fecdd3',
                '--color-bg-app': '#fff1f2',
                '--color-bg-sidebar': '#ffe4e6',
                '--color-bg-input': '#ffffff',
                '--color-text-primary': '#881337',
                '--color-text-secondary': '#9f1239',
                '--color-text-muted': '#be123c',
                '--color-accent-primary': '#e11d48',
                '--color-accent-secondary': '#be123c',
                '--color-success': '#059669',
                '--color-warning': '#d97706',
                '--color-error': '#dc2626',
                '--color-btn-primary': '#e11d48',
                '--color-btn-primary-hover': '#be123c',
                '--color-btn-success': '#059669',
                '--color-btn-warning': '#d97706',
                '--color-btn-danger': '#dc2626',
                '--color-btn-purple': '#7c3aed',
                '--color-btn-purple-hover': '#6d28d9',
                '--color-btn-orange': '#ea580c',
                '--color-border': '#f9a8d4',
                '--color-border-light': '#f472b6',
                '--color-divider': '#f9a8d4',
                '--color-table-header': '#fecdd3',
                '--color-table-row-odd': '#fecdd3',
                '--color-table-row-even': '#ffe4e6',
                '--color-table-hover': '#f9a8d4',
                '--color-fixed-column-bg': '#fecdd3',
                '--color-modal-backdrop': 'rgba(0, 0, 0, 0.5)',
                '--color-modal-bg': '#fecdd3',
                '--color-shadow': 'rgba(0, 0, 0, 0.1)',
                '--color-shadow-heavy': 'rgba(0, 0, 0, 0.2)',
                '--color-header-start': '#ffe4e6',
                '--color-header-end': '#fff1f2'
            },
            'Electric Violet': {
                '--color-bg-primary': '#1a0c2e',
                '--color-bg-secondary': '#2d1b4e',
                '--color-bg-container': '#4c1d95',
                '--color-bg-app': '#1a0c2e',
                '--color-bg-sidebar': '#2d1b4e',
                '--color-bg-input': '#2d1b4e',
                '--color-text-primary': '#e9d5ff',
                '--color-text-secondary': '#d8b4fe',
                '--color-text-muted': '#c084fc',
                '--color-accent-primary': '#8b5cf6',
                '--color-accent-secondary': '#7c3aed',
                '--color-success': '#10b981',
                '--color-warning': '#f59e0b',
                '--color-error': '#ef4444',
                '--color-btn-primary': '#8b5cf6',
                '--color-btn-primary-hover': '#7c3aed',
                '--color-btn-success': '#10b981',
                '--color-btn-warning': '#f59e0b',
                '--color-btn-danger': '#ef4444',
                '--color-btn-purple': '#8b5cf6',
                '--color-btn-purple-hover': '#7c3aed',
                '--color-btn-orange': '#f97316',
                '--color-border': '#5b21b6',
                '--color-border-light': '#6d28d9',
                '--color-divider': '#5b21b6',
                '--color-table-header': '#4c1d95',
                '--color-table-row-odd': '#4c1d95',
                '--color-table-row-even': '#2d1b4e',
                '--color-table-hover': '#5b21b6',
                '--color-fixed-column-bg': '#4c1d95',
                '--color-modal-backdrop': 'rgba(0, 0, 0, 0.8)',
                '--color-modal-bg': '#4c1d95',
                '--color-shadow': 'rgba(0, 0, 0, 0.3)',
                '--color-shadow-heavy': 'rgba(0, 0, 0, 0.5)',
                '--color-header-start': '#2d1b4e',
                '--color-header-end': '#1a0c2e'
            },
            'Light Lime': {
                '--color-bg-primary': '#f7fee7',
                '--color-bg-secondary': '#ecfccb',
                '--color-bg-container': '#d9f99d',
                '--color-bg-app': '#f7fee7',
                '--color-bg-sidebar': '#ecfccb',
                '--color-bg-input': '#ffffff',
                '--color-text-primary': '#365314',
                '--color-text-secondary': '#4d7c0f',
                '--color-text-muted': '#65a30d',
                '--color-accent-primary': '#84cc16',
                '--color-accent-secondary': '#65a30d',
                '--color-success': '#16a34a',
                '--color-warning': '#d97706',
                '--color-error': '#dc2626',
                '--color-btn-primary': '#84cc16',
                '--color-btn-primary-hover': '#65a30d',
                '--color-btn-success': '#16a34a',
                '--color-btn-warning': '#d97706',
                '--color-btn-danger': '#dc2626',
                '--color-btn-purple': '#7c3aed',
                '--color-btn-purple-hover': '#6d28d9',
                '--color-btn-orange': '#ea580c',
                '--color-border': '#bef264',
                '--color-border-light': '#a3e635',
                '--color-divider': '#bef264',
                '--color-table-header': '#d9f99d',
                '--color-table-row-odd': '#d9f99d',
                '--color-table-row-even': '#ecfccb',
                '--color-table-hover': '#bef264',
                '--color-fixed-column-bg': '#d9f99d',
                '--color-modal-backdrop': 'rgba(0, 0, 0, 0.5)',
                '--color-modal-bg': '#d9f99d',
                '--color-shadow': 'rgba(0, 0, 0, 0.1)',
                '--color-shadow-heavy': 'rgba(0, 0, 0, 0.2)',
                '--color-header-start': '#ecfccb',
                '--color-header-end': '#f7fee7'
            },
            'Golden Hour': {
                '--color-bg-primary': '#1c1714',
                '--color-bg-secondary': '#2c2622',
                '--color-bg-container': '#78716c',
                '--color-bg-app': '#1c1714',
                '--color-bg-sidebar': '#2c2622',
                '--color-bg-input': '#2c2622',
                '--color-text-primary': '#fef3c7',
                '--color-text-secondary': '#fde68a',
                '--color-text-muted': '#fcd34d',
                '--color-accent-primary': '#f59e0b',
                '--color-accent-secondary': '#d97706',
                '--color-success': '#10b981',
                '--color-warning': '#eab308',
                '--color-error': '#ef4444',
                '--color-btn-primary': '#f59e0b',
                '--color-btn-primary-hover': '#d97706',
                '--color-btn-success': '#10b981',
                '--color-btn-warning': '#eab308',
                '--color-btn-danger': '#ef4444',
                '--color-btn-purple': '#8b5cf6',
                '--color-btn-purple-hover': '#7c3aed',
                '--color-btn-orange': '#f59e0b',
                '--color-border': '#a8a29e',
                '--color-border-light': '#d6d3d1',
                '--color-divider': '#a8a29e',
                '--color-table-header': '#78716c',
                '--color-table-row-odd': '#78716c',
                '--color-table-row-even': '#2c2622',
                '--color-table-hover': '#a8a29e',
                '--color-fixed-column-bg': '#78716c',
                '--color-modal-backdrop': 'rgba(0, 0, 0, 0.8)',
                '--color-modal-bg': '#78716c',
                '--color-shadow': 'rgba(0, 0, 0, 0.3)',
                '--color-shadow-heavy': 'rgba(0, 0, 0, 0.5)',
                '--color-header-start': '#2c2622',
                '--color-header-end': '#1c1714'
            },
            'Light Sky': {
                '--color-bg-primary': '#f0f9ff',
                '--color-bg-secondary': '#e0f2fe',
                '--color-bg-container': '#bae6fd',
                '--color-bg-app': '#f0f9ff',
                '--color-bg-sidebar': '#e0f2fe',
                '--color-bg-input': '#ffffff',
                '--color-text-primary': '#0c4a6e',
                '--color-text-secondary': '#0369a1',
                '--color-text-muted': '#0284c7',
                '--color-accent-primary': '#0ea5e9',
                '--color-accent-secondary': '#0284c7',
                '--color-success': '#059669',
                '--color-warning': '#d97706',
                '--color-error': '#dc2626',
                '--color-btn-primary': '#0ea5e9',
                '--color-btn-primary-hover': '#0284c7',
                '--color-btn-success': '#059669',
                '--color-btn-warning': '#d97706',
                '--color-btn-danger': '#dc2626',
                '--color-btn-purple': '#7c3aed',
                '--color-btn-purple-hover': '#6d28d9',
                '--color-btn-orange': '#ea580c',
                '--color-border': '#7dd3fc',
                '--color-border-light': '#38bdf8',
                '--color-divider': '#7dd3fc',
                '--color-table-header': '#bae6fd',
                '--color-table-row-odd': '#bae6fd',
                '--color-table-row-even': '#e0f2fe',
                '--color-table-hover': '#7dd3fc',
                '--color-fixed-column-bg': '#bae6fd',
                '--color-modal-backdrop': 'rgba(0, 0, 0, 0.5)',
                '--color-modal-bg': '#bae6fd',
                '--color-shadow': 'rgba(0, 0, 0, 0.1)',
                '--color-shadow-heavy': 'rgba(0, 0, 0, 0.2)',
                '--color-header-start': '#e0f2fe',
                '--color-header-end': '#f0f9ff'
            },
            'Dark Magenta': {
                '--color-bg-primary': '#1e1b1b',
                '--color-bg-secondary': '#332d2d',
                '--color-bg-container': '#86198f',
                '--color-bg-app': '#1e1b1b',
                '--color-bg-sidebar': '#332d2d',
                '--color-bg-input': '#332d2d',
                '--color-text-primary': '#fdf4ff',
                '--color-text-secondary': '#f3e8ff',
                '--color-text-muted': '#e9d5ff',
                '--color-accent-primary': '#d946ef',
                '--color-accent-secondary': '#c026d3',
                '--color-success': '#10b981',
                '--color-warning': '#f59e0b',
                '--color-error': '#ef4444',
                '--color-btn-primary': '#d946ef',
                '--color-btn-primary-hover': '#c026d3',
                '--color-btn-success': '#10b981',
                '--color-btn-warning': '#f59e0b',
                '--color-btn-danger': '#ef4444',
                '--color-btn-purple': '#d946ef',
                '--color-btn-purple-hover': '#c026d3',
                '--color-btn-orange': '#f97316',
                '--color-border': '#a21caf',
                '--color-border-light': '#be185d',
                '--color-divider': '#a21caf',
                '--color-table-header': '#86198f',
                '--color-table-row-odd': '#86198f',
                '--color-table-row-even': '#332d2d',
                '--color-table-hover': '#a21caf',
                '--color-fixed-column-bg': '#86198f',
                '--color-modal-backdrop': 'rgba(0, 0, 0, 0.8)',
                '--color-modal-bg': '#86198f',
                '--color-shadow': 'rgba(0, 0, 0, 0.3)',
                '--color-shadow-heavy': 'rgba(0, 0, 0, 0.5)',
                '--color-header-start': '#332d2d',
                '--color-header-end': '#1e1b1b'
            }
        };
        
        let currentTheme = 'Dark Ocean';
        
        // Initialize themes on page load
        function initThemes() {
            // Load saved theme from storage
            const savedTheme = localStorage.getItem('golfSwindleTheme');
            if (savedTheme && themes[savedTheme]) {
                currentTheme = savedTheme;
            }
            
            applyTheme(currentTheme);
            populateThemeModal();
            
            // Set up theme selector button
            const themeBtn = document.getElementById('themeSelector');
            if (themeBtn) {
                themeBtn.addEventListener('click', openThemeModal);
            }
        }
        
        function populateThemeModal() {
            const themeGrid = document.getElementById('themeGrid');
            if (!themeGrid) return;
            
            themeGrid.innerHTML = '';
            
            Object.entries(themes).forEach(([themeName, themeVars]) => {
                const themeCard = document.createElement('div');
                themeCard.className = 'theme-card';
                if (themeName === currentTheme) {
                    themeCard.classList.add('active');
                }
                
                // Apply theme colors to the card itself
                Object.entries(themeVars).forEach(([property, value]) => {
                    themeCard.style.setProperty(property, value);
                });
                themeCard.style.backgroundColor = themeVars['--color-bg-container'];
                themeCard.style.color = themeVars['--color-text-primary'];
                
                themeCard.innerHTML = `
                    <div class="theme-name" style="color: ${themeVars['--color-text-primary']};">${themeName}</div>
                    <div class="theme-preview" style="background: linear-gradient(45deg, ${themeVars['--color-bg-primary']}, ${themeVars['--color-bg-secondary']});">
                        <div class="theme-preview-text" style="color: ${themeVars['--color-accent-primary']};">Sample Text</div>
                    </div>
                    <div class="theme-colors">
                        <div class="theme-color" style="background-color: ${themeVars['--color-bg-primary']};"></div>
                        <div class="theme-color" style="background-color: ${themeVars['--color-bg-secondary']};"></div>
                        <div class="theme-color" style="background-color: ${themeVars['--color-accent-primary']};"></div>
                        <div class="theme-color" style="background-color: ${themeVars['--color-success']};"></div>
                    </div>
                `;
                
                themeCard.addEventListener('click', () => selectTheme(themeName));
                themeGrid.appendChild(themeCard);
            });
        }
        
        function applyTheme(themeName) {
            const theme = themes[themeName];
            if (!theme) return;
            
            const root = document.documentElement;
            Object.entries(theme).forEach(([property, value]) => {
                root.style.setProperty(property, value);
            });
            
            // Save theme preference
            localStorage.setItem('golfSwindleTheme', themeName);
            currentTheme = themeName;
            
            // Update active state in modal
            const cards = document.querySelectorAll('.theme-card');
            cards.forEach(card => {
                card.classList.remove('active');
                if (card.querySelector('.theme-name').textContent === themeName) {
                    card.classList.add('active');
                }
            });
        }
        
        function selectTheme(themeName) {
            applyTheme(themeName);
            showStatusMessage(`Theme changed to ${themeName}`, 'success');
        }
        
        function openThemeModal() {
            const modal = document.getElementById('themeModal');
            if (modal) {
                modal.style.display = 'flex';
                // Refresh the theme grid in case current theme changed
                populateThemeModal();
            }
        }
        
        function closeThemeModal() {
            const modal = document.getElementById('themeModal');
            if (modal) {
                modal.style.display = 'none';
            }
        }
        
        // Close modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('themeModal');
            if (e.target === modal) {
                closeThemeModal();
            }
        });
        
        // Initialize themes when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            initThemes();
        });
        
        // Call immediately if DOM already loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initThemes);
        } else {
            initThemes();
        }
        
        // === SCORECARD FUNCTIONALITY ===
        
        // Default course data
        let scorecardData = {
            courseName: 'Golf Course',
            date: new Date().toISOString().split('T')[0],
            holes: [
                { hole: 1, par: 4, index: 10 },
                { hole: 2, par: 4, index: 8 },
                { hole: 3, par: 3, index: 16 },
                { hole: 4, par: 5, index: 2 },
                { hole: 5, par: 4, index: 12 },
                { hole: 6, par: 3, index: 18 },
                { hole: 7, par: 4, index: 4 },
                { hole: 8, par: 4, index: 14 },
                { hole: 9, par: 5, index: 6 },
                { hole: 10, par: 4, index: 9 },
                { hole: 11, par: 4, index: 7 },
                { hole: 12, par: 3, index: 15 },
                { hole: 13, par: 5, index: 1 },
                { hole: 14, par: 4, index: 11 },
                { hole: 15, par: 3, index: 17 },
                { hole: 16, par: 4, index: 3 },
                { hole: 17, par: 4, index: 13 },
                { hole: 18, par: 5, index: 5 }
            ],
            players: []
        };
        
        // Add player to scorecard
        function addScorecardPlayer() {
            const nameInput = document.getElementById('scorecardPlayerName');
            const phcInput = document.getElementById('scorecardPlayerPHC');
            
            const name = nameInput.value.trim();
            const phc = parseFloat(phcInput.value) || 0;
            
            if (!name) {
                alert('Please enter a player name');
                return;
            }
            
            // Check if player already exists
            if (scorecardData.players.find(p => p.name.toLowerCase() === name.toLowerCase())) {
                alert('Player already exists');
                return;
            }
            
            // Add player
            const player = {
                name: name,
                phc: phc,
                scores: new Array(18).fill('') // Empty scores for 18 holes
            };
            
            scorecardData.players.push(player);
            
            // Clear inputs
            nameInput.value = '';
            phcInput.value = '';
            
            // Auto-save and refresh scorecard
            autoSaveScorecardData();
            buildScorecardTable();
        }
        
        // Remove player from scorecard
        function removePlayer(playerIndex) {
            const player = scorecardData.players[playerIndex];
            if (!player) return;
            
            // Confirm removal
            if (confirm(`Are you sure you want to remove ${player.name} from the scorecard?`)) {
                // Remove player from array
                scorecardData.players.splice(playerIndex, 1);
                
                // Auto-save and refresh scorecard
                autoSaveScorecardData();
                buildScorecardTable();
                
                console.log(`✅ Player ${player.name} removed from scorecard`);
            }
        }
        
        // Move to next gross score input after editing (move right to next hole for same player)
        function moveToNextGrossScoreInput(currentPlayerIndex, currentHoleIndex) {
            console.log(`🚀 Navigation called: Player ${currentPlayerIndex}, Hole ${currentHoleIndex + 1}`);
            
            const nextHoleIndex = currentHoleIndex + 1;
            
            // Stop if at end of holes
            if (nextHoleIndex >= 18) {
                console.log('🏁 At end of holes, stopping navigation');
                return;
            }
            
            console.log(`🎯 Moving to next hole: ${nextHoleIndex + 1}`);
            
            // Find the next gross score circle directly
            setTimeout(() => {
                const table = document.getElementById('scorecardTable');
                const rows = table.querySelectorAll('tbody tr');
                
                console.log(`📋 Found ${rows.length} player rows`);
                
                if (rows[currentPlayerIndex]) {
                    const cells = rows[currentPlayerIndex].querySelectorAll('td');
                    console.log(`📊 Player row has ${cells.length} cells`);
                    
                    // Find the cell with the next hole's gross score
                    let targetCellIndex;
                    
                    if (nextHoleIndex < 9) {
                        // Front 9: Player(0) + PHC(1) + hole index = 2 + holeIndex
                        targetCellIndex = 2 + nextHoleIndex;
                        console.log(`🔍 Front 9 - Target cell index: ${targetCellIndex} for hole ${nextHoleIndex + 1}`);
                    } else {
                        // Back 9: Player(0) + PHC(1) + Front9(9) + OUT totals(2) + back9 index
                        targetCellIndex = 2 + 9 + 2 + (nextHoleIndex - 9);
                        console.log(`🔍 Back 9 - Target cell index: ${targetCellIndex} for hole ${nextHoleIndex + 1}`);
                    }
                    
                    if (cells[targetCellIndex]) {
                        console.log(`✅ Found target cell at index ${targetCellIndex}`);
                        const nextScoreCircle = cells[targetCellIndex].querySelector('.gross-score-display');
                        if (nextScoreCircle) {
                            console.log(`✅ Found gross score circle, clicking it`);
                            nextScoreCircle.click();
                        } else {
                            console.log(`❌ No gross score circle found in cell`);
                            console.log('Cell HTML:', cells[targetCellIndex].innerHTML);
                        }
                    } else {
                        console.log(`❌ Target cell ${targetCellIndex} not found. Total cells: ${cells.length}`);
                        // Debug: show all cell contents
                        console.log('All cells:');
                        cells.forEach((cell, i) => {
                            console.log(`  Cell ${i}:`, cell.textContent.trim() || 'empty');
                        });
                    }
                } else {
                    console.log(`❌ Player row ${currentPlayerIndex} not found`);
                }
            }, 100);
        }
        
        // Edit gross score by clicking on white circle - make it directly editable
        function editGrossScore(playerIndex, holeIndex, circleElement) {
            // Don't edit if already editing
            if (circleElement.querySelector('input')) return;
            
            const currentScore = scorecardData.players[playerIndex].scores[holeIndex];
            const originalContent = circleElement.textContent;
            let isFinishing = false;
            
            // Create inline input field
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'inline-score-input';
            input.value = currentScore || '';
            input.min = '0';
            input.max = '12';
            input.style.cssText = `
                width: 24px;
                height: 24px;
                border: none;
                background: transparent;
                text-align: center;
                font-size: 11px;
                font-weight: bold;
                color: black;
                border-radius: 50%;
                outline: 2px solid var(--color-accent-primary);
                padding: 0;
                line-height: 1;
            `;
            
            // Replace circle content with input
            circleElement.textContent = '';
            circleElement.appendChild(input);
            
            // Focus and select the input
            input.focus();
            input.select();
            
            // Handle finishing the edit
            function finishEdit(shouldNavigate = false) {
                if (isFinishing) return; // Prevent multiple calls
                isFinishing = true;
                
                const newValue = input.value.trim();
                let scoreValue = newValue === '' ? '' : parseInt(newValue);
                
                // Validate score (allow 0 as a valid score)
                if (scoreValue !== '' && (isNaN(scoreValue) || scoreValue < 0 || scoreValue > 12)) {
                    // Invalid score, revert to original
                    circleElement.textContent = originalContent;
                    return;
                }
                
                // Update score
                updatePlayerScore(playerIndex, holeIndex, scoreValue);
                
                // Navigate to next hole if requested
                if (shouldNavigate) {
                    setTimeout(() => {
                        moveToNextGrossScoreInput(playerIndex, holeIndex);
                    }, 100);
                }
            }
            
            // Handle key events
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    finishEdit(true); // Navigate to next
                } else if (e.key === 'Escape') {
                    isFinishing = true;
                    circleElement.textContent = originalContent;
                }
            });
            
            // Handle blur (without navigation)
            input.addEventListener('blur', function() {
                if (!isFinishing) {
                    finishEdit(false); // Don't navigate on blur
                }
            });
        }
        
        // Calculate Stableford points
        function calculateStablefordPoints(grossScore, par, playerPHC, holeIndex) {
            if (grossScore === '' || grossScore === null || grossScore === undefined) return 0;
            
            const gross = parseInt(grossScore);
            if (isNaN(gross)) return 0;
            
            const shots = playerPHC >= holeIndex ? 1 : 0; // Player gets a shot if PHC >= hole index
            const netScore = gross - shots;
            const scoreToPar = netScore - par;
            
            // Stableford scoring
            if (scoreToPar <= -2) return 4; // Eagle or better
            if (scoreToPar === -1) return 3; // Birdie
            if (scoreToPar === 0) return 2; // Par
            if (scoreToPar === 1) return 1; // Bogey
            return 0; // Double bogey or worse
        }
        
        // Get score circle class (legacy - now unused)
        function getScoreCircleClass(grossScore, par) {
            if (!grossScore || grossScore === '') return 'score-nr';
            
            const gross = parseInt(grossScore);
            const scoreToPar = gross - par;
            
            if (scoreToPar <= -2) return 'score-eagle';
            if (scoreToPar === -1) return 'score-birdie';
            if (scoreToPar === 0) return 'score-par';
            if (scoreToPar === 1) return 'score-bogey';
            return 'score-double-bogey';
        }
        
        // Get Stableford circle class based on points
        function getStablefordCircleClass(stablefordPoints) {
            if (stablefordPoints === '' || stablefordPoints === 0) {
                return stablefordPoints === '' ? 'stbl-nr' : 'stbl-0';
            }
            
            const points = parseInt(stablefordPoints);
            if (points >= 4) return 'stbl-4'; // Eagle or better
            if (points === 3) return 'stbl-3'; // Birdie
            if (points === 2) return 'stbl-2'; // Par
            if (points === 1) return 'stbl-1'; // Bogey
            return 'stbl-0'; // Double bogey or worse
        }
        
        // Build scorecard table
        function buildScorecardTable() {
            const table = document.getElementById('scorecardTable');
            if (!table) return;
            
            let html = '';
            
            // Header row 1 - Hole numbers
            html += '<thead>';
            html += '<tr>';
            html += '<th class="player-name">Player</th>';
            html += '<th class="player-name">PHC</th>';
            
            // Front 9 holes
            for (let i = 1; i <= 9; i++) {
                html += `<th class="hole-header">${i}</th>`;
            }
            html += '<th class="totals-col front-nine">OUT<br>Stbl</th>';
            html += '<th class="totals-col">OUT<br>Gross</th>';
            
            // Back 9 holes
            for (let i = 10; i <= 18; i++) {
                html += `<th class="hole-header ${i === 10 ? 'back-nine' : ''}">${i}</th>`;
            }
            html += '<th class="totals-col">IN<br>Stbl</th>';
            html += '<th class="totals-col">IN<br>Gross</th>';
            html += '<th class="totals-col">CB<br>13-18</th>'; // Countback total
            html += '<th class="totals-col">TOT<br>Stbl</th>';
            html += '<th class="totals-col">TOT<br>Gross</th>';
            html += '</tr>';
            
            // Header row 2 - Par
            html += '<tr>';
            html += '<th class="player-name">PAR</th>';
            html += '<th class="player-name">-</th>';
            
            let frontPar = 0, backPar = 0;
            
            // Front 9 par
            for (let i = 0; i < 9; i++) {
                const par = scorecardData.holes[i].par;
                frontPar += par;
                html += `<th><input type="number" class="editable-input" value="${par}" onchange="updateHolePar(${i}, this.value)" min="3" max="6"></th>`;
            }
            html += `<th class="totals-col">${frontPar}</th>`;
            html += `<th class="totals-col">${frontPar}</th>`;
            
            // Back 9 par
            for (let i = 9; i < 18; i++) {
                const par = scorecardData.holes[i].par;
                backPar += par;
                html += `<th><input type="number" class="editable-input" value="${par}" onchange="updateHolePar(${i}, this.value)" min="3" max="6"></th>`;
            }
            html += `<th class="totals-col">${backPar}</th>`;
            html += `<th class="totals-col">${backPar}</th>`;
            
            // Countback par (holes 13-18)
            const countbackPar = scorecardData.holes.slice(12, 18).reduce((sum, hole) => sum + hole.par, 0);
            html += `<th class="totals-col">${countbackPar}</th>`;
            
            html += `<th class="totals-col">${frontPar + backPar}</th>`;
            html += `<th class="totals-col">${frontPar + backPar}</th>`;
            html += '</tr>';
            
            // Header row 3 - Index
            html += '<tr>';
            html += '<th class="player-name">INDEX</th>';
            html += '<th class="player-name">-</th>';
            
            // Front 9 index
            for (let i = 0; i < 9; i++) {
                const index = scorecardData.holes[i].index;
                html += `<th><input type="number" class="editable-input" value="${index}" onchange="updateHoleIndex(${i}, this.value)" min="1" max="18"></th>`;
            }
            html += '<th class="totals-col">-</th>';
            html += '<th class="totals-col">-</th>';
            
            // Back 9 index
            for (let i = 9; i < 18; i++) {
                const index = scorecardData.holes[i].index;
                html += `<th><input type="number" class="editable-input" value="${index}" onchange="updateHoleIndex(${i}, this.value)" min="1" max="18"></th>`;
            }
            html += '<th class="totals-col">-</th>';
            html += '<th class="totals-col">-</th>';
            html += '<th class="totals-col">-</th>';
            html += '<th class="totals-col">-</th>';
            html += '<th class="totals-col">-</th>';
            html += '</tr>';
            html += '</thead>';
            
            // Player rows
            html += '<tbody>';
            scorecardData.players.forEach((player, playerIndex) => {
                html += '<tr>';
                html += `<td class="player-name">
                    <div class="player-name-container">
                        <span class="player-name-text">${player.name}</span>
                        <button class="remove-player-btn" onclick="removePlayer(${playerIndex})" title="Remove ${player.name}">×</button>
                    </div>
                </td>`;
                html += `<td class="player-name">${player.phc}</td>`;
                
                let frontStableford = 0, frontGross = 0;
                let backStableford = 0, backGross = 0;
                let countbackStableford = 0; // Holes 13-18
                
                // Front 9 scores
                for (let i = 0; i < 9; i++) {
                    const score = player.scores[i];
                    const stablefordPoints = calculateStablefordPoints(score, scorecardData.holes[i].par, player.phc, scorecardData.holes[i].index);
                    const stablefordClass = getStablefordCircleClass(score === '' ? '' : stablefordPoints);
                    
                    if (score !== '' && !isNaN(score)) {
                        frontStableford += stablefordPoints;
                        frontGross += parseInt(score);
                    }
                    
                    html += `<td>
                        <div class="score-container">
                            <input type="number" class="gross-score-input" value="${score}" onchange="updatePlayerScore(${playerIndex}, ${i}, this.value)" min="0" max="12" placeholder="" style="display: none;">
                            <div class="gross-score-display ${(score === '' || score === null || score === undefined) ? 'empty' : ''}" onclick="editGrossScore(${playerIndex}, ${i}, this)">${(score === '' || score === null || score === undefined) ? '-' : score}</div>
                            <div class="stableford-display ${stablefordClass}">${score === '' ? 'NR' : stablefordPoints}</div>
                        </div>
                    </td>`;
                }
                html += `<td class="totals-col">${frontStableford}</td>`;
                html += `<td class="totals-col">${frontGross || ''}</td>`;
                
                // Back 9 scores
                for (let i = 9; i < 18; i++) {
                    const score = player.scores[i];
                    const stablefordPoints = calculateStablefordPoints(score, scorecardData.holes[i].par, player.phc, scorecardData.holes[i].index);
                    const stablefordClass = getStablefordCircleClass(score === '' ? '' : stablefordPoints);
                    
                    if (score !== '' && !isNaN(score)) {
                        backStableford += stablefordPoints;
                        backGross += parseInt(score);
                        
                        // Add to countback total (holes 13-18)
                        if (i >= 12) {
                            countbackStableford += stablefordPoints;
                        }
                    }
                    
                    html += `<td>
                        <div class="score-container">
                            <input type="number" class="gross-score-input" value="${score}" onchange="updatePlayerScore(${playerIndex}, ${i}, this.value)" min="0" max="12" placeholder="" style="display: none;">
                            <div class="gross-score-display ${(score === '' || score === null || score === undefined) ? 'empty' : ''}" onclick="editGrossScore(${playerIndex}, ${i}, this)">${(score === '' || score === null || score === undefined) ? '-' : score}</div>
                            <div class="stableford-display ${stablefordClass}">${score === '' ? 'NR' : stablefordPoints}</div>
                        </div>
                    </td>`;
                }
                html += `<td class="totals-col">${backStableford}</td>`;
                html += `<td class="totals-col">${backGross || ''}</td>`;
                html += `<td class="totals-col">${countbackStableford}</td>`; // Countback total
                html += `<td class="totals-col">${frontStableford + backStableford}</td>`;
                html += `<td class="totals-col">${(frontGross + backGross) || ''}</td>`;
                html += '</tr>';
            });
            html += '</tbody>';
            
            table.innerHTML = html;
        }
        
        // Auto-save scorecard data
        function autoSaveScorecardData() {
            try {
                localStorage.setItem('golfScorecardData', JSON.stringify(scorecardData));
                console.log('📋 Scorecard data auto-saved');
            } catch (error) {
                console.error('Failed to auto-save scorecard data:', error);
            }
        }
        
        // Move focus to the next input field to the right
        function moveToNextInput(currentInput) {
            console.log('🚀 Starting navigation from:', currentInput.className, 'value:', currentInput.value);
            
            // Get all editable inputs in the scorecard table
            const table = document.getElementById('scorecardTable');
            if (!table) {
                console.log('❌ No scorecard table found');
                return;
            }
            
            // Find ALL valid inputs in order (gross-score-input and editable-input)
            const allInputs = Array.from(table.querySelectorAll('input.gross-score-input, input.editable-input'))
                .filter(input => !input.disabled && !input.readOnly);
            
            console.log(`📋 Found ${allInputs.length} valid inputs in scorecard`);
            
            // Find current input index - be more flexible in case DOM changed
            let currentIndex = allInputs.indexOf(currentInput);
            
            // If current input not found (maybe DOM changed), find by position/attributes
            if (currentIndex === -1) {
                console.log('⚠️ Current input not in list, searching by position...');
                
                // Try to find input by its parent cell position
                const currentCell = currentInput.closest('td, th');
                const currentRow = currentInput.closest('tr');
                
                if (currentCell && currentRow) {
                    const rows = Array.from(table.querySelectorAll('tr'));
                    const cells = Array.from(currentRow.querySelectorAll('td, th'));
                    const rowIndex = rows.indexOf(currentRow);
                    const cellIndex = cells.indexOf(currentCell);
                    
                    console.log(`📍 Searching from row ${rowIndex}, cell ${cellIndex}`);
                    
                    // Find the input at this position in our allInputs array
                    for (let i = 0; i < allInputs.length; i++) {
                        const input = allInputs[i];
                        const inputCell = input.closest('td, th');
                        const inputRow = input.closest('tr');
                        const inputRowIndex = rows.indexOf(inputRow);
                        const inputCellIndex = Array.from(inputRow.querySelectorAll('td, th')).indexOf(inputCell);
                        
                        if (inputRowIndex === rowIndex && inputCellIndex === cellIndex) {
                            currentIndex = i;
                            console.log(`✅ Found matching input at index ${i}`);
                            break;
                        }
                    }
                }
            }
            
            console.log(`📍 Current input index: ${currentIndex}`);
            
            if (currentIndex === -1) {
                console.log('❌ Still could not find current input, using first input');
                currentIndex = -1; // Will move to index 0 next
            }
            
            // Get next input
            const nextIndex = currentIndex + 1;
            if (nextIndex < allInputs.length) {
                const nextInput = allInputs[nextIndex];
                console.log(`➡️ Moving to next input (${nextIndex}): ${nextInput.className}`);
                
                // Focus and select the next input with a small delay
                setTimeout(() => {
                    try {
                        nextInput.focus();
                        nextInput.select();
                        console.log('✅ Successfully focused next input');
                    } catch (error) {
                        console.error('❌ Failed to focus next input:', error);
                    }
                }, 10);
            } else {
                console.log('🏁 Reached end of scorecard inputs');
                // Optionally, wrap around to first input
                const firstInput = allInputs[0];
                if (firstInput) {
                    console.log('🔄 Wrapping to first input');
                    setTimeout(() => {
                        try {
                            firstInput.focus();
                            firstInput.select();
                        } catch (error) {
                            console.error('❌ Failed to focus first input:', error);
                        }
                    }, 10);
                }
            }
        }
        
        // Debug function to analyze table structure (call from console)
        window.debugScorecardNavigation = function() {
            const table = document.getElementById('scorecardTable');
            if (!table) {
                console.log('No scorecard table found');
                return;
            }
            
            const rows = table.querySelectorAll('tr');
            console.log(`📋 Scorecard has ${rows.length} rows`);
            
            rows.forEach((row, rowIndex) => {
                const cells = row.querySelectorAll('td, th');
                console.log(`Row ${rowIndex}: ${cells.length} cells`);
                
                cells.forEach((cell, cellIndex) => {
                    const input = cell.querySelector('input');
                    const classes = cell.className;
                    if (input) {
                        const inputType = input.type;
                        const inputClasses = input.className;
                        const disabled = input.disabled;
                        const readonly = input.readOnly;
                        console.log(`  Cell ${cellIndex}: HAS INPUT (type: ${inputType}, classes: ${inputClasses}, disabled: ${disabled}, readonly: ${readonly}) cell classes: ${classes}`);
                    } else {
                        console.log(`  Cell ${cellIndex}: no input, classes: ${classes}`);
                    }
                });
            });
        };
        
        // Test function to try navigation from current focused element
        window.testNavigation = function() {
            const focused = document.activeElement;
            if (focused && focused.tagName === 'INPUT') {
                console.log('🗣️ Testing navigation from:', focused.className);
                moveToNextInput(focused);
            } else {
                console.log('⚠️ No input is currently focused. Click on an input first, then call testNavigation()');
            }
        };
        
        // Find all valid navigation inputs in scorecard 
        window.listNavigableInputs = function() {
            const table = document.getElementById('scorecardTable');
            if (!table) {
                console.log('No scorecard table found');
                return;
            }
            
            const validInputs = Array.from(table.querySelectorAll('input.gross-score-input, input.editable-input'))
                .filter(input => !input.disabled && !input.readOnly);
                
            console.log(`🎯 Found ${validInputs.length} navigable inputs:`);
            
            validInputs.forEach((input, index) => {
                const cell = input.closest('td, th');
                const row = input.closest('tr');
                const rowIndex = Array.from(table.querySelectorAll('tr')).indexOf(row);
                const cellIndex = Array.from(row.querySelectorAll('td, th')).indexOf(cell);
                
                console.log(`${index}: Row ${rowIndex}, Cell ${cellIndex} - ${input.className} (value: "${input.value}")`);
            });
            
            return validInputs;
        };
        
        // Test navigation sequence 
        window.testNavigationSequence = function(steps = 5) {
            const inputs = listNavigableInputs();
            if (inputs.length === 0) {
                console.log('No navigable inputs found');
                return;
            }
            
            console.log(`🏃 Testing ${steps} navigation steps...`);
            
            let currentInput = inputs[0];
            currentInput.focus();
            console.log('Starting from first input:', currentInput.className);
            
            let step = 0;
            const testStep = () => {
                if (step < steps) {
                    console.log(`Step ${step + 1}:`);
                    moveToNextInput(document.activeElement);
                    step++;
                    setTimeout(testStep, 100);
                } else {
                    console.log('🏁 Navigation test complete');
                }
            };
            
            setTimeout(testStep, 100);
        };
        
        // Update hole par
        function updateHolePar(holeIndex, newPar) {
            const par = parseInt(newPar) || 4;
            scorecardData.holes[holeIndex].par = Math.max(3, Math.min(6, par));
            autoSaveScorecardData(); // Auto-save
            
            // Only update totals, don't rebuild entire table to preserve focus
            updateScorecardTotals();
        }
        
        // Update hole index
        function updateHoleIndex(holeIndex, newIndex) {
            const index = parseInt(newIndex) || 1;
            scorecardData.holes[holeIndex].index = Math.max(1, Math.min(18, index));
            autoSaveScorecardData(); // Auto-save
            
            // Update player score displays since Stableford calculations depend on index
            updateAllPlayerScoreDisplays();
        }
        
        // Update player score
        function updatePlayerScore(playerIndex, holeIndex, newScore) {
            const score = newScore === '' ? '' : parseInt(newScore);
            if (score !== '' && (score < 1 || score > 12)) return;
            
            scorecardData.players[playerIndex].scores[holeIndex] = score === '' ? '' : score;
            autoSaveScorecardData(); // Auto-save
            
            // Update the score circle color and totals without rebuilding entire table
            updateScoreDisplay(playerIndex, holeIndex, score);
            updateScorecardTotals();
        }
        
        // Update score display (both white circles and Stableford circles) without rebuilding table
        function updateScoreDisplay(playerIndex, holeIndex, score) {
            const table = document.getElementById('scorecardTable');
            if (!table) return;
            
            // Find the specific cell
            const rows = table.querySelectorAll('tbody tr');
            if (rows[playerIndex]) {
                const cells = rows[playerIndex].querySelectorAll('td');
                // Find the cell for this hole (accounting for player name and PHC columns)
                const cellIndex = 2 + holeIndex + (holeIndex >= 9 ? 2 : 0); // +2 for front totals if back 9
                
                if (cells[cellIndex]) {
                    // Update gross score white circle
                    const grossScoreDisplay = cells[cellIndex].querySelector('.gross-score-display');
                    if (grossScoreDisplay) {
                        grossScoreDisplay.textContent = score === '' ? '-' : score;
                        grossScoreDisplay.className = `gross-score-display ${score === '' ? 'empty' : ''}`;
                    }
                    
                    // Update Stableford display
                    const stablefordDisplay = cells[cellIndex].querySelector('.stableford-display');
                    if (stablefordDisplay) {
                        // Calculate Stableford points
                        const player = scorecardData.players[playerIndex];
                        const par = scorecardData.holes[holeIndex].par;
                        const index = scorecardData.holes[holeIndex].index;
                        const stablefordPoints = calculateStablefordPoints(score, par, player.phc, index);
                        const stablefordClass = getStablefordCircleClass(score === '' ? '' : stablefordPoints);
                        
                        // Update Stableford display
                        stablefordDisplay.className = `stableford-display ${stablefordClass}`;
                        stablefordDisplay.textContent = score === '' ? 'NR' : stablefordPoints;
                    }
                    
                    // Update the hidden input as well
                    const hiddenInput = cells[cellIndex].querySelector('.gross-score-input');
                    if (hiddenInput) {
                        hiddenInput.value = score;
                    }
                }
            }
        }
        
        // Update all player score displays (used when index changes affect Stableford calculations)
        function updateAllPlayerScoreDisplays() {
            scorecardData.players.forEach((player, playerIndex) => {
                for (let holeIndex = 0; holeIndex < 18; holeIndex++) {
                    const score = player.scores[holeIndex];
                    if (score !== '') {
                        updateScoreDisplay(playerIndex, holeIndex, score);
                    }
                }
            });
            // Also update totals since Stableford points may have changed
            updateScorecardTotals();
        }
        
        // Update totals without rebuilding entire table
        function updateScorecardTotals() {
            const table = document.getElementById('scorecardTable');
            if (!table) return;
            
            // Update PAR totals in header
            const headerRows = table.querySelectorAll('thead tr');
            if (headerRows[1]) { // PAR row
                const parCells = headerRows[1].querySelectorAll('th');
                let frontPar = 0, backPar = 0;
                
                // Calculate pars
                for (let i = 0; i < 18; i++) {
                    if (i < 9) frontPar += scorecardData.holes[i].par;
                    else backPar += scorecardData.holes[i].par;
                }
                
                // Update totals (skip first 2 columns for player/PHC, then 9 holes, then totals)
                if (parCells[11]) parCells[11].textContent = frontPar; // OUT total
                if (parCells[12]) parCells[12].textContent = frontPar; // OUT total (gross)
                if (parCells[22]) parCells[22].textContent = backPar; // IN total  
                if (parCells[23]) parCells[23].textContent = backPar; // IN total (gross)
                
                // Countback total (holes 13-18)
                const countbackPar = scorecardData.holes.slice(12, 18).reduce((sum, hole) => sum + hole.par, 0);
                if (parCells[24]) parCells[24].textContent = countbackPar;
                
                if (parCells[25]) parCells[25].textContent = frontPar + backPar; // Total
                if (parCells[26]) parCells[26].textContent = frontPar + backPar; // Total (gross)
            }
            
            // Update player totals
            const playerRows = table.querySelectorAll('tbody tr');
            playerRows.forEach((row, playerIndex) => {
                if (playerIndex < scorecardData.players.length) {
                    const player = scorecardData.players[playerIndex];
                    const cells = row.querySelectorAll('td');
                    
                    let frontStableford = 0, frontGross = 0;
                    let backStableford = 0, backGross = 0;
                    let countbackStableford = 0;
                    
                    // Calculate totals
                    for (let i = 0; i < 18; i++) {
                        const score = player.scores[i];
                        if (score !== '' && !isNaN(score)) {
                            const stablefordPoints = calculateStablefordPoints(score, scorecardData.holes[i].par, player.phc, scorecardData.holes[i].index);
                            
                            if (i < 9) {
                                frontStableford += stablefordPoints;
                                frontGross += parseInt(score);
                            } else {
                                backStableford += stablefordPoints;
                                backGross += parseInt(score);
                                if (i >= 12) countbackStableford += stablefordPoints; // Holes 13-18
                            }
                        }
                    }
                    
                    // Update total cells
                    if (cells[11]) cells[11].textContent = frontStableford; // OUT Stableford
                    if (cells[12]) cells[12].textContent = frontGross || ''; // OUT Gross
                    if (cells[22]) cells[22].textContent = backStableford; // IN Stableford
                    if (cells[23]) cells[23].textContent = backGross || ''; // IN Gross
                    if (cells[24]) cells[24].textContent = countbackStableford; // Countback
                    if (cells[25]) cells[25].textContent = frontStableford + backStableford; // Total Stableford
                    if (cells[26]) cells[26].textContent = (frontGross + backGross) || ''; // Total Gross
                }
            });
        }
        
        // Clear all scores (player scores only, preserve PAR and INDEX)
        function clearAllScores() {
            if (confirm('Are you sure you want to clear all player scores? (PAR and INDEX will remain unchanged)')) {
                scorecardData.players.forEach(player => {
                    player.scores = new Array(18).fill('');
                });
                autoSaveScorecardData(); // Auto-save
                buildScorecardTable();
                showStatusMessage('Player scores cleared successfully', 'success');
            }
        }
        
        // Reset course to defaults
        function resetCourseDefaults() {
            if (confirm('Reset course to default par and index values?')) {
                scorecardData.holes = [
                    { hole: 1, par: 4, index: 10 },
                    { hole: 2, par: 4, index: 8 },
                    { hole: 3, par: 3, index: 16 },
                    { hole: 4, par: 5, index: 2 },
                    { hole: 5, par: 4, index: 12 },
                    { hole: 6, par: 3, index: 18 },
                    { hole: 7, par: 4, index: 4 },
                    { hole: 8, par: 4, index: 14 },
                    { hole: 9, par: 5, index: 6 },
                    { hole: 10, par: 4, index: 9 },
                    { hole: 11, par: 4, index: 7 },
                    { hole: 12, par: 3, index: 15 },
                    { hole: 13, par: 5, index: 1 },
                    { hole: 14, par: 4, index: 11 },
                    { hole: 15, par: 3, index: 17 },
                    { hole: 16, par: 4, index: 3 },
                    { hole: 17, par: 4, index: 13 },
                    { hole: 18, par: 5, index: 5 }
                ];
                autoSaveScorecardData(); // Auto-save
                buildScorecardTable();
            }
        }
        
        // Save course data with enhanced error handling and user feedback
        function saveCourseData() {
            console.log('📋 Save Course button clicked');
            
            try {
                // Get input values
                const courseNameInput = document.getElementById('courseName');
                const dateInput = document.getElementById('scoreCardDate');
                
                if (!courseNameInput || !dateInput) {
                    console.error('❌ Course input elements not found');
                    alert('Error: Course input fields not found. Please refresh the page and try again.');
                    return;
                }
                
                const courseName = courseNameInput.value.trim() || 'Golf Course';
                const date = dateInput.value || new Date().toISOString().split('T')[0];
                
                console.log(`📋 Saving course: "${courseName}" on date: ${date}`);
                
                // Update scorecard data
                scorecardData.courseName = courseName;
                scorecardData.date = date;
                
                // Save to localStorage with error handling
                try {
                    localStorage.setItem('golfScorecardData', JSON.stringify(scorecardData));
                    console.log('✅ Course data saved to localStorage successfully');
                } catch (storageError) {
                    console.error('❌ Failed to save to localStorage:', storageError);
                    alert('Error saving course data: ' + storageError.message);
                    return;
                }
                
                // Show success feedback
                if (typeof showStatusMessage === 'function') {
                    showStatusMessage(`Course "${courseName}" saved successfully`, 'success');
                } else {
                    // Fallback if showStatusMessage is not available
                    console.log('✅ Course data saved successfully');
                    alert('Course data saved successfully!');
                }
                
                // Also trigger auto-save for consistency
                autoSaveScorecardData();
                
            } catch (error) {
                console.error('❌ Error in saveCourseData function:', error);
                alert('Error saving course data: ' + error.message);
            }
        }
        
        // Test function for Save Course button - can be called from console
        window.testSaveCourse = function() {
            console.log('🗜 Test Save Course function called');
            
            // Set test values
            const courseNameInput = document.getElementById('courseName');
            const dateInput = document.getElementById('scoreCardDate');
            
            if (courseNameInput) {
                courseNameInput.value = 'Test Golf Course';
                console.log('✅ Set course name to: Test Golf Course');
            }
            
            if (dateInput) {
                dateInput.value = new Date().toISOString().split('T')[0];
                console.log('✅ Set date to today');
            }
            
            // Try to call save function
            try {
                saveCourseData();
                console.log('✅ saveCourseData function called successfully');
            } catch (error) {
                console.error('❌ Error calling saveCourseData:', error);
            }
        };
        
        // Test function to find Save Course button - can be called from console
        window.findSaveCourseButton = function() {
            console.log('🔍 Looking for Save Course button...');
            
            const methods = [
                () => document.querySelector('button[onclick="saveCourseData()"]'),
                () => document.querySelector('button.btn'),
                () => Array.from(document.querySelectorAll('button')).find(btn => btn.textContent.includes('Save Course')),
                () => Array.from(document.querySelectorAll('button')).find(btn => btn.textContent.includes('Save'))
            ];
            
            methods.forEach((method, index) => {
                const btn = method();
                console.log(`Method ${index + 1}:`, btn ? 'Found button' : 'Not found', btn?.textContent);
            });
            
            return methods.map(method => method()).filter(Boolean);
        };
        
        // Load course data
        function loadScorecardData() {
            try {
                const saved = localStorage.getItem('golfScorecardData');
                if (saved) {
                    scorecardData = JSON.parse(saved);
                    
                    // Update UI
                    document.getElementById('courseName').value = scorecardData.courseName || 'Golf Course';
                    document.getElementById('scoreCardDate').value = scorecardData.date || new Date().toISOString().split('T')[0];
                    
                    buildScorecardTable();
                }
            } catch (error) {
                console.error('Failed to load scorecard data:', error);
            }
        }
        
        // Preserve input values in cloned table for capture
        function preserveInputValues(originalTable, clonedTable) {
            // Handle PAR and INDEX inputs specifically
            const originalEditableInputs = originalTable.querySelectorAll('input.editable-input');
            const clonedEditableInputs = clonedTable.querySelectorAll('input.editable-input');
            
            console.log(`📝 Found ${originalEditableInputs.length} PAR/INDEX inputs to convert`);
            
            // Replace PAR and INDEX inputs with visible text spans
            for (let i = 0; i < originalEditableInputs.length && i < clonedEditableInputs.length; i++) {
                const originalInput = originalEditableInputs[i];
                const clonedInput = clonedEditableInputs[i];
                
                if (originalInput.value && clonedInput.parentNode) {
                    // Create a text span to replace the input
                    const textSpan = document.createElement('span');
                    textSpan.textContent = originalInput.value;
                    textSpan.style.cssText = `
                        font-weight: bold !important;
                        font-size: 14px !important;
                        color: #000 !important;
                        background: #fff !important;
                        display: inline-block !important;
                        text-align: center !important;
                        width: 30px !important;
                        height: 24px !important;
                        line-height: 24px !important;
                        border: 2px solid #333 !important;
                        border-radius: 4px !important;
                        padding: 0 !important;
                    `;
                    
                    console.log(`📝 Converting input with value: ${originalInput.value}`);
                    
                    // Replace the input completely with the text span
                    try {
                        clonedInput.parentNode.replaceChild(textSpan, clonedInput);
                    } catch (error) {
                        console.warn('Could not replace input:', error);
                    }
                }
            }
            
            // Handle other inputs
            const originalOtherInputs = originalTable.querySelectorAll('input:not(.editable-input)');
            const clonedOtherInputs = clonedTable.querySelectorAll('input:not(.editable-input)');
            
            for (let i = 0; i < originalOtherInputs.length && i < clonedOtherInputs.length; i++) {
                const originalInput = originalOtherInputs[i];
                const clonedInput = clonedOtherInputs[i];
                
                // Ensure values are preserved
                clonedInput.value = originalInput.value;
                clonedInput.setAttribute('value', originalInput.value);
            }
        }
        
        // Apply theme-aware styles that preserve the selected color theme for capture
        function applyThemeAwareStyles(element) {
            // Get the current theme colors
            const theme = themes[currentTheme] || themes['Dark Ocean'];
            
            // Apply theme colors to the entire element
            element.style.setProperty('--color-bg-primary', theme['--color-bg-primary']);
            element.style.setProperty('--color-bg-secondary', theme['--color-bg-secondary']);
            element.style.setProperty('--color-bg-container', theme['--color-bg-container']);
            element.style.setProperty('--color-text-primary', theme['--color-text-primary']);
            element.style.setProperty('--color-text-secondary', theme['--color-text-secondary']);
            element.style.setProperty('--color-accent-primary', theme['--color-accent-primary']);
            element.style.setProperty('--color-border', theme['--color-border']);
            element.style.setProperty('--color-table-header', theme['--color-table-header']);
            
            // Style all table headers with theme colors
            const headers = element.querySelectorAll('th');
            headers.forEach(th => {
                th.style.cssText = `background: ${theme['--color-table-header']} !important; color: ${theme['--color-text-primary']} !important; font-weight: bold !important; font-size: 12px !important; border: 1px solid ${theme['--color-border']} !important; padding: 8px !important; text-align: center !important;`;
            });
            
            // Style all table cells with theme colors
            const cells = element.querySelectorAll('td');
            cells.forEach(td => {
                td.style.cssText = `background: ${theme['--color-bg-container']} !important; color: ${theme['--color-text-primary']} !important; font-size: 10px !important; border: 1px solid ${theme['--color-border']} !important; padding: 8px !important; text-align: center !important;`;
            });
            
            // Style all score displays with original Stableford colors (preserved as specified in requirements)
            const scoreDisplays = element.querySelectorAll('.gross-score-display, .stableford-display');
            scoreDisplays.forEach(display => {
                if (display.classList.contains('stbl-4')) {
                    // Eagle+ - Purple
                    display.style.cssText = 'background: purple !important; color: white !important; font-weight: bold !important; border-radius: 50% !important; width: 20px !important; height: 20px !important; display: inline-block !important; line-height: 20px !important; text-align: center !important; font-size: 10px !important;';
                } else if (display.classList.contains('stbl-3')) {
                    // Birdie - Red
                    display.style.cssText = 'background: red !important; color: white !important; font-weight: bold !important; border-radius: 50% !important; width: 20px !important; height: 20px !important; display: inline-block !important; line-height: 20px !important; text-align: center !important; font-size: 10px !important;';
                } else if (display.classList.contains('stbl-2')) {
                    // Par - White
                    display.style.cssText = 'background: white !important; color: black !important; font-weight: bold !important; border: 2px solid #000 !important; border-radius: 50% !important; width: 20px !important; height: 20px !important; display: inline-block !important; line-height: 16px !important; text-align: center !important; font-size: 10px !important;';
                } else if (display.classList.contains('stbl-1')) {
                    // Bogey - Blue
                    display.style.cssText = 'background: blue !important; color: white !important; font-weight: bold !important; border-radius: 50% !important; width: 20px !important; height: 20px !important; display: inline-block !important; line-height: 20px !important; text-align: center !important; font-size: 10px !important;';
                } else if (display.classList.contains('stbl-0')) {
                    // Double+ - Green
                    display.style.cssText = 'background: green !important; color: white !important; font-weight: bold !important; border-radius: 50% !important; width: 20px !important; height: 20px !important; display: inline-block !important; line-height: 20px !important; text-align: center !important; font-size: 10px !important;';
                } else if (display.classList.contains('stbl-nr')) {
                    // No Return - Yellow/Gold
                    display.style.cssText = 'background: gold !important; color: black !important; font-weight: bold !important; border-radius: 50% !important; width: 20px !important; height: 20px !important; display: inline-block !important; line-height: 20px !important; text-align: center !important; font-size: 10px !important;';
                } else if (display.classList.contains('gross-score-display')) {
                    // Gross score circles - Always white with dark border for visibility
                    display.style.cssText = 'background: white !important; color: black !important; font-weight: bold !important; border: 2px solid #666 !important; border-radius: 50% !important; width: 20px !important; height: 20px !important; display: inline-block !important; line-height: 16px !important; text-align: center !important; font-size: 10px !important; margin-bottom: 2px !important;';
                }
            });
            
            // Apply theme to course setup and other sections
            const courseSections = element.querySelectorAll('.course-setup, .scorecard-key, .scorecard-controls');
            courseSections.forEach(section => {
                section.style.cssText = `background: ${theme['--color-bg-secondary']} !important; color: ${theme['--color-text-primary']} !important; border: 1px solid ${theme['--color-border']} !important;`;
            });
            
            // Apply theme to section titles
            const sectionTitles = element.querySelectorAll('h3');
            sectionTitles.forEach(title => {
                title.style.color = `${theme['--color-accent-primary']} !important`;
            });
        }
        
        // Capture scorecard image - full course setup page including all players and data
        function captureScorecardImage() {
            const scorecardTab = document.getElementById('scorecard-tab');
            if (!scorecardTab) {
                alert('Scorecard tab not found.');
                return;
            }
            
            // Check if html2canvas is loaded
            if (typeof html2canvas === 'undefined') {
                alert('Image capture library not loaded. Please refresh the page and try again.');
                console.error('html2canvas library not available');
                return;
            }
            
            console.log(`📷 Starting full course setup page capture with theme: ${currentTheme}`);
            
            // Clone the entire scorecard tab content
            const scorecardClone = scorecardTab.cloneNode(true);
            
            // Get current theme colors for proper application
            const theme = themes[currentTheme] || themes['Dark Ocean'];
            
            // Create a temporary container for capture
            const captureContainer = document.createElement('div');
            
            // Apply all theme CSS custom properties to the container
            Object.entries(theme).forEach(([property, value]) => {
                captureContainer.style.setProperty(property, value);
            });
            
            captureContainer.style.cssText = `
                position: absolute;
                left: -9999px;
                top: 0;
                background: ${theme['--color-bg-container']};
                padding: 20px;
                overflow: visible;
                width: max-content;
                height: max-content;
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
            `;
            
            // Re-apply theme properties after cssText (which may override them)
            Object.entries(theme).forEach(([property, value]) => {
                captureContainer.style.setProperty(property, value);
            });
            
            // Style the cloned content for better visibility with current theme
            scorecardClone.style.cssText = `
                background: ${theme['--color-bg-container']};
                color: ${theme['--color-text-primary']};
                padding: 20px;
                border-radius: 8px;
                border: 2px solid ${theme['--color-border']};
                width: max-content;
                height: max-content;
                overflow: visible;
            `;
            
            // Apply theme properties to the cloned content as well
            Object.entries(theme).forEach(([property, value]) => {
                scorecardClone.style.setProperty(property, value);
            });
            
            // Preserve input values in the cloned content
            const originalInputs = scorecardTab.querySelectorAll('input, select, textarea');
            const clonedInputs = scorecardClone.querySelectorAll('input, select, textarea');
            
            for (let i = 0; i < originalInputs.length && i < clonedInputs.length; i++) {
                const original = originalInputs[i];
                const cloned = clonedInputs[i];
                
                if (original.type === 'checkbox' || original.type === 'radio') {
                    cloned.checked = original.checked;
                } else {
                    cloned.value = original.value;
                    cloned.setAttribute('value', original.value);
                }
            }
            
            // Apply enhanced styling for better capture
            const table = scorecardClone.querySelector('#scorecardTable');
            if (table) {
                preserveInputValues(scorecardTab.querySelector('#scorecardTable'), table);
                applyThemeAwareStyles(scorecardClone); // Apply to entire clone, not just table
            }
            
            captureContainer.appendChild(scorecardClone);
            document.body.appendChild(captureContainer);
            
            try {
                // Capture the full container with current theme background
                html2canvas(captureContainer, {
                    backgroundColor: theme['--color-bg-container'],
                    scale: 2, // Higher scale for better text clarity
                    useCORS: true,
                    allowTaint: true,
                    scrollX: 0,
                    scrollY: 0,
                    width: Math.max(captureContainer.scrollWidth, 1600),
                    height: captureContainer.scrollHeight,
                    logging: false,
                    imageTimeout: 15000,
                    removeContainer: true
                }).then(canvas => {
                    // Remove temporary container
                    document.body.removeChild(captureContainer);
                    const link = document.createElement('a');
                    const courseName = scorecardData.courseName || 'Golf_Course';
                    const date = scorecardData.date || new Date().toISOString().split('T')[0];
                    const fileName = `scorecard_${courseName.replace(/[\s\W]+/g, '_')}_${date}.png`;
                    
                    link.download = fileName;
                    link.href = canvas.toDataURL('image/png', 0.9);
                    
                    // Trigger download
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    console.log(`✅ Scorecard captured successfully: ${fileName}`);
                    // No alert needed - file downloads automatically
                    
                }).catch(error => {
                    // Remove temporary container on error
                    if (document.body.contains(captureContainer)) {
                        document.body.removeChild(captureContainer);
                    }
                    console.error('Scorecard capture failed:', error);
                    alert(`Scorecard capture failed: ${error.message || 'Unknown error'}`);
                });
                
            } catch (error) {
                // Remove temporary container on error
                if (document.body.contains(captureContainer)) {
                    document.body.removeChild(captureContainer);
                }
                console.error('Capture initialization failed:', error);
                alert(`Capture failed to start: ${error.message || 'Unknown error'}`);
            }
        }
        
        // Initialize scorecard when switching to tab
        function initScorecard() {
            setupGlobalScorecardNavigation(); // Set up Enter key navigation
            loadScorecardData();
            buildScorecardTable();
            setupScorecardEventListeners();
        }
        
        // Setup event listeners for scorecard
        function setupScorecardEventListeners() {
            console.log('🎯 Setting up scorecard event listeners');
            
            // Add event listeners for auto-save on course data changes
            const courseNameInput = document.getElementById('courseName');
            const dateInput = document.getElementById('scoreCardDate');
            
            if (courseNameInput && !courseNameInput.hasAttribute('data-listener-added')) {
                courseNameInput.addEventListener('input', function() {
                    scorecardData.courseName = this.value;
                    autoSaveScorecardData();
                });
                courseNameInput.setAttribute('data-listener-added', 'true');
                console.log('✅ Course name input listener added');
            }
            
            if (dateInput && !dateInput.hasAttribute('data-listener-added')) {
                dateInput.addEventListener('change', function() {
                    scorecardData.date = this.value;
                    autoSaveScorecardData();
                });
                dateInput.setAttribute('data-listener-added', 'true');
                console.log('✅ Date input listener added');
            }
            
            // Find and setup Save Course button with multiple fallback methods
            let saveCourseBtn = document.querySelector('button[onclick="saveCourseData()"]');
            
            if (!saveCourseBtn) {
                // Try alternative selectors
                const allButtons = document.querySelectorAll('button');
                allButtons.forEach(btn => {
                    if (btn.textContent.includes('Save Course')) {
                        saveCourseBtn = btn;
                    }
                });
            }
            
            if (saveCourseBtn) {
                console.log('✅ Save Course button found:', saveCourseBtn.textContent);
                
                // Remove existing onclick to avoid conflicts
                saveCourseBtn.removeAttribute('onclick');
                
                // Add a direct event listener that definitely works
                saveCourseBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🎯 Save Course button clicked via event listener');
                    
                    // Call the save function directly
                    try {
                        saveCourseData();
                    } catch (error) {
                        console.error('❌ Error calling saveCourseData:', error);
                        alert('Error: ' + error.message);
                    }
                });
                
                console.log('✅ Direct event listener added to Save Course button');
            } else {
                console.error('❌ Save Course button not found at all!');
                // Create the button as a fallback
                const courseInputs = document.querySelector('.course-inputs');
                if (courseInputs) {
                    const newSaveBtn = document.createElement('button');
                    newSaveBtn.textContent = 'Save Course';
                    newSaveBtn.className = 'btn';
                    newSaveBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        saveCourseData();
                    });
                    courseInputs.appendChild(newSaveBtn);
                    console.log('✅ Created new Save Course button as fallback');
                }
            }
            
            // Test function accessibility
            if (typeof saveCourseData === 'function') {
                console.log('✅ saveCourseData function is accessible');
            } else {
                console.error('❌ saveCourseData function is not accessible!');
            }
        }
        
        // Setup global Enter key navigation (run once)
        function setupGlobalScorecardNavigation() {
            if (document.body.hasAttribute('data-scorecard-navigation-added')) return;
            
            document.addEventListener('keydown', function(event) {
                const target = event.target;
                
                // Check if we're in the scorecard tab and target is a scorecard input
                const scorecardTab = document.getElementById('scorecard-tab');
                if (scorecardTab && scorecardTab.classList.contains('active') &&
                    (target.classList.contains('gross-score-input') || target.classList.contains('editable-input')) &&
                    event.key === 'Enter') {
                    
                    console.log('🚀 Enter key detected on:', target.className, 'value:', target.value);
                    event.preventDefault();
                    
                    // Store the target before any potential DOM changes
                    const currentTarget = target;
                    
                    // Use setTimeout to ensure navigation happens after any onchange events
                    setTimeout(() => {
                        console.log('🔄 Processing navigation after change events...');
                        moveToNextInput(currentTarget);
                    }, 30); // Small delay to let change events complete
                }
            });
            
            document.body.setAttribute('data-scorecard-navigation-added', 'true');
            console.log('📋 Global scorecard Enter key navigation enabled');
        }
        
        // Update the switchTab function to handle scorecard
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
            originalSwitchTab(tabName);
            
            if (tabName === 'scorecard') {
                initScorecard();
            }
        };
    </script>
</body>
</html>
